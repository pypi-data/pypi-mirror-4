(function($){$.fn.djangocodemirror=function(method){if(methods[method]){return methods[method].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof method==="object"||!method){return methods.init.apply(this,arguments)}else{$.error("Method "+method+" does not exist on jQuery.djangocodemirror")}}};var methods={init:function(options){var settings=$.extend({indentUnit:4,tabSize:4,indentWithTabs:false,lineWrapping:false,lineNumbers:false,fullscreen:true,help_link:"",enable_active_line:true,display_cursor_position:true,undo_buttons:true,csrf:false,preview_url:false,quicksave_url:"",quicksave_datas:{},settings_cookie:"",settings_url:"",preview_padding:10,preview_borders:0},options);var default_button_settings={name:"",funcname:"common",method:"syntax",classname:"",key:false,"char":false,url:false,placeholder:"",begin_with:false,close_with:false,move_cursor_char:0,separator:false};return this.each(function(){if(settings.settings_cookie){var cookie=$.cookies.get("djangocodemirror_user_settings");if(cookie){settings=$.extend(settings,cookie)}}var input_source=$(this),djangocodemirror_key="djangocodemirror-id-"+(input_source.attr("id")||"default"),container=$('<div class="DjangoCodeMirror"></div>'),header=$('<div class="DjangoCodeMirror_menu"><ul></ul><div class="cale"></div></div>'),footer=$('<div class="DjangoCodeMirror_tabs"><ul></ul><div class="cale"></div></div>'),tab_preview_on=$('<li class="tab preview"><a>'+safegettext("Preview")+"</a></li>"),tab_preview_off=$('<li class="tab editor tabactive"><a>'+safegettext("Edit")+"</a></li>"),cursorpos_element='<div class="cursor_pos">'+safegettext("Line")+'&nbsp;:&nbsp;<span class="line">1</span> &nbsp;&nbsp; '+safegettext("Col")+'&nbsp;:&nbsp;<span class="ch">1</span></div>';$(this).before(container);header.appendTo(container);$(this).appendTo(container);if(settings.preview_url||settings.display_cursor_position){footer.appendTo(container);if(settings.preview_url){tab_preview_off.appendTo(".DjangoCodeMirror_tabs ul",container);tab_preview_on.appendTo(".DjangoCodeMirror_tabs ul",container)}if(settings.display_cursor_position){$(".DjangoCodeMirror_tabs .cale",container).before(cursorpos_element)}}settings.onCursorActivity=function(){events.cursor_activity(input_source)};var codemirror_instance=CodeMirror.fromTextArea(this,settings);codemirror_instance.setOption("extraKeys",{Tab:"indentMore","Shift-Tab":"indentLess","Ctrl-S":function(cm){cm.save();$(".buttonQuickSave").trigger("click")}});input_source.data("djangocodemirror",{key:djangocodemirror_key,container:container,codemirror:codemirror_instance,settings:settings});var buttons=coreutils.buttons_preprocessing(settings,DCM_Buttons_settings);$.each(buttons,function(item_index,item_value){if(item_value){var button_settings=$.extend({},default_button_settings,item_value);if(button_settings.separator){input_source.djangocodemirror("add_bar_separator",container)}else{input_source.djangocodemirror("add_bar_button",button_settings)}}});if(settings.preview_url){tab_preview_on.on("click",{input_source:input_source},events.show_preview);tab_preview_off.on("click",{input_source:input_source},events.hide_preview)}if(settings.enable_active_line){input_source.data("codemirror_hlLine",codemirror_instance.setLineClass(0,"activeline"))}codemirror_instance.refresh()})},add_bar_separator:function(direction){return this.each(function(){var input_source=$(this),instance_data=input_source.data("djangocodemirror");if(!direction||direction=="horizontal"){$('<li class="separator horizontal">-----</li>').appendTo(".DjangoCodeMirror_menu ul",instance_data.container)}else{$('<li class="separator vertical">-----</li>').appendTo(".DjangoCodeMirror_menu ul",instance_data.container)}})},add_bar_button:function(button_settings){return this.each(function(){var input_source=$(this),instance_data=input_source.data("djangocodemirror"),accesskey=(button_settings.key)?' accesskey="'+button_settings.key+'"':"",button=$('<li class="button '+button_settings.classname+'"><a'+accesskey+' title="'+safegettext(button_settings.name)+'">'+safegettext(button_settings.name)+"</a></li>");button.appendTo(".DjangoCodeMirror_menu ul",instance_data.container);if(button_settings.method=="internal"){button.on("click",{input_source:input_source,button_element:button,button_settings:button_settings},events[button_settings.funcname])}else{button.on("click",{input_source:input_source,button_element:button,button_settings:button_settings},events.button_click)}})}};var events={cursor_activity:function(input_source){var instance_data=input_source.data("djangocodemirror"),cur=instance_data.codemirror.getCursor();if(instance_data.settings.enable_active_line){var hlLine=input_source.data("codemirror_hlLine");instance_data.codemirror.setLineClass(hlLine,null)}$(".DjangoCodeMirror_tabs .cursor_pos span.line",instance_data.container).html((cur.line+1));$(".DjangoCodeMirror_tabs .cursor_pos span.ch",instance_data.container).html((cur.ch+1));var histo=instance_data.codemirror.historySize();if(histo.undo>0){$(".DjangoCodeMirror_menu .buttonUndo",instance_data.container).addClass("active").removeClass("inactive")}else{$(".DjangoCodeMirror_menu .buttonUndo",instance_data.container).addClass("inactive").removeClass("active")}if(histo.redo>0){$(".DjangoCodeMirror_menu .buttonRedo",instance_data.container).addClass("active").removeClass("inactive")}else{$(".DjangoCodeMirror_menu .buttonRedo",instance_data.container).addClass("inactive").removeClass("active")}if(instance_data.settings.enable_active_line){input_source.data("codemirror_hlLine",instance_data.codemirror.setLineClass(cur.line,"activeline"))}},button_click:function(event){var input_source=$(event.data.input_source),button_settings=event.data.button_settings,instance_data=input_source.data("djangocodemirror");if(button_settings.placeholder){button_settings.placeholder=safegettext(button_settings.placeholder)}var value=instance_data.codemirror.getSelection()||button_settings.placeholder;eval("DCM_Syntax_Methods."+button_settings.funcname)(value,instance_data.codemirror,button_settings);instance_data.codemirror.setCursor(instance_data.codemirror.getCursor());instance_data.codemirror.focus();return false},content_quicksave:function(event){var input_source=$(event.data.input_source),instance_data=input_source.data("djangocodemirror");if(jQuery.type(instance_data.settings.quicksave_datas)=="string"){try{instance_data.settings.quicksave_datas=eval(instance_data.settings.quicksave_datas)}catch(e){instance_data.settings.quicksave_datas={}}}$.ajax({type:"POST",dataType:"json",global:false,url:instance_data.settings.quicksave_url,data:$.extend({},instance_data.settings.quicksave_datas,{nocache:(new Date()).getTime(),content:instance_data.codemirror.getValue()}),beforeSend:function(xhr,settings){if(instance_data.settings.csrf){eval(instance_data.settings.csrf)(xhr,settings)}},success:function(data){$(".DjangoCodeMirror_menu .buttonQuickSave",instance_data.container).removeClass("ready");$(".DjangoCodeMirror_menu .buttonQuickSave",instance_data.container).removeClass("error");if(data.status=="form_invalid"){$(".DjangoCodeMirror_menu .buttonQuickSave",instance_data.container).addClass("error");createGrowl(instance_data.container,"warning",safegettext("Validation error"),data.errors["content"].join("<br/>"),false)}else{createGrowl(instance_data.container,"success",safegettext("Success"),safegettext("Successful save"),false)}},error:function(jqXHR,textStatus,errorThrown){$(".DjangoCodeMirror_menu .buttonQuickSave",instance_data.container).removeClass("ready");$(".DjangoCodeMirror_menu .buttonQuickSave",instance_data.container).addClass("error");createGrowl(instance_data.container,"warning",textStatus,errorThrown,false)}});return false},maximize_editor:function(event){var input_source=$(event.data.input_source),instance_data=input_source.data("djangocodemirror");$("body","html").css({height:"100%",width:"100%"});$("html").css("overflow","hidden");instance_data.container.addClass("fullScreen");var scene=$("<div>").attr("id","DjangoCodeMirror_fullscreen_scene");var old_place_scene=$("<div>").attr("id","DjangoCodeMirror_old_place");$(".CodeMirror-scroll",instance_data.container).data("original_size",$(".CodeMirror-scroll",instance_data.container).height());$(scene).keydown(function(e){if(e.keyCode=="27"){events.normalize_editor(event);return false}return true});instance_data.container.after(old_place_scene);instance_data.container.appendTo(scene);$("body").append(scene);var elems_css=coreutils.get_fullscreen_sizes(input_source);scene.css(elems_css[0]).attr("id","DjangoCodeMirror_fullscreen_scene");instance_data.container.css("width","100%");$(".CodeMirror-scroll",instance_data.container).css(elems_css[1]);events.hide_preview(event);instance_data.codemirror.refresh();$(window).bind("resize.djc_maximize",{input_source:input_source},events.resize_editor)},normalize_editor:function(event){var input_source=$(event.data.input_source),instance_data=input_source.data("djangocodemirror");if($("#DjangoCodeMirror_fullscreen_scene").length==0){return}instance_data.container.removeClass("fullScreen");$("#DjangoCodeMirror_old_place").before(instance_data.container);$("#DjangoCodeMirror_old_place").remove();$("body","html").css({height:"",width:""});$("html").css("overflow","auto");$("#DjangoCodeMirror_fullscreen_scene").remove();instance_data.container.css("width","");$(".CodeMirror-scroll",instance_data.container).css("height",$(".CodeMirror-scroll",instance_data.container).data("original_size")+"px");events.hide_preview(event);$(window).unbind("resize.djc_maximize");instance_data.codemirror.refresh()},resize_editor:function(event){var input_source=$(event.data.input_source),instance_data=input_source.data("djangocodemirror"),elems_css=coreutils.get_fullscreen_sizes(input_source);$("#DjangoCodeMirror_fullscreen_scene").css(elems_css[0]);$(".CodeMirror-scroll",instance_data.container).css(elems_css[1]);instance_data.codemirror.refresh()},do_undo:function(event){var input_source=$(event.data.input_source),button_element=event.data.button_element,instance_data=input_source.data("djangocodemirror");if(button_element.hasClass("active")){instance_data.codemirror.undo()}},do_redo:function(event){var input_source=$(event.data.input_source),button_element=event.data.button_element,instance_data=input_source.data("djangocodemirror");if(button_element.hasClass("active")){instance_data.codemirror.redo()}},show_preview:function(event){var input_source=$(event.data.input_source),instance_data=input_source.data("djangocodemirror");if(instance_data.container.data("DCM_preview_markid")){return}$(".DjangoCodeMirror_tabs li.preview a .error",instance_data.container).remove();$.ajax({type:"POST",dataType:"html",global:false,url:instance_data.settings.preview_url,data:{nocache:(new Date()).getTime(),content:instance_data.codemirror.getValue()},beforeSend:function(xhr,settings){if(instance_data.settings.csrf){eval(instance_data.settings.csrf)(xhr,settings)}},success:function(data){var elems_css=coreutils.get_preview_sizes(input_source);var preview_id="DCM_preview_id_"+$.now();instance_data.container.data("DCM_preview_markid",preview_id);var scene=$("<div>").css(elems_css[0]);scene.addClass("DjangoCodeMirrorPreviewScene");scene.attr("id",preview_id);$("body").append(scene);var content=$("<div>").css(elems_css[1]);content.addClass("PreviewContent");content.addClass("restructuredtext_container");scene.append(content);$(".DjangoCodeMirror_tabs li.editor",instance_data.container).removeClass("tabactive");$(".DjangoCodeMirror_tabs li.preview",instance_data.container).addClass("tabactive");content.append(data);$("a",content).click(function(){var url=$(this).attr("href");var is_anchor=(url&&url.indexOf("#")==0)?true:false;if(url&&!is_anchor){window.open(url)}return false});$(window).bind("resize.djc_preview",{input_source:input_source},events.resize_preview)},error:function(jqXHR,textStatus,errorThrown){$(".DjangoCodeMirror_tabs li.preview a",instance_data.container).append('<span class="error"> (!)</span>')}});return false},hide_preview:function(event){var input_source=$(event.data.input_source),instance_data=input_source.data("djangocodemirror");if(!instance_data.container.data("DCM_preview_markid")){return}$(".DjangoCodeMirror_tabs li.editor",instance_data.container).addClass("tabactive");$(".DjangoCodeMirror_tabs li.preview",instance_data.container).removeClass("tabactive");var preview_id=instance_data.container.data("DCM_preview_markid");$("#"+preview_id).remove();$(window).unbind("resize.djc_preview");instance_data.container.removeData("DCM_preview_markid");instance_data.codemirror.focus()},resize_preview:function(event){var input_source=$(event.data.input_source),instance_data=input_source.data("djangocodemirror"),preview_id=instance_data.container.data("DCM_preview_markid"),elems_css=coreutils.get_preview_sizes(input_source),editor_container=$(".CodeMirror-scroll",instance_data.container);$("#"+preview_id).css(elems_css[0]);$("#"+preview_id+" .PreviewContent").css(elems_css[1]);instance_data.codemirror.refresh()},show_settings:function(event){var input_source=$(event.data.input_source),instance_data=input_source.data("djangocodemirror");var border=instance_data.container.outerWidth(false)-instance_data.container.innerWidth();var panel=$("<div>").addClass("DjangoCodeMirror_settings_panel").css({position:"absolute","z-index":5000,width:(instance_data.container.outerWidth()-border)+"px",height:(instance_data.container.outerHeight()-border)+"px"});var close_link=$("<a/>").attr("href","#").addClass("close").html("Close");close_link.appendTo(panel);$("<h2>"+safegettext("Settings")+"</h2>").appendTo(panel);$.ajax({type:"GET",dataType:"html",global:false,cache:false,url:instance_data.settings.settings_url,success:function(data){instance_data.container.prepend(panel);$(".DjangoCodeMirror_menu .buttonSettings",instance_data.container).removeClass("error");panel.append(data);$("form",panel).css({overflow:"auto",height:(panel.innerHeight()-$("h2",panel).outerHeight())+"px"});close_link.click({panel:panel},function(e){$(window).unbind("resize.djc_settings");$(e.data.panel).remove();return false});$("form",panel).submit({input_source:input_source,panel:panel},events.submit_settings);$(window).bind("resize.djc_settings",{input_source:input_source,panel:panel},events.resize_settings)},error:function(jqXHR,textStatus,errorThrown){$(".DjangoCodeMirror_menu .buttonSettings",instance_data.container).addClass("error");createGrowl(instance_data.container,"warning",textStatus,errorThrown,false)}});return false},submit_settings:function(event){var input_source=$(event.data.input_source),instance_data=input_source.data("djangocodemirror");panel=$(event.data.panel);$.ajax({type:"POST",dataType:"json",global:false,cache:false,data:$("form",panel).serialize(),url:$("form",panel).attr("action"),success:function(data){$.each(data.setting_options,function(key,value){instance_data.codemirror.setOption(key,value)});$(window).unbind("resize.djc_settings");panel.remove();createGrowl(instance_data.container,"success",safegettext("Success"),safegettext("Successful save"),false)},error:function(jqXHR,textStatus,errorThrown){createGrowl(instance_data.container,"warning",textStatus,errorThrown,false)}});return false},resize_settings:function(event){var input_source=$(event.data.input_source),instance_data=input_source.data("djangocodemirror");panel=$(event.data.panel),borders=0;panel.css({width:(instance_data.container.outerWidth()-borders)+"px",height:(instance_data.container.outerHeight()-borders)+"px"});$("form",panel).css({height:(panel.innerHeight()-$("h2",panel).outerHeight())+"px"})}};var coreutils={buttons_preprocessing:function(settings,buttons){var button_indexes={};$.each(buttons,function(item_index,item_value){if(!item_value.separator){button_indexes[item_value.classname]=item_index}});if(button_indexes.buttonFullscreenEnter!=undefined&&button_indexes.buttonFullscreenEnter!=null){if(!settings.fullscreen){var pos_enter=button_indexes.buttonFullscreenEnter;var pos_exit=button_indexes.buttonFullscreenExit;delete buttons[pos_enter];delete buttons[pos_exit];if(buttons[pos_exit+1].separator){delete buttons[pos_exit+1]}}}if(button_indexes.buttonQuickSave!=undefined&&button_indexes.buttonQuickSave!=null){var pos=button_indexes.buttonQuickSave;if(settings.quicksave_url){buttons[pos].quicksave_url=settings.quicksave_url;buttons[pos].quicksave_datas=settings.quicksave_datas;buttons[pos].csrf=settings.csrf}else{delete buttons[pos];if(buttons[pos+1].separator){delete buttons[pos+1]}}}if(button_indexes.buttonUndo!=undefined&&button_indexes.buttonUndo!=null){var pos_undo=button_indexes.buttonUndo;var pos_redo=button_indexes.buttonRedo;if(!settings.undo_buttons){delete buttons[pos_undo];delete buttons[pos_redo];if(buttons[pos_redo+1].separator){delete buttons[pos_redo+1]}}}if(button_indexes.buttonHelp!=undefined&&button_indexes.buttonHelp!=null){var pos=button_indexes.buttonHelp;if(settings.help_link){buttons[pos].url=settings.help_link}else{delete buttons[pos]}}if(button_indexes.buttonSettings!=undefined&&button_indexes.buttonSettings!=null){var pos=button_indexes.buttonSettings;if(!settings.settings_url){delete buttons[pos]}}return buttons},get_preview_sizes:function(input_source){var instance_data=input_source.data("djangocodemirror"),editor_container=$(".CodeMirror-scroll",instance_data.container),editor_scrollbar=$(".CodeMirror-scrollbar",instance_data.container),menu_height=$(".DjangoCodeMirror_menu",instance_data.container).outerHeight(true),scrollbar_plus=(editor_scrollbar.css("display")=="block")?editor_scrollbar.outerWidth():0;var scene_css={position:"absolute","z-index":3000,left:editor_container.offset().left,top:editor_container.offset().top-menu_height,width:(editor_container.outerWidth()+scrollbar_plus)-(instance_data.settings.preview_padding*2)-(instance_data.settings.preview_borders*2),height:editor_container.outerHeight()-(instance_data.settings.preview_padding*2)+menu_height-(instance_data.settings.preview_borders*2),overflow:"auto",padding:instance_data.settings.preview_padding};var content_css={width:editor_container.width()-(instance_data.settings.preview_padding*4),height:editor_container.height()-(instance_data.settings.preview_padding*4),"border-size":1};return[scene_css,content_css]},get_fullscreen_sizes:function(input_source){var instance_data=input_source.data("djangocodemirror"),window_elem=$(window),computed_margins=instance_data.container.outerHeight(true)-$(".CodeMirror",instance_data.container).outerHeight(true);var scene_css={position:"absolute","z-index":2000,left:0,top:window_elem.scrollTop(),width:window_elem.width(),height:window_elem.height()};var content_css={height:(window_elem.height()-computed_margins)+"px"};return[scene_css,content_css]}}})(jQuery);