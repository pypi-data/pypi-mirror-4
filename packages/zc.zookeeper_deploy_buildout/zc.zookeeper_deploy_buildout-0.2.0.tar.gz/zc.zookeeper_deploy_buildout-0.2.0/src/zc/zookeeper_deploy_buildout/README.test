======================================
zookeeper-deploy buildout script tests
======================================

Installation
============

The script is a thin wrapper around buildout.

    >>> import zc.zookeeper_deploy_buildout, sys
    >>> sys.argv = ['/opt/foo/bin/zookeeper-deploy', '/foo/bar', '0']
    >>> zc.zookeeper_deploy_buildout.main('aaa', 'recipe')
    called: /opt/foo/bin/buildout -oUcCFG
    CFG:
    ------------------------------------------------------------
    [buildout]
    directory = /opt/foo
    installed = /etc/aaa/foo,bar.0.deployed
    parts = foo,bar.0
    [foo,bar.0]
    recipe = recipe
    ------------------------------------------------------------
    sys.exit(0)

Errors
=======

If there's an error, the script will exit with a non-zero exit status:

    >>> zc.zookeeper_deploy_buildout.main('aaa', 'BAD')
    called: /opt/foo/bin/buildout -oUcCFG
    CFG:
    ------------------------------------------------------------
    [buildout]
    directory = /opt/foo
    installed = /etc/aaa/foo,bar.0.deployed
    parts = foo,bar.0
    [foo,bar.0]
    recipe = BAD
    ------------------------------------------------------------
    sys.exit(41)

Extra arguments
===============

When the scriot is invoked, the first 2 arguments must be the
deployment path and number. Any arguments after that are passed to
buildout. As are any extra arguments passed to main:

    >>> sys.argv = ['/opt/foo/bin/zookeeper-deploy', '/foo/bar', '0', '-vD']
    >>> zc.zookeeper_deploy_buildout.main('AAA', 'recipe', 'em1', 'em2')
    called: /opt/foo/bin/buildout -oUcCFG em1 em2 -vD
    CFG:
    ------------------------------------------------------------
    [buildout]
    directory = /opt/foo
    installed = /etc/AAA/foo,bar.0.deployed
    parts = foo,bar.0
    [foo,bar.0]
    recipe = recipe
    ------------------------------------------------------------
    sys.exit(0)

Uninstall
=========

If the -u option is passed before the path and deployment number,
whatever was installed before is uninstalled by invoking buildout thus:

    >>> sys.argv = [
    ...     '/opt/foo/bin/zookeeper-deploy', '-u', '/foo/bar', '0', '-vD']
    >>> zc.zookeeper_deploy_buildout.main('AAA', 'recipe', 'em1', 'em2')
    called: /opt/foo/bin/buildout -oUcCFG em1 em2 -vD
    CFG:
    ------------------------------------------------------------
    [buildout]
    directory = /opt/foo
    installed = /etc/AAA/foo,bar.0.deployed
    parts =
    ------------------------------------------------------------
    sys.exit(0)

Blank app
=========

If the app argument is an empty string, the script will use the script
name to determine the application name:


    >>> sys.argv = ['/opt/foo/bin/zookeeper-deploy', '/foo/bar', '0', '-vD']
    >>> zc.zookeeper_deploy_buildout.main('', 'recipe', 'em1', 'em2')
    called: /opt/foo/bin/buildout -oUcCFG em1 em2 -vD
    CFG:
    ------------------------------------------------------------
    [buildout]
    directory = /opt/foo
    installed = /etc/foo/foo,bar.0.deployed
    parts = foo,bar.0
    [foo,bar.0]
    recipe = recipe
    ------------------------------------------------------------
    sys.exit(0)

Specifying a recipe
===================

You can use the -r option to specify a recipe entry-point name.  This
just adds :RECIPE_NAME to the recipe passed to the script:

    >>> sys.argv = ['/opt/foo/bin/zookeeper-deploy',
    ...             '-r', 'baz', '/foo/bar', '0', '-vD']
    >>> zc.zookeeper_deploy_buildout.main('', 'recipe', 'em1', 'em2')
    called: /opt/foo/bin/buildout -oUcCFG em1 em2 -vD
    CFG:
    ------------------------------------------------------------
    [buildout]
    directory = /opt/foo
    installed = /etc/foo/foo,bar.0.deployed
    parts = foo,bar.0
    [foo,bar.0]
    recipe = recipe:baz
    ------------------------------------------------------------
    sys.exit(0)

Note that it doesn't make sense to combine -r and -u and the result of
doing so is undefined (aka nonsense :).

If you're already specifying an entry point, you'll get an error:

    >>> sys.argv = ['/opt/foo/bin/zookeeper-deploy',
    ...             '-r', 'baz', '/foo/bar', '0', '-vD']
    >>> zc.zookeeper_deploy_buildout.main('', 'recipe:xxx', 'em1', 'em2')
    ... # doctest: +ELLIPSIS
    -r isn't allowed for this script
    sys.exit(1)
    ...

