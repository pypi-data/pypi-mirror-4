var Base=function(){};Base.extend=function(a,b){var c=Base.prototype.extend;Base._prototyping=!0;var d=new this;c.call(d,a),d.base=function(){},delete Base._prototyping;var e=d.constructor,f=d.constructor=function(){if(!Base._prototyping)if(this._constructing||this.constructor==f)this._constructing=!0,e.apply(this,arguments),delete this._constructing;else if(arguments[0]!=null)return(arguments[0].extend||c).call(arguments[0],d)};return f.ancestor=this,f.extend=this.extend,f.forEach=this.forEach,f.implement=this.implement,f.prototype=d,f.toString=this.toString,f.valueOf=function(a){return a=="object"?f:e.valueOf()},c.call(f,b),typeof f.init=="function"&&f.init(),f},Base.prototype={extend:function(a,b){if(arguments.length>1){var c=this[a];if(c&&typeof b=="function"&&(!c.valueOf||c.valueOf()!=b.valueOf())&&/\bbase\b/.test(b)){var d=b.valueOf();b=function(){var a=this.base||Base.prototype.base;this.base=c;var b=d.apply(this,arguments);return this.base=a,b},b.valueOf=function(a){return a=="object"?b:d},b.toString=Base.toString}this[a]=b}else if(a){var e=Base.prototype.extend;!Base._prototyping&&typeof this!="function"&&(e=this.extend||e);var f={toSource:null},g=["constructor","toString","valueOf"],h=Base._prototyping?0:1;while(i=g[h++])a[i]!=f[i]&&e.call(this,i,a[i]);for(var i in a)f[i]||e.call(this,i,a[i])}return this}},Base=Base.extend({constructor:function(){this.extend(arguments[0])}},{ancestor:Object,version:"1.1",forEach:function(a,b,c){for(var d in a)this.prototype[d]===undefined&&b.call(c,a[d],d,a)},implement:function(){for(var a=0;a<arguments.length;a++)typeof arguments[a]=="function"?arguments[a](this.prototype):this.prototype.extend(arguments[a]);return this},toString:function(){return String(this.valueOf())}}),define("cilantro/vendor/base",function(){}),define("cilantro/rest/basext",["cilantro/vendor/base"],function(){var a=Base.extend({__defargslist:function(a,b){return a=a||this.constructor,b=b||[],a.ancestor&&(b=this.__defargslist(a.ancestor,b)),a.defargs&&typeof a.defargs=="object"&&b.push(a.defargs),b},_defargs:function(){var a=this.__defargslist();return $.extend.apply(this,[{}].concat(a))},constructor:function(a){var b=this._defargs(),c=$.extend({},b,a);for(var d in c)b.hasOwnProperty(d)&&(this[d]=c[d])}},{defargs:{}});return a}),define("cilantro/rest/datasource",["cilantro/rest/basext"],function(a){var b=a.extend({}),c=b.extend({_cache:undefined,get:function(a,b){b=b||!1,a=a||{};if(!b&&this._cache)return this._cache;var c=this,d=$.extend({},this.ajax,a),e=d.success;return d.success=function(a){var b=c.decode(a);c._cache=b,e(a,b)},this.xhr=$.ajax(d),this._cache}},{defargs:{ajax:{url:window.location,data:{},success:function(){},error:function(){},cache:!1},decode:function(a){return a}}});return{ajax:c}}),define("cilantro/rest/renderer",["cilantro/rest/basext","jquery","underscore"],function(a,b,c){var d=a.extend({},{defargs:{target:null}}),e=d.extend({render:function(a,d){d=d?d:this.replace,d===!0&&this.target.html("");var e=[];if(this.bindData===!0)for(var f,g,h=0;h<a.length;h++)f=a[h],g=b(this.template(f)),g.data(f),e.push(g);else if(c.isArray(a)){var i=this;e=c.map(a,function(a){return c.isArray(a)?b(i.template({data:a})):b(i.template(a))})}else e=[b(this.template(a))];var j=this.target;return d==="prepend"?b.each(e.reverse(),function(){j.prepend(this)}):b.each(e,function(){j.append(this)}),this.target}},{defargs:{template:null,replace:!0,bindData:!1}});return{base:d,template:e}}),define("cilantro/pages/report/templates",["jquery","underscore"],function(a,b){return{columns:b.template('            <div data-model="category" data-id="<%= id %>">                <h4><%= name %> <a class="ht add-all" href="#<%= id %>">Add All</a></h4>                <ul>                    <% for (var e,k=0; k<columns.length; k++) { %>                        <% e = columns[k]; %>                        <li class="active" data-model="column" data-id="<%= e.id %>">                            <a class="fr ht add-column" href="#<%= e.id %>">Add</a>                            <%= e.name %>                            <% if (e.description) { %><p class="ht mg"><%= e.description %></p><% } %>                        </li>                    <% } %>                </ul>            </div>        '),active_columns:b.template('            <li data-model="column" data-id="<%= id %>">                <a class="fr ht remove-column" href="#<%= id %>">Remove</a>                <%= name %>                <% if (description) { %><p class="ht mg"><%= description %></p><% } %>            </li>        '),header:b.template('<th data-model="column" data-id="<%= id %>"            class="header <%= direction %>"><span><%= name %></span></th>'),row:b.template("            <tr>                <% for(var k=1; k < data.length; k++) { %>                    <td><%= data[k] %></td>                <% } %>            </tr>        "),pages:b.template('            <% if (page > 1) { %>                <span>&laquo; <a href="#1">First</a></span>                <% if (page > 2) { %>                    <span>&lsaquo; <a href="#<%= page-1 %>">Previous</a></span>                <% } %>            <% } %>            <% for (var e,k=0; k<pages.length;k++) { %>                <% e = pages[k]; %>                <% if (page == e) { %>                    <strong><%= e %></strong>                <% } else { %>                    <% if (e) { %>                        <a href="#<%= e %>"><%= e %></a>                    <% } else { %>                        <span>...</span>                    <% } %>                <% } %>            <% } %>            <% if (page < num_pages) { %>                <% if (page < num_pages - 1) { %>                    <span><a href="#<%= page+1 %>">Next</a> &rsaquo;</span>                <% } %>                <span><a href="#<%= num_pages %>">Last</a> &raquo;</span>            <% } %>        ')}}),define("cilantro/report/table",["jquery","cilantro/rest/datasource","cilantro/rest/renderer","cilantro/pages/report/templates"],function(a,b,c,d){function e(){var e=!0,f=a("body"),g=a("#content"),h=a("#report"),i=a("#report-info"),j=a("#actions"),k=a("#details"),l=h.find(".toolbar"),m=a("#table"),n=m.find("thead tr"),o=m.find("tbody"),p=a(".per-page"),q=a(".page-links"),r=a(".report-unique"),s=a(".report-unique-label"),t=a(".report-count"),u=a(".report-count-label"),v=a("#no-results"),w={table_header:new c.template({target:n,template:d.header}),table_rows:new c.template({target:o,template:d.row}),pages:new c.template({target:q,template:d.pages})},x={scope_info:new b.ajax({ajax:{url:App.endpoints.session.scope,success:function(b){if(b.conditions){var c="";a.each(b.conditions,function(b,d){a.each(d,function(a,b){c+="<li>"+b+"</li>"})}),k.html(c)}}}}),table_header:new b.ajax({ajax:{url:App.endpoints.session.perspective,success:function(a){w.table_header.render(a.header)}}}),table_rows:new b.ajax({ajax:{url:App.endpoints.session.report,data:{data:1},beforeSend:function(){h.block()},complete:function(){h.unblock()},success:function(a){a.unique_count!==null&&a.unique_count.toString()!==r.text()&&(r.parent().effect("highlight",1e3),r.text(a.unique_count),s.text(a.unique_count==1?a.model_name:a.model_name_plural)),a.count!==null&&a.count.toString()!==t.text()&&(t.parent().effect("highlight",1e3),t.text(a.count),u.text(a.count==1?"row":"rows"));if(a.count===0){m.hide(),l.hide(),v.show(),j.hide();return}v.hide(),m.show(),j.show(),l.show(),w.table_rows.render(a.rows),a.pages?(w.pages.render(a.pages),w.pages.target.show()):w.pages.target.hide(),a.per_page&&p.val(a.per_page),h.trigger("resize-report")}}})};x.scope_info.get(),x.table_header.get(),x.table_rows.get(),h.bind("resize-report",function(b){var c=900,d=h.innerWidth(),e=m.outerWidth(!0)+4,f=Math.min(e,a(window).width()-30);f=Math.max(c,f);if(f==d)return;g.animate({width:f}),h.animate({width:f})});var y;a(window).resize(function(){clearTimeout(y),y=setTimeout(function(){h.trigger("resize-report")},200)}),f.bind("update.report",function(a,b){b&&(b.data=1);var c={data:b};return x.table_rows.get(c,!0),!1}),f.bind("update.perspective",function(b,c){return c?(c={replace:c},a.patchJSON(App.endpoints.session.perspective,JSON.stringify(c),function(){f.trigger("update.report"),"columns"in c.replace&&x.table_header.get(null,!0)})):a.getJSON(App.endpoints.session.perspective,function(){f.trigger("update.report"),x.scope_info.get(null,!0),x.table_header.get(null,!0)}),!1}),h.delegate(".per-page","change",function(a){return this.value&&f.trigger("update.report",{size:this.value}),!1}),n.delegate(".header","click",function(b){var c,d=a(this),e=d.attr("data-id"),g=d.siblings();return g.removeClass("asc").removeClass("desc"),d.hasClass("asc")?(d.removeClass("asc").addClass("desc"),c="desc"):d.hasClass("desc")?(d.removeClass("desc"),c=""):(d.addClass("asc"),c="asc"),f.trigger("update.perspective",[{ordering:[[e,c]]}]),!1}),q.delegate("a","click",function(a){return f.trigger("update.report",{page:this.hash.substr(1)}),!1})}return{init:e}}),define("cilantro/report/columns",["jquery","cilantro/rest/datasource"],function(a,b){function c(){var c=a("body"),d=a("#columns"),e=a("#active-columns"),f=a("#columns-dialog"),g=a("#search"),h=a("form",f),i=a("#data-columns");f.cache={},f.get=function(a){if(!f.cache[a]){var b="[data-model=column][data-id="+a+"]";f.cache[a]={src:d.find(b),tgt:e.find(b)}}return f.cache[a]},f.bind("addall.column",function(b,c){var d=a("[data-model=category][data-id="+c+"]"),e=d.find(".active:not(.filtered)");d.hide();for(var g=0;g<e.length;g++)f.trigger("add.column",[a(e[g]).attr("data-id")]);return!1}),f.bind("add.column",function(a,b){map=f.get(b),map.src.removeClass("active");var c=map.src.siblings(".active:not(.filtered)");return c.length==0&&map.src.parents("[data-model=category]").hide(),e.append(map.tgt.detach().addClass("active")),!1}),f.bind("remove.column",function(a,b){return map=f.get(b),map.tgt.removeClass("active"),map.src.addClass("active").parents("[data-model=category]").show(),!1}),f.bind("removeall.column",function(a){for(var b in f.cache)f.trigger("remove.column",[b]);return!1}),f.bind("search.column",function(a,b){return g.trigger("search",b),!1}),f.bind("save.column",function(b){var d=e.children(".active"),f=a.map(d,function(b,c){return parseInt(a(b).attr("data-id"))});return c.trigger("update.perspective",[{columns:f}]),!1}),f.bind("filter.column",function(a,b){map=f.get(b),map.src.addClass("filtered");var c=map.src.siblings(".active:not(.filtered)");c.length==0&&map.src.parents("[data-model=category]").hide()}),f.bind("filterall.column",function(b){var c=d.find("[data-model=column]");for(var e=c.length;e--;)f.trigger("filter.column",[a(c[e]).attr("data-id")]);return!1}),f.bind("unfilter.column",function(a,b){return map=f.get(b),map.src.removeClass("filtered"),map.src.parents("[data-model=category]").show(),!1});var j={perspective:new b.ajax({ajax:{url:App.endpoints.session.perspective,success:function(a){if(a.store){f.trigger("removeall.column");var b=a.store.columns;for(var c=0;c<b.length;c++)f.trigger("add.column",[b[c]])}}}})};j.perspective.get(),App.hub.subscribe("report/revert",function(){j.perspective.get(null,!0),c.trigger("update.perspective")});var k=a('<div id="description"></div>').appendTo("body"),l=null;a("#columns").delegate("li","mouseenter",function(){clearTimeout(l);var b=this;l=setTimeout(function(){var c=a(b),d=c.offset(),e=c.outerWidth(),f=c.children(".description").html();k.html(f),k.css({left:d.left+e+20,top:d.top}).show()},700)}).delegate("li","mouseleave",function(){clearTimeout(l),k.hide()}),g.autocomplete2({success:function(a,b){g.trigger("filterall.column");for(var c=0;c<b.length;c++)g.trigger("unfilter.column",[b[c]])}},null,50),d.delegate(".add-column","click",function(a){clearTimeout(l),k.hide();var b=this.hash.substr(1);return f.trigger("add.column",[b]),!1}),d.delegate(".add-all","click",function(a){var b=this.hash.substr(1);return f.trigger("addall.column",[b]),!1}),e.delegate(".remove-column","click",function(a){var b=this.hash.substr(1);return f.trigger("remove.column",[b]),!1}),f.delegate(".remove-all","click",function(a){return f.trigger("removeall.column"),!1}),f.dialog({autoOpen:!1,draggable:!0,resizable:!1,title:"Add or Remove Columns from this Report",height:600,width:900,buttons:{Cancel:function(){f.dialog("close")},"Update Columns":function(){f.trigger("save.column"),f.dialog("close")}}}),e.sortable({placeholder:"placeholder",forcePlaceholderSize:!0,forceHelperSize:!0,opacity:.5,cursor:"move",tolerance:"intersect"}).disableSelection(),i.bind("click",function(a){f.dialog("open")})}return{init:c}}),define("cilantro/report/main",["jquery","cilantro/report/table","cilantro/report/columns"],function(a,b,c){a(function(){c.init(),b.init();var d=a("#export-data");d.bind("click",function(){return d.attr("disabled",!0),window.location=App.endpoints.session.report+"?f=csv",setTimeout(function(){d.attr("disabled",!1)},5e3),!1})})})