

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>2. Limiting access to secure requests &mdash; bpssl 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/theme_extras.js"></script>
    <link rel="top" title="bpssl 1.0 documentation" href="index.html" />
    <link rel="next" title="3. Settings" href="settings.html" />
    <link rel="prev" title="1. Installation" href="install.html" /> 
  </head>
  <body>
      <div class="header"><img class="rightlogo" src="_static/beproud.png" alt="Logo"/><h1 class="heading"><a href="index.html">
          <span>bpssl 1.0 documentation</span></a></h1>
        <h2 class="heading"><span>2. Limiting access to secure requests</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="install.html">1. Installation</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="settings.html">3. Settings</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="limiting-access-to-secure-requests">
<h1>2. Limiting access to secure requests<a class="headerlink" href="#limiting-access-to-secure-requests" title="Permalink to this headline">¶</a></h1>
<div class="section" id="limiting-access-via-urls">
<h2>2.1. Limiting Access via URLs<a class="headerlink" href="#limiting-access-via-urls" title="Permalink to this headline">¶</a></h2>
<p>One way to specify which requests should be treated as secure is to identify them
by url. This way setting entire sets of urls to be secure is easy and maintenance
is fairly painless.</p>
<p>For instance one might want to set all of a user&#8217;s account information to be
accessed via secure requests so you could set all urls under <tt class="docutils literal"><span class="pre">/accounts/</span></tt> to
be secure urls. The same might apply for making payments under <tt class="docutils literal"><span class="pre">/payment</span></tt> or
some other such scheme.</p>
<div class="section" id="using-the-sslredirectmiddleware">
<h3>2.1.1. Using the SSLRedirectMiddleware<a class="headerlink" href="#using-the-sslredirectmiddleware" title="Permalink to this headline">¶</a></h3>
<dl class="class">
<dt id="beproud.django.ssl.middleware.SSLRedirectMiddleware">
<em class="property">class </em><tt class="descclassname">beproud.django.ssl.middleware.</tt><tt class="descname">SSLRedirectMiddleware</tt><a class="headerlink" href="#beproud.django.ssl.middleware.SSLRedirectMiddleware" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Using the
<a class="reference internal" href="#beproud.django.ssl.middleware.SSLRedirectMiddleware" title="beproud.django.ssl.middleware.SSLRedirectMiddleware"><tt class="xref py py-class docutils literal"><span class="pre">SSLRedirectMiddleware</span></tt></a>
you can add secure request redirection over your whole site.</p>
<p><a class="reference internal" href="#beproud.django.ssl.middleware.SSLRedirectMiddleware" title="beproud.django.ssl.middleware.SSLRedirectMiddleware"><tt class="xref py py-class docutils literal"><span class="pre">SSLRedirectMiddleware</span></tt></a>
uses a setting called <a class="reference internal" href="settings.html#setting-ssl-urls"><em>SSL_URLS</em></a> to determine which urls will
be accessed via SSL (HTTPS). You set this setting the in your
<tt class="docutils literal"><span class="pre">settings.py</span></tt>.  <a class="reference internal" href="settings.html#setting-ssl-urls"><em>SSL_URLS</em></a> is a list of regular expressions
that are checked against the request url as it is found in <a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/request-response/#django.http.HttpRequest.path_info">request.path_info</a>.
If one of the regular expressions matches then the URL is treated as a secure url
and non-secure accesses are redirected to the secure url. For instance, using the
setup below if a request is recieved for the url <tt class="docutils literal"><span class="pre">http://www.example.com/login/</span></tt>,
the user will be redirected to <tt class="docutils literal"><span class="pre">https://www.example.com/login/</span></tt> because the url
matches a the <a class="reference internal" href="settings.html#setting-ssl-urls"><em>SSL_URLS</em></a> settings. The paths matched against
the regular expression are different from <tt class="docutils literal"><span class="pre">urls.py</span></tt> in that they start with a &#8216;/&#8217;
so keep that in mind.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">SSL_URLS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;^/login/&#39;</span><span class="p">,</span>
    <span class="s">&#39;^/purchase/&#39;</span>
    <span class="c"># ...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>In case there are some urls you want to be accessable via HTTP or HTTPS, you
can set those in the <a class="reference internal" href="settings.html#setting-ssl-ignore-urls"><em>SSL_IGNORE_URLS</em></a> setting. For
instance, static files served by your application or i18n javascript would typically
be accessable via both HTTP and HTTPS. <a class="reference internal" href="settings.html#setting-ssl-ignore-urls"><em>SSL_IGNORE_URLS</em></a>
is defined exactly like <a class="reference internal" href="settings.html#setting-ssl-urls"><em>SSL_URLS</em></a>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">SSL_IGNORE_URLS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;^/i18n_js$&#39;</span><span class="p">,</span>
    <span class="s">&#39;^/static/&#39;</span><span class="p">,</span>
    <span class="c"># ...</span>
<span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#beproud.django.ssl.middleware.SSLRedirectMiddleware" title="beproud.django.ssl.middleware.SSLRedirectMiddleware"><tt class="xref py py-class docutils literal"><span class="pre">SSLRedirectMiddleware</span></tt></a> does the following:</p>
<ul class="simple">
<li>If the request url matches a url in <a class="reference internal" href="settings.html#setting-ssl-ignore-urls"><em>SSL_IGNORE_URLS</em></a> then do nothing.</li>
<li>If the request url matches a url in <a class="reference internal" href="settings.html#setting-ssl-urls"><em>SSL_URLS</em></a> and the request is not-secure then the user is redirected to the secure version of the page.</li>
<li>If the request url does not match a url in <a class="reference internal" href="settings.html#setting-ssl-urls"><em>SSL_URLS</em></a> and the request is secure then the user is redirected to the non-secure version of the page.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Secure requests to non-secure pages are redirected to the non-secure url because
pages that can be accessed via multiple urls can confuse search engines and is
not particularly <a class="reference external" href="http://en.wikipedia.org/wiki/Representational_State_Transfer">RESTful</a>.</p>
</div>
</div>
</div>
<div class="section" id="limiting-access-to-views">
<h2>2.2. Limiting Access to Views<a class="headerlink" href="#limiting-access-to-views" title="Permalink to this headline">¶</a></h2>
<p>One might also want to limit access to particular views because they encapsulate
some kind of functionality that should be accessed in a secure way. Multiple
urls could be accessing this view so it may not make sense to maintain the
security settings as URLs.</p>
<div class="section" id="the-raw-way">
<h3>2.2.1. The RAW Way<a class="headerlink" href="#the-raw-way" title="Permalink to this headline">¶</a></h3>
<p>Because some urls may change or multiple urls could be handled by the same view,
you may want to limit access to secure requests at the view level. The simple raw
way to limit access to pages to secure requests is to check <a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/request-response/#django.http.HttpRequest.is_secure">request.is_secure()</a>
to see if the request is secure:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">get_host</span>

<span class="k">def</span> <span class="nf">my_secure_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">is_secure</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s">&quot;https://</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">get_host</span><span class="p">(</span><span class="n">request</span><span class="p">),</span> <span class="n">request</span><span class="o">.</span><span class="n">get_full_path</span><span class="p">()))</span>
    <span class="c"># ...</span>
</pre></div>
</div>
<p>However, by limiting access this way the <a class="reference internal" href="#beproud.django.ssl.middleware.SSLRedirectMiddleware" title="beproud.django.ssl.middleware.SSLRedirectMiddleware"><tt class="xref py py-class docutils literal"><span class="pre">SSLRedirectMiddleware</span></tt></a> has no way of
knowing that the page is secure and thus may conflict with your view unless you
add the URL to <a class="reference internal" href="settings.html#setting-ssl-ignore-urls"><em>SSL_IGNORE_URLS</em></a>.</p>
</div>
<div class="section" id="the-ssl-view-decorator">
<h3>2.2.2. The ssl_view decorator<a class="headerlink" href="#the-ssl-view-decorator" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="beproud.django.ssl.decorators.ssl_view">
<tt class="descclassname">beproud.django.ssl.decorators.</tt><tt class="descname">ssl_view</tt><big>(</big><big>)</big><a class="headerlink" href="#beproud.django.ssl.decorators.ssl_view" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>As a shortcut the <tt class="docutils literal"><span class="pre">ssl_view()</span></tt> decorator is provided to indicate that your view
should be restricted to secure requests. Example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">beproud.django.ssl.decorators</span> <span class="kn">import</span> <span class="n">ssl_view</span>

<span class="nd">@ssl_view</span>
<span class="k">def</span> <span class="nf">my_secure_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">ssl_view()</span></tt> implements the same functionality as the
<a class="reference internal" href="#beproud.django.ssl.middleware.SSLRedirectMiddleware" title="beproud.django.ssl.middleware.SSLRedirectMiddleware"><tt class="xref py py-class docutils literal"><span class="pre">SSLRedirectMiddleware</span></tt></a>
but works without having to set the URL in <a class="reference internal" href="settings.html#setting-ssl-urls"><em>SSL_URLS</em></a>.
<a class="reference internal" href="#beproud.django.ssl.middleware.SSLRedirectMiddleware" title="beproud.django.ssl.middleware.SSLRedirectMiddleware"><tt class="xref py py-class docutils literal"><span class="pre">SSLRedirectMiddleware</span></tt></a>
will also recognize views using the <tt class="docutils literal"><span class="pre">ssl_view()</span></tt> decorator and won&#8217;t conflict with
your view.</p>
</div>
</div>
<div class="section" id="using-an-http-reverse-proxy">
<h2>2.3. Using an HTTP Reverse Proxy<a class="headerlink" href="#using-an-http-reverse-proxy" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="beproud.django.ssl.middleware.SSLProxyMiddleware">
<em class="property">class </em><tt class="descclassname">beproud.django.ssl.middleware.</tt><tt class="descname">SSLProxyMiddleware</tt><a class="headerlink" href="#beproud.django.ssl.middleware.SSLProxyMiddleware" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><a class="reference internal" href="#beproud.django.ssl.middleware.SSLProxyMiddleware" title="beproud.django.ssl.middleware.SSLProxyMiddleware"><tt class="xref py py-class docutils literal"><span class="pre">SSLProxyMiddleware</span></tt></a>
will update the request object to make sure that
<a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/request-response/#django.http.HttpRequest.is_secure">request.is_secure()</a> returns true when processing a secure request from a properly
set up HTTP reverse proxy server. See
<a class="reference internal" href="install.html#install-web-server-setup"><em>Web Server Setup</em></a> for more info on how to set up
reverse proxy web servers to work with
<a class="reference internal" href="#beproud.django.ssl.middleware.SSLProxyMiddleware" title="beproud.django.ssl.middleware.SSLProxyMiddleware"><tt class="xref py py-class docutils literal"><span class="pre">SSLProxyMiddleware</span></tt></a>.</p>
<p>You will need to set the <a class="reference internal" href="settings.html#setting-ssl-request-header"><em>SSL_REQUEST_HEADER</em></a>
setting to the name and value of the header you use to pass whether a request
is secure or not. The default value of this setting is shown below:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">SSL_REQUEST_HEADER</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;HTTP_X_FORWARDED_PROTOCOL&#39;</span><span class="p">,</span> <span class="s">&#39;https&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#beproud.django.ssl.middleware.SSLProxyMiddleware" title="beproud.django.ssl.middleware.SSLProxyMiddleware"><tt class="xref py py-class docutils literal"><span class="pre">SSLProxyMiddleware</span></tt></a> does the following:</p>
<ul class="simple">
<li>If the name and value of the HTTP header defined by <a class="reference internal" href="settings.html#setting-ssl-request-header"><em>SSL_REQUEST_HEADER</em></a> equals the value
of the header sent with the request then set <a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/request-response/#django.http.HttpRequest.is_secure">request.is_secure()</a> to return True.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><a class="reference internal" href="#beproud.django.ssl.middleware.SSLProxyMiddleware" title="beproud.django.ssl.middleware.SSLProxyMiddleware"><tt class="xref py py-class docutils literal"><span class="pre">SSLProxyMiddleware</span></tt></a> should be set as early as possible in your <a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/settings/#middleware-classes">MIDDLEWARE_CLASSES</a> setting so that
any middleware which looks at <a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/request-response/#django.http.HttpRequest.is_secure">request.is_secure()</a> will get the right value. At the very least it should be before your
<a class="reference internal" href="#beproud.django.ssl.middleware.SSLRedirectMiddleware" title="beproud.django.ssl.middleware.SSLRedirectMiddleware"><tt class="xref py py-class docutils literal"><span class="pre">SSLRedirectMiddleware</span></tt></a>.</p>
</div>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="install.html">1. Installation</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="settings.html">3. Settings</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2010, BeProud Inc..
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>