var NEWOBJECTKEY="newObject",FIELD=null,delay=null;window.TEMPLATES={};window.REGISTER={};_.templateSettings={interpolate:/\{\{(.+?)\}\}/g,evaluate:/\{\%(.+?)\%\}/g,};_.mixin(_.str.exports());function isEmpty(b){for(var a in b){return false}return true}delay=(function(){if(DEBUG){console.log("function:delay")}var a=0;return function(c,b){clearTimeout(a);a=setTimeout(c,b)}})();function generatorID(d,g){if(DEBUG){console.log("function:generatorID")}var b=[],e="i",a=1000,f=9999,c=Math.floor(Math.random()*(f-a+1))+a;e+=$.now()+String(c);if(d){b.push(d)}b.push(e);if(g){b.push(g)}return validatorID(b)}function validatorID(a){if($.type(a)==="array"){a=a.join("_")}if(DEBUG){console.log("function:validatorID")}return a.replace(/[\.,\:,\/, ,\(,\),=,?]/g,"-")}function handlerHideAlert(){if(DEBUG){console.log("function:handlerHideAlert")}$(".alert").alert("close")}function handlerShowAlert(b,a,c){if(DEBUG){console.log("function:handlerShowAlert")}console.log(b);if(!a){a="alert-error"}html=TEMPLATES.alert({msg:b,type:a});$("#alert-place").html(html);$(window).scrollTop(0);$(".alert").alert();if(c){delay(c,5000)}else{delay(handlerHideAlert,5000)}return false}function jsonAPI(a,e,c,b){if(DEBUG){console.log("function:jsonAPI")}if(!a){a={method:"get_settings"}}if(!e){e=function(g,f,h){}}var d=$.ajax({type:"POST",async:!b,timeout:AJAX_TIMEOUT,url:BWP_API_URL,data:"jsonData="+$.toJSON(a),dataType:"json"}).fail(function(h,f,g){if(h.getResponseHeader("Location")){window.location=h.getResponseHeader("Location").replace(/\?.*$/,"?next="+window.location.pathname);console.log("1:"+h.getResponseHeader("Location"))}else{console.log("ERROR:"+h.responseText);handlerShowAlert(_(h.responseText).truncate(255),"alert-error")}}).done(function(g,f,h){if(c){if(DEBUG){console.log(c)}}if((g.status>=300)&&(g.status<400)&&(g.data.Location)){handlerShowAlert(g.message,"alert-error",function(){window.location.href=g.data.Location.replace(/\?.*$/,"?next="+window.location.pathname)})}else{if(g.status>=400){handlerShowAlert(g.message,"alert-error")}else{if(DEBUG){console.log($.toJSON(g.message))}return e(g,f,h)}}});return d}function classSettings(a){if(DEBUG){console.log("function:Settings")}self=this;if(typeof localStorage=="undefined"||typeof $.evalJSON=="undefined"){return{}}_unique_key=SETTINGS_UNIQUE_KEY;_server={};_local={tabs:[],};_values={server:_server,local:_local};_values_is_set=false;_responseServer=null;this.__defineGetter__("ready",function(){return _values_is_set});_callback=a;_run_callback=function(){if(_callback){_callback();if(!_callback.__not_reset_after__){_callback=a}}};this.callback=_callback;_last_set_server=null;this.last_set=_last_set_server;_last_get_server=null;this.last_get=_last_get_server;_init=function(b){if(b){_callback=b}_values_is_set=false;_local=$.evalJSON(localStorage.getItem(_unique_key))||_local;_get_server();return self};this.init=_init;this.reload=_init;_check_init=function(){if(!_values_is_set){_init()}return self};this.__defineGetter__("all",function(){_check_init();return _values});this.__defineGetter__("server",function(){_check_init();return _server});this.__defineGetter__("local",function(){_check_init();return _local});this.save=function(c,b){if(c){_callback=c}if(b!="local"){_set_server()}if(b!="server"){localStorage.setItem(_unique_key,$.toJSON(self.local))}_run_callback();return self};this.save_server=function(b){return self.save(b,"server")};this.save_local=function(b){return self.save(b,"local")};_set_server=function(){sync=false;_responseServer=null;args={method:"set_settings",settings:self.server};cb=function(c,b,d){if(!c.data){handlerShowAlert(c.message)}else{_last_set_server=new Date();_responseServer=c}};jqxhr=new jsonAPI(args,cb,"SETTINGS.set_server() call jsonAPI()",sync);return[_last_set_server,_responseServer,jqxhr]};_get_server=function(){sync=true;_responseServer=null;args={method:"get_settings"};cb=function(c,b,d){_server=c.data;_last_get_server=new Date();_responseServer=c;_values_is_set=true;_run_callback()};jqxhr=new jsonAPI(args,cb,"SETTINGS.get_server() call jsonAPI()",sync);return[_last_get_server,_responseServer,jqxhr]};this.cleanTabs=function(){_tabs=[];$.each(_local.tabs,function(b,c){if(c){_tabs.push(c)}});_local.tabs=_tabs;return self}}function classApp(a){this.has_module_perms=a.has_module_perms;this.name=a.name;this.id=validatorID(this.name);this.label=a.label;this.title="Приложение:"+this.label;_models=[];this.models=_models;app=this;$.each(a.models,function(b,c){_models.push(new classModel(app,c))});REGISTER[this.id]=this}function classModel(b,a){this.template=TEMPLATES.layoutModel;this.app=b;this.perms=a.perms;this.meta=a.meta;this.name=a.name;this.model=this.name;this.id=validatorID(this.model);this.label=a.label;this.title=this.app.label+": "+this.label;this.query=null;this.fix={};this.paginator=null;_composes={};this.composes=_composes;_widgets=[];this.widgets=_widgets;_actions={};this.actions=_actions;model=this;if(a.meta.compositions){$.each(a.meta.compositions,function(c,d){_composes[d.meta.related_name]=d})}$.each(model.meta.list_display,function(d,c){if(c=="__unicode__"){_widgets.push({name:c,label:model.label,attr:{}})}else{$.each(model.meta.widgets,function(e,f){if(c==f.name){_widgets.push(f)}})}});REGISTER[this.id]=this}function classSelector(a){$.extend(true,this,a);this.id=validatorID([this.id,"selector"]);this.template=TEMPLATES.layoutSelector;this.perms["delete"]=false;this.perms.add=false;this.perms.change=false;this.meta.list_per_page=5;REGISTER[this.id]=this}function classCompose(a,b){this.template=TEMPLATES.layoutCompose;this.object=a;this.editable=Boolean(this.object.pk);this.perms=b.perms;this.name=b.name;this.meta=b.meta;this.compose=this.meta.related_name;this.model=this.meta.related_model;this.is_m2m=this.meta.is_many_to_many;this.id=validatorID([this.object.id,this.name]);this.label=b.label;this.title=this.object.label+": "+this.label;this.query=null;this.fix={};this.paginator=null;_widgets=[];this.widgets=_widgets;_actions={};this.actions=_actions;compose=this;$.each(compose.meta.list_display,function(d,c){if(c=="__unicode__"){_widgets.push({name:c,label:compose.label,attr:{}})}else{$.each(compose.meta.widgets,function(e,f){if(c==f.name){_widgets.push(f)}})}});REGISTER[this.id]=this}function classObject(a){this.template=TEMPLATES.layoutObject;this.model=REGISTER[validatorID(a.model)];this.pk=a.pk;this.id=this.pk?validatorID(a.model+"."+this.pk):generatorID(NEWOBJECTKEY);this.__unicode__=this.pk?a.__unicode__:"Новый объект ("+this.model.label+")";this.label=this.__unicode__;this.title=this.model.label+": "+this.label;_fields=a.fields;this.fields=_fields;_composes=[];this.composes=_composes;this.widgets=this.model.meta.widgets;this.actions=this.model.actions;this.fix={};this.fixaction=null;object=this;if(this.model.composes){$.each(this.model.composes,function(b,c){_composes.push(new classCompose(object,c))})}REGISTER[this.id]=this}function handlerCollectionRender(a,b){if(DEBUG){console.log("function:handlerCollectionRender")}if(a instanceof classObject){return""}html=TEMPLATES.collection({data:a});if(!b){$("#collection_"+a.id).html(html)}return html}function handlerLayoutRender(a,b){if(DEBUG){console.log("function:handlerLayoutRender")}html=a.template({data:a});if(!b){$("#layout_"+a.id).html(html);if(a instanceof classObject){$("#layout_"+a.id+" button[data-loading=true]").one("click",eventLayoutLoad)}}return html}function handlerCommitInstance(b,a){if(DEBUG){console.log("function:handlerCommitInstance")}is_changed=false;_objects=[];_model=instance.model;appendObject=function(c){if((!isEmpty(c.fix))||(c.fixaction=="delete")){$.extend(true,c.fields,c.fix);_objects.push({pk:c.pk,fields:c.fields,model:c.model.name,action:c.fixaction,fix:c.fix,})}};if((instance instanceof classModel)||(instance instanceof classCompose)){_model=instance;$.each(instance.fix,function(c,d){appendObject(d)})}else{appendObject(instance)}args={method:"commit",objects:_objects,};cb=function(d,c,e){handlerCollectionGet(_model);if(a){a()}};jqxhr=new jsonAPI(args,cb,"handlerCommitInstance(instanse) call jsonAPI()");return jqxhr}function handlerObjectAdd(a){if(DEBUG){console.log("function:handlerObjectAdd")}args={method:"get_object",model:a.name,pk:null,};cb=function(c,b,d){object=new classObject(c.data);object.fixaction="add";object.model.fix[object.id]=object;handlerTabOpen(object)};jqxhr=new jsonAPI(args,cb,"handlerObjectAdd(model) call jsonAPI()");return jqxhr}function handlerObjectChange(b,c){if(DEBUG){console.log("function:handlerObjectChange")}var a=c.attr("name"),d=c.val();if($.type(b.fields[a])==="array"){d=[d,c.text()]}else{if($.type(b.fields[a])==="boolean"){d=c.is(":checked")}}b.fix[a]=d;b.fixaction=b.fixaction||"change";b.model.fix[b.id]=b}function handlerObjectCopy(a,b){if(DEBUG){console.log("function:handlerObjectCopy")}args={method:"get_object",model:a.model,pk:a.pk,copy:true,clone:b,};cb=function(d,c,e){object=new classObject(d.data);object.fixaction="add";object.model.fix[object.id]=object;handlerTabOpen(object)};jqxhr=new jsonAPI(args,cb,"handlerObjectCopy(data, clone) call jsonAPI()")}function handlerObjectDelete(b,a){if(DEBUG){console.log("function:handlerObjectDelete")}args={method:"commit",objects:[{pk:b.pk,fields:{},model:b.model,action:"delete"}],};cb=function(d,c,e){handlerCollectionGet(REGISTER[validatorID(b.model)]);if(a){a()}};jqxhr=new jsonAPI(args,cb,"handlerObjectDelete(data, done) call jsonAPI()")}function eventObjectOpen(){if(DEBUG){console.log("function:eventObjectOpen")}$this=$(this);data=$this.data();if(!data.model){return false}object=REGISTER[data.id];if(object){handlerTabOpen(object);return null}args={method:"get_object",model:data.model,pk:data.pk||null,};cb=function(b,a,c){object=new classObject(b.data);$this.data("id",object.id);handlerTabOpen(object)};jqxhr=new jsonAPI(args,cb,"eventObjectOpen() call jsonAPI()");return jqxhr}function eventObjectAdd(a){if(DEBUG){console.log("function:eventObjectAdd")}$this=$(this);data=$this.data();model=REGISTER[data.id];if(model instanceof classCompose){console.log(model.is_m2m);model=REGISTER[validatorID(model.name)]}if((a)&&(a.data)&&(a.data.m2m)){console.log(a);return true}handlerObjectAdd(model,$this);return true}function eventObjectCopy(){if(DEBUG){console.log("function:eventObjectCopy")}$this=$(this);data=$this.data();handlerObjectCopy(data);return true}function eventObjectClone(){if(DEBUG){console.log("function:eventObjectClone")}$this=$(this);data=$this.data();handlerObjectCopy(data,true);return true}function eventObjectDelete(a){if(DEBUG){console.log("function:eventObjectDelete")}$this=$(this);data=$this.data();if((a)&&(a.data)&&(a.data.m2m)){console.log(a);return true}object=REGISTER[data.id];if(object){data.model=object.model.name;data.pk=object.pk}handlerObjectDelete(data,function(){handlerTabClose(object)});return true}function eventObjectChange(){if(DEBUG){console.log("function:eventObjectChange")}$this=$(this);data=$this.data();object=REGISTER[data.id];handlerObjectChange(object,$this);return true}function eventObjectReset(){if(DEBUG){console.log("function:eventObjectReset")}$this=$(this);data=$this.data();object=REGISTER[data.id];object.fix={};handlerLayoutRender(object);return true}function eventObjectSave(){if(DEBUG){console.log("function:eventObjectSave")}$this=$(this);data=$this.data();object=REGISTER[data.id];handlerCommitInstance(object,function(){handlerTabClose(object)});return true}function handlerObjectRowMuted(a){if(DEBUG){console.log("function:handlerObjectRowMuted")}$('tr[data-model="'+a.model.name+'"][data-pk="'+a.pk+'"]').addClass("muted")}function handlerObjectRowUnmuted(a){if(DEBUG){console.log("function:handlerObjectRowUnmuted")}$('tr[data-model="'+a.model.name+'"][data-pk="'+a.pk+'"]').removeClass("muted")}function handlerCollectionGet(a){if(DEBUG){console.log("function:handlerCollectionGet")}args={method:"get_collection",model:a.model,compose:a.compose||null,order_by:a.meta.ordering||null,};args[a.meta.search_key]=a.query||null;if(a.object){args.pk=a.object.pk||0}if(a.paginator){args.page=a.paginator.page||1;args.per_page=a.paginator.per_page||null}cb=function(c,b,d){a.paginator=c.data;html=handlerCollectionRender(a)};jqxhr=new jsonAPI(args,cb,"handlerCollectionGet() call jsonAPI()");return jqxhr}function eventCollectionFilter(){if(DEBUG){console.log("function:eventCollectionFilter")}search=this;data=$(search).data();instance=REGISTER[data.id];instance.query=$(search).val()||null;jqxhr=handlerCollectionGet(instance);return jqxhr}function eventCollectionCount(){if(DEBUG){console.log("function:eventCollectionCount")}data=$(this).data();instance=REGISTER[data.id];if(instance.paginator){instance.paginator.page=1;instance.paginator.per_page=$(this).val()||$(this).data()["count"]||instance.meta.list_per_page;$("[data-placeholder=collection_count][data-id="+instance.id+"]").text(instance.paginator.per_page)}jqxhr=handlerCollectionGet(instance);return jqxhr}function eventCollectionPage(){if(DEBUG){console.log("function:eventCollectionPage")}data=$(this).data();instance=REGISTER[data.id];if(instance.paginator){instance.paginator.page=$(this).val()||$(this).data()["page"]||1}jqxhr=handlerCollectionGet(instance);return jqxhr}function eventFieldClear(){if(DEBUG){console.log("function:eventFieldClear")}$this=$(this);$this.attr("disabled","disabled");$this.siblings("button[name]").val(null).html("&nbsp;").change();return true}function handlerModalShow(d,b,c,a){if(DEBUG){console.log("function:handlerModalShow")}$modal=$("#modal");modal={};modal.mhead=d;modal.mbody=b;modal.mfoot=c;html=TEMPLATES.modal({modal:modal});$modal.html(html).modal("show");if(a){a()}}function handlerFieldSelect(a){if(DEBUG){console.log("function:handlerFieldSelect")}FIELD=a;data=a.data();object=REGISTER[data.id];model=REGISTER[validatorID(data.model)];selector=new classSelector(model);mhead="Выберите требуемый объект";mbody=handlerLayoutRender(selector,true);mfoot=null;handlerModalShow(mhead,mbody,mfoot,function(){handlerCollectionGet(selector)})}function eventObjectSelect(){if(DEBUG){console.log("function:eventObjectSelect")}$this=$(this);data=$this.data();FIELD.val(data.pk).text(data.unicode).change().siblings("button[disabled]").removeAttr("disabled");$("#modal").modal("hide");return true}function eventFieldSelect(){if(DEBUG){console.log("function:eventFieldSelect")}$this=$(this);$field=$this.siblings("button[name]");handlerFieldSelect($field);return true}function eventRowClick(){if(DEBUG){console.log("function:eventRowClick")}$this=$(this);$this.addClass("info").siblings("tr").removeClass("info");return true}function handlerMenuAppLoad(){if(DEBUG){console.log("function:handlerMenuAppLoad")}sync=true;args={method:"get_apps"};cb=function(b,a,c){apps=[];$.each(b.data,function(d,e){apps.push(new classApp(e))});html=TEMPLATES.menuApp({data:apps});$("#menu-app ul[role=menu]").html(html);$("#menu-app").show()};jqxhr=new jsonAPI(args,cb,"handlerMenuAppLoad() call jsonAPI()",sync);return jqxhr}function handlerTabOpen(a){if(DEBUG){console.log("function:handlerTabOpen")}handlerObjectRowMuted(a);tab=$("#main-tab #tab_"+a.id);if(tab.length>0){tab.find("a").tab("show")}else{html=TEMPLATES.layoutDefault({data:a});$("#main-tab-content").append(html);html=TEMPLATES.tab({data:a});$("#main-tab").append(html);delay(function(){$("#main-tab a:last").tab("show").click()},1);if((a.id.indexOf(NEWOBJECTKEY)==-1)&&($.inArray(a.id,SETTINGS.local.tabs)<0)&&($("#menu-app li[class!=disabled] a[data-id="+a.id+"]").size()>0)){SETTINGS.local.tabs.push(a.id);SETTINGS.save_local()}$("#tab_"+a.id+" a").one("click",eventLayoutLoad)}return true}function eventTabOpen(){if(DEBUG){console.log("function:eventTabOpen")}data=$(this).data();data=REGISTER[data.id]||data;handlerTabOpen(data);return true}function handlerTabClose(a){if(DEBUG){console.log("function:handlerTabClose")}$("#tab_"+a.id).remove();$("#layout_"+a.id).remove();instance=REGISTER[a.id];if(instance){handlerObjectRowUnmuted(instance);if(instance instanceof classObject){$.each(instance.composes,function(b,c){delete REGISTER[c.id]});delete REGISTER[a.id]}}num=$.inArray(a.id,SETTINGS.local.tabs);if(num>-1){delete SETTINGS.local.tabs[num];SETTINGS.cleanTabs().save_local()}}function eventTabClose(){if(DEBUG){console.log("function:eventTabClose")}data=$(this).data();data=REGISTER[data.id]||data;handlerTabClose(data);return true}function handlerLayoutLoad(a){if(DEBUG){console.log("function:handlerLayoutLoad")}html=handlerLayoutRender(a);if((a instanceof classModel)||(a instanceof classCompose)){jqxhr=handlerCollectionGet(a)}}function eventLayoutLoad(){if(DEBUG){console.log("function:eventLayoutLoad")}data=$(this).data();instance=REGISTER[data.id];handlerLayoutLoad(instance);$(this).removeAttr("data-loading");return true}function restoreSession(){if(DEBUG){console.log("function:restoreSession")}$.each(SETTINGS.local.tabs,function(a,b){$("#menu-app li[class!=disabled] a[data-id="+b+"]").click()})}function toggleCheckboxes(){$table=$(this).parents("table");$inputs=$table.find("tbody td:nth-child(1) input[type=checkbox]");checked=this.checked;$.each($inputs,function(a,b){b.checked=checked})}$(document).ready(function(a){if(DEBUG){console.log("function:$(document).ready")}TEMPLATES.alert=_.template(a("#underscore-alert").html());TEMPLATES.menuApp=_.template(a("#underscore-menu-app").html());TEMPLATES.collection=_.template(a("#underscore-collection").html());TEMPLATES.layoutModel=_.template(a("#underscore-layout-model").html());TEMPLATES.layoutSelector=_.template(a("#underscore-layout-selector").html());TEMPLATES.layoutCompose=_.template(a("#underscore-layout-compose").html());TEMPLATES.layoutObject=_.template(a("#underscore-layout-object").html());TEMPLATES.layoutDefault=_.template(a("#underscore-layout-default").html());TEMPLATES.tab=_.template(a("#underscore-tab").html());TEMPLATES.modal=_.template(a("#underscore-modal").html());a("#menu-app").hide();a("#menu-func").hide();handlerMenuAppLoad();window.SETTINGS=new classSettings();a("alert").alert();a(".dropdown-toggle").dropdown();if(SETTINGS.init().ready){a("#search").focus();a("body").on("click","tr[data-pk]",eventRowClick);a("#menu-app li[class!=disabled]").on("click","a",eventTabOpen);a("#main-tab").on("click","button.close[data-id]",eventTabClose);restoreSession();a("body").on("keyup","[data-action=collection_filter]",eventCollectionFilter);a("body").on("change","[data-action=collection_filter]",eventCollectionFilter);a("body").on("click","[data-action=collection_count]",eventCollectionCount);a("body").on("change","[data-action=collection_page]",eventCollectionPage);a("body").on("click","[data-action=collection_page]",eventCollectionPage);a("body").on("click","[data-action=object_open]",eventObjectOpen);a("body").on("click","[data-action=object_copy]",eventObjectCopy);a("body").on("click","[data-action=object_clone]",eventObjectClone);a("body").on("click","[data-action=object_add]",eventObjectAdd);a("body").on("click","[data-action=object_add_m2m]",{m2m:true},eventObjectAdd);a("body").on("click","[data-action=object_delete]",eventObjectDelete);a("body").on("click","[data-action=object_delete_m2m]",{m2m:true},eventObjectDelete);a("body").on("keyup","[data-action=object_change]",eventObjectChange);a("body").on("change","[data-action=object_change]",eventObjectChange);a("body").on("click","[data-action=object_reset]",eventObjectReset);a("body").on("click","[data-action=object_save]",eventObjectSave);a("body").on("click","[data-action=object_select]",eventObjectSelect);a("body").on("click","[data-action=field_clear]",eventFieldClear);a("body").on("click","[data-action=field_select]",eventFieldSelect);a("body").on("click","[data-toggle=checkboxes]",toggleCheckboxes)}else{console.log("ОШИБКА! Загрузка настроек не удалась.")}});