

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Writing Handlers &mdash; Vaurien 0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Vaurien 0.1 documentation" href="index.html" />
    <link rel="prev" title="Handlers" href="handlers.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="handlers.html" title="Handlers"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Vaurien 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="writing-handlers">
<span id="extending"></span><h1>Writing Handlers<a class="headerlink" href="#writing-handlers" title="Permalink to this headline">¶</a></h1>
<p>Creating new handlers is done by implementing a class with a specific signature.</p>
<p>You can inherit from the base class Vaurien provides and just implement the
<strong>__call__</strong> method:</p>
<div class="highlight-python"><pre>from vaurien.handlers import BaseHandler

class MySuperHandler(BaseHandler):

    name = 'super'
    options = {}

    def __call__(self, client_sock, backend_sock, to_backend):
        # do something here</pre>
</div>
<p>Vaurien can use this handler and call it everytime data is being seen on one hand
or the other.</p>
<p>Where:</p>
<ul class="simple">
<li><strong>name</strong> - the name under which your backend is known</li>
<li><strong>options</strong> - a mapping containing your handler options</li>
<li><strong>client_sock</strong> - the socket opened with the client</li>
<li><strong>backend_sock</strong> - the socket opened with the backend server</li>
<li><strong>to_backend</strong> - a boolean giving the direction of the call. If True
it means some data is available in the client socket, that is supposed
to go to the backend. If False, it means data is available on the backend
socket and should be tramsmitted back to the client.</li>
</ul>
<p>A handler instance is initialized with two values:</p>
<ul class="simple">
<li><strong>settings</strong> - the settings loaded for the handler</li>
<li><strong>proxy</strong> - the proxy instance</li>
</ul>
<p>For the handler options, each option is defined in the <strong>options</strong> mapping.
The key is the option name and the value is a 3-tuple providing:</p>
<ul class="simple">
<li>a description</li>
<li>a type</li>
<li>a default value</li>
</ul>
<p><strong>every option is optional and need a default value</strong></p>
<div class="section" id="full-handler-example">
<h2>Full handler example<a class="headerlink" href="#full-handler-example" title="Permalink to this headline">¶</a></h2>
<p>Here is how the <cite>delay</cite> handler is specified:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">vaurien.handlers</span> <span class="kn">import</span> <span class="n">BaseHandler</span>

<span class="k">class</span> <span class="nc">Delay</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds a delay before the backend is called.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;delay&#39;</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;sleep&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&quot;Delay in seconds&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s">&#39;before&#39;</span><span class="p">:</span>
                    <span class="p">(</span><span class="s">&quot;If True adds before the backend is called. Otherwise&quot;</span>
                    <span class="s">&quot; after&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="bp">True</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_sock</span><span class="p">,</span> <span class="n">backend_sock</span><span class="p">,</span> <span class="n">to_backend</span><span class="p">):</span>
        <span class="n">before</span> <span class="o">=</span> <span class="n">to_backend</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="s">&#39;before&#39;</span><span class="p">)</span>
        <span class="n">after</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">to_backend</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="s">&#39;before&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">before</span><span class="p">:</span>
            <span class="n">gevent</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="s">&#39;sleep&#39;</span><span class="p">))</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="n">backend_sock</span><span class="p">,</span> <span class="n">to_backend</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">after</span><span class="p">:</span>
            <span class="n">gevent</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="s">&#39;sleep&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">dest</span> <span class="o">=</span> <span class="n">to_backend</span> <span class="ow">and</span> <span class="n">backend_sock</span> <span class="ow">or</span> <span class="n">client_sock</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="using-handlers">
<h2>Using handlers<a class="headerlink" href="#using-handlers" title="Permalink to this headline">¶</a></h2>
<p>Once the handler is ready, you can point it to Vaurien
by providing its fully qualified name - e.g. the class name prefixed
by the module and package(s) names.</p>
<p>Then you can use it with the <strong>&#8211;behavior</strong> option:</p>
<div class="highlight-python"><pre>$ vaurien --local localhost:8000 --distant google.com:80 \
    --behavior 20:path.to.the.callable \
    --handlers.delay.sleep 2</pre>
</div>
<p>Or by using a configuration file:</p>
<div class="highlight-python"><pre>[vaurien]
behavior = 20:foobar

[handler:foobar]
callable = path.to.the.callable
foo=bar</pre>
</div>
<p>And calling Vaurien with &#8211;config:</p>
<div class="highlight-python"><pre>$ vaurien --config config.ini</pre>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Writing Handlers</a><ul>
<li><a class="reference internal" href="#full-handler-example">Full handler example</a></li>
<li><a class="reference internal" href="#using-handlers">Using handlers</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="handlers.html"
                        title="previous chapter">Handlers</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/extending.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="handlers.html" title="Handlers"
             >previous</a> |</li>
        <li><a href="index.html">Vaurien 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Mozilla.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>