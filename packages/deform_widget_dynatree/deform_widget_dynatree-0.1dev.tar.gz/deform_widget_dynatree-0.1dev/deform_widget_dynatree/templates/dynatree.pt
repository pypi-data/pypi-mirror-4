<input type="text"
       name="${field.name}"
       value="${cstruct}"
       id="${field.oid}"
       class="dynatree" />
<div id="${field.oid}_dynatree"></div>
<script type="text/javascript">
  $(function() {

    var tree_id = "#${field.oid}_dynatree";

    function initTree() {
      $(tree_id).dynatree({
        autoCollapse: ${field.widget.autoCollapse},
        autoFocus: ${field.widget.autoFocus},
        debugLevel: ${field.widget.debugLevel},
        fx: {
          height: "toggle",
          duration: 200
        },
        initAjax: {
          url: "${field.widget.api_url}",
          data: {
            key: $("#${field.oid}").val(),
            mode: "root",
          },
        },
        onActivate: function(node) {
          $("#${field.oid}").val('' + node.data.key);
        },
        onLazyRead: function(node){
          node.appendAjax({
            url: "${field.widget.api_url}",
            data: {
              key: node.data.key,
              mode: "branch",
            }
          });
        },
        onPostInit: function(isReloading, isError) {
          this.reactivate();
        },
        selectMode: 1,
        title: "${field.title}"
      });
    }

    initTree();
  });
</script>
