

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>1. インストール &mdash; bpssl 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/translations.js"></script>
    <script type="text/javascript" src="_static/theme_extras.js"></script>
    <link rel="top" title="bpssl 1.0 documentation" href="index.html" />
    <link rel="next" title="2. セキュアリクエストでしかアクセスできないように制限をかける" href="usage.html" />
    <link rel="prev" title="bpssl ドキュメント" href="index.html" /> 
  </head>
  <body>
      <div class="header"><img class="rightlogo" src="_static/beproud.png" alt="Logo"/><h1 class="heading"><a href="index.html">
          <span>bpssl 1.0 documentation</span></a></h1>
        <h2 class="heading"><span>1. インストール</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="index.html">bpssl ドキュメント</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">コンテンツ</a>
        &#160;&#160;::&#160;&#160;
        <a href="usage.html">2. セキュアリクエストでしかアクセスできないように制限をかける</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="id1">
<h1>1. インストール<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="section" id="id2">
<h2>1.1. アプリケーションインストール<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>bpssl をインストールするのが簡単ですが、ウェブサーバーと
連携するところがありますので、注意しないといけません。</p>
<p>まずは、ポッケージを PIP でインストールします:</p>
<div class="highlight-python"><pre>$ pip install bpssl</pre>
</div>
<p>もしくは <tt class="docutils literal"><span class="pre">easy_install</span></tt> で:</p>
<div class="highlight-python"><pre>$ easy_install bpssl</pre>
</div>
<p>次に、 <tt class="docutils literal"><span class="pre">'beproud.django.ssl'</span></tt> を <tt class="docutils literal"><span class="pre">settings.py</span></tt> の <a class="reference external" href="http://djangoproject.jp/doc/ja/1.0/ref/settings.html#installed-apps">INSTALLED_APPS</a> に追加してください。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;django.contrib.auth&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.contenttypes&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.sessions&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.sites&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.messages&#39;</span><span class="p">,</span>
    <span class="c">#...</span>
    <span class="s">&#39;beproud.django.ssl&#39;</span><span class="p">,</span>
    <span class="c">#...</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h2>1.2. コンテキストプロセッサー<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h2>
<dl class="function">
<dt id="beproud.django.ssl.context_processors.conf">
<tt class="descclassname">beproud.django.ssl.context_processors.</tt><tt class="descname">conf</tt><big>(</big><big>)</big><a class="headerlink" href="#beproud.django.ssl.context_processors.conf" title="この定義へのパーマリンク">¶</a></dt>
<dd></dd></dl>

<p><a class="reference internal" href="#beproud.django.ssl.context_processors.conf" title="beproud.django.ssl.context_processors.conf"><tt class="xref py py-func docutils literal"><span class="pre">beproud.django.ssl.context_processors.conf()</span></tt></a> コンテキストプロセッサーを
<a class="reference external" href="http://djangoproject.jp/doc/ja/1.0/ref/settings.html#template-context-processors">TEMPLATE_CONTEXT_PROCESSORS</a> に追加してください。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">TEMPLATE_CONTEXT_PROCESSORS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="c">#...</span>
    <span class="s">&#39;beproud.django.ssl.context_processors.conf&#39;</span><span class="p">,</span>
    <span class="c">#...</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h2>1.3. ミドルウエアを設定<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>それから、 <tt class="docutils literal"><span class="pre">'beproud.django.ssl.middleware.SSLRedirectMiddleware'</span></tt> を <a class="reference external" href="http://djangoproject.jp/doc/ja/1.0/ref/settings.html#setting-MIDDLEWARE_CLASSES">MIDDLEWARE_CLASSES</a> に追加してください。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">MIDDLEWARE_CLASSES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;django.middleware.common.CommonMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.sessions.middleware.SessionMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.middleware.csrf.CsrfViewMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.auth.middleware.AuthenticationMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.messages.middleware.MessageMiddleware&#39;</span><span class="p">,</span>
    <span class="c">#...</span>
    <span class="s">&#39;beproud.django.ssl.middleware.SSLRedirectMiddleware&#39;</span><span class="p">,</span>
    <span class="c">#...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>HTTPのリバースプロクシーを使う場合は、
<tt class="docutils literal"><span class="pre">'beproud.django.ssl.middleware.SSLProxyMiddleware'</span></tt> を <a class="reference external" href="http://djangoproject.jp/doc/ja/1.0/ref/settings.html#setting-MIDDLEWARE_CLASSES">MIDDLEWARE_CLASSES</a> に
追加する必要があります。できるだけ上に登録すること。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">MIDDLEWARE_CLASSES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;beproud.django.ssl.middleware.SSLProxyMiddleware&#39;</span><span class="p">,</span>
    <span class="c"># ...</span>
    <span class="s">&#39;django.middleware.common.CommonMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.sessions.middleware.SessionMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.middleware.csrf.CsrfViewMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.auth.middleware.AuthenticationMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.messages.middleware.MessageMiddleware&#39;</span><span class="p">,</span>
    <span class="c"># ...</span>
    <span class="s">&#39;beproud.django.ssl.middleware.SSLRedirectMiddleware&#39;</span><span class="p">,</span>
    <span class="c"># ...</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="install-web-server-setup">
<span id="id5"></span><h2>1.4. ウェブサーバーの設定<a class="headerlink" href="#install-web-server-setup" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>SSLのエンコードやデコードがウェブサーバーで行うため、Djangoのアプリケーション側で、
リクエストがセキュアかどうかを判断するには、ウェブサーバーからその情報
をアップストリームのアプリケーションサーバーに送る必要があります。その情報を送る
ために、ウェブサーバーを設定する必要があります。具体的にいうと、 <a class="reference external" href="http://djangoproject.jp/doc/ja/1.0/ref/request-response.html#django.http.HttpRequest.is_secure">request.is_secure()</a>
に頼っているので、このメソッドが正しい値を返すようにします。</p>
<div class="section" id="nginxfastcgi">
<h3>1.4.1. nginx・FastCGIの場合<a class="headerlink" href="#nginxfastcgi" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>nginxとFastCGIを使う場合、ウェブサーバーの設定で、FastCGIの <tt class="docutils literal"><span class="pre">HTTPS</span></tt> パラメーターを
<tt class="docutils literal"><span class="pre">on</span></tt> に設定すれば、 Django のアプリケーションはHTTPかHTTPSかを判断することが
できます。そうするには、 <tt class="docutils literal"><span class="pre">fastcgi_param</span></tt> を <tt class="docutils literal"><span class="pre">HTTPS</span> <span class="pre">on</span></tt> に設定します。
<tt class="docutils literal"><span class="pre">HTTPS</span></tt> を <tt class="docutils literal"><span class="pre">'on'</span></tt> に設定すれば、flup は <tt class="docutils literal"><span class="pre">wsgi.url_scheme</span></tt> を <tt class="docutils literal"><span class="pre">https</span></tt> に設定し、
<a class="reference external" href="http://djangoproject.jp/doc/ja/1.0/ref/request-response.html#django.http.HttpRequest.is_secure">request.is_secure()</a> が正しい値を返すようになります。</p>
<div class="highlight-nginx"><div class="highlight"><pre><span class="k">location</span> <span class="s">/</span> <span class="p">{</span>
    <span class="kn">include</span>                 <span class="s">/etc/nginx/fastcgi_params</span><span class="p">;</span>
    <span class="kn">fastcgi_pass</span>            <span class="s">upstream</span><span class="p">;</span>
    <span class="kn">fastcgi_param</span>           <span class="s">HTTPS</span> <span class="no">on</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="nginxhttp-proxy">
<h3>1.4.2. nginx・HTTP proxyの場合<a class="headerlink" href="#nginxhttp-proxy" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>HTTPリバースプロクシーとして、nginx を使う場合、HTTPリクエストがセキュアか
どうかの情報をHTTPヘッダーでアプリケーションに渡す必要があります。
HTTPSで、送っているはずなのに、ブラウザがHTTPで情報を送らせてしまう
man-in-the-middle 攻撃を避けるために、 HTTP リクエストの場合でも、nginxで
このヘッダーを設定する、もしくは削る必要があります。</p>
<p><a class="reference internal" href="settings.html#setting-ssl-request-header"><em>SSL_REQUEST_HEADER</em></a> で設定したヘッダー名と
値を nginx 側で設定してください。
<a class="reference internal" href="usage.html#beproud.django.ssl.middleware.SSLProxyMiddleware" title="beproud.django.ssl.middleware.SSLProxyMiddleware"><tt class="xref py py-class docutils literal"><span class="pre">SSLProxyMiddleware</span></tt></a>
と併用します。</p>
<div class="highlight-nginx"><div class="highlight"><pre><span class="c1">#HTTP</span>
<span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
        <span class="kn">proxy_pass</span>          <span class="s">http://myproxy</span><span class="p">;</span>

        <span class="c1"># We need to set this header for HTTP requests as well</span>
        <span class="c1"># so that we won&#39;t fall victim to man-in-the-middle attacks.</span>
        <span class="kn">proxy_set_header</span> <span class="s">X_FORWARDED_PROTOCOL</span>      <span class="s">&quot;http&quot;</span><span class="p">;</span>
        <span class="c1"># ...</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># HTTPS</span>
<span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">443</span><span class="p">;</span>
    <span class="kn">ssl</span> <span class="no">on</span><span class="p">;</span>
    <span class="c1"># ...</span>
    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
        <span class="kn">proxy_pass</span>          <span class="s">http://myproxy</span><span class="p">;</span>
        <span class="c1"># This should be set to the same headeras the</span>
        <span class="c1"># non-ssl setup above.</span>
        <span class="kn">proxy_set_header</span>    <span class="s">X_FORWARDED_PROTOCOL</span>   <span class="s">https</span><span class="p">;</span>
        <span class="c1"># ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="apachefastcgi">
<h3>1.4.3. Apache・FastCGIの場合<a class="headerlink" href="#apachefastcgi" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Apache・FastCGIの場合は、HTTPS の環境変数を設定したら、 <a class="reference external" href="http://djangoproject.jp/doc/ja/1.0/ref/request-response.html#django.http.HttpRequest.is_secure">request.is_secure()</a> は
正しく動作するはず。Apache の rewrite モジュールで、以下の様に HTTPS 環境変数を
設定できます。</p>
<div class="highlight-apache"><div class="highlight"><pre><span class="nt">&lt;VirtualHost</span> <span class="s">*:443</span><span class="nt">&gt;</span>
    <span class="nb">SSLEngine</span> <span class="k">on</span>
    <span class="c"># ...</span>

    <span class="nb">RewriteEngine</span> <span class="k">on</span>
    <span class="nb">RewriteCond</span> %{HTTPS} <span class="k">on</span>
    <span class="nb">RewriteRule</span> .* - [E=HTTPS:on]

    <span class="c"># ...</span>
<span class="nt">&lt;/VirtualHost&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="apachemod-wsgi">
<h3>1.4.4. Apache・mod_wsgiの場合<a class="headerlink" href="#apachemod-wsgi" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Apache・mod_wsgi を使う場合は、 <tt class="docutils literal"><span class="pre">wsgi.url_scheme</span></tt> が設定していますので、
特に特別な設定をせずに、 <a class="reference external" href="http://djangoproject.jp/doc/ja/1.0/ref/request-response.html#django.http.HttpRequest.is_secure">request.is_secure()</a> が正しい値を返します。</p>
</div>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="index.html">bpssl ドキュメント</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">コンテンツ</a>
        &#160;&#160;::&#160;&#160;
        <a href="usage.html">2. セキュアリクエストでしかアクセスできないように制限をかける</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2010, 株式会社ビープラウド.
      このドキュメントは <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3 で生成しました。
    </div>
  </body>
</html>