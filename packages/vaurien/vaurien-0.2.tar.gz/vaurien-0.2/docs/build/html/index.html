

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Welcome to Vaurien’s documentation! &mdash; Vaurien 0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Vaurien 0.1 documentation" href="#" />
    <link rel="next" title="APIs" href="apis.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="apis.html" title="APIs"
             accesskey="N">next</a> |</li>
        <li><a href="#">Vaurien 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="welcome-to-vaurien-s-documentation">
<h1>Welcome to Vaurien&#8217;s documentation!<a class="headerlink" href="#welcome-to-vaurien-s-documentation" title="Permalink to this headline">¶</a></h1>
<p><em>Vaurien, the Chaos TCP Proxy</em></p>
<p>Ever heard of the <a class="reference external" href="http://www.codinghorror.com/blog/2011/04/working-with-the-chaos-monkey.html">Chaos Monkey</a>?</p>
<p>It&#8217;s a project at Netflix to enhance the infrastructure tolerance. The Chaos Monkey
will randomly shut down some servers or block some network connections, and the system
is supposed to survive to these events. It&#8217;s a way to verify the high availability
and tolerance of the system.</p>
<p>Besides a redundant infrastructure, if you think about reliability at the level
of your web applications there are many questions that often remain unanswered:</p>
<ul class="simple">
<li>What happens if the MYSQL server is restarted? Are your connectors able
to survive this event and continue to work properly afterwards?</li>
<li>Is your web application still working in degraded mode when Membase is
down?</li>
<li>Are you sending back the right 503s when postgresql times out ?</li>
</ul>
<p>Of course you can &#8211; and should &#8211; try out all these scenarios on stage while
your application is getting a realistic load.</p>
<p>But testing these scenarios while you are building your code is also a good
practice, and having automated functional tests for this is preferable.</p>
<p>That&#8217;s where <strong>Vaurien</strong> is useful.</p>
<p>Vaurien is basically a Chaos Monkey for your TCP connections. Vaurien
acts as a proxy between your application and any backend.</p>
<p>You can use it in your functional tests or even on a real deployment
through the command-line.</p>
</div>
<div class="section" id="installing-vaurien">
<h1>Installing Vaurien<a class="headerlink" href="#installing-vaurien" title="Permalink to this headline">¶</a></h1>
<p>You can install Vaurien directly from PyPI; the best way to do so is via
<cite>pip</cite>:</p>
<div class="highlight-python"><pre>$ pip install vaurien</pre>
</div>
</div>
<div class="section" id="using-vaurien-from-the-command-line">
<h1>Using Vaurien from the command-line<a class="headerlink" href="#using-vaurien-from-the-command-line" title="Permalink to this headline">¶</a></h1>
<p>Vaurien is a command-line tool.</p>
<p>Let&#8217;s say you want to add a delay for 20% of the requests done on google.com:</p>
<div class="highlight-python"><pre>$ vaurien --local localhost:8000 --distant google.com:80 --behavior 20:delay</pre>
</div>
<p>Vaurien will stream all the traffic to google.com but will add delays 20% of the
time. You can pass options to the handler using <em>&#8211;handlers.NAME.OPTION</em> options:</p>
<div class="highlight-python"><pre>$ vaurien --local localhost:8000 --distant google.com:80 --behavior 20:delay \
    --handlers.delay.sleep 2</pre>
</div>
<p>Passing all options through the command-line can be tedious, so you can
also create a <em>ini</em> file for this:</p>
<div class="highlight-python"><pre>[vaurien]
distant = google.com:80
local = localhost:8000
behavior = 20:delay

[handler:delay]
sleep = 2</pre>
</div>
<p>Each behavior applied on the request or response going through Vaurien
is called a <strong>handler</strong>, and the ini file gets one section per handler.</p>
<p>You can find a descriptions of all built-in handlers here: <a class="reference internal" href="handlers.html#handlers"><em>Handlers</em></a>.</p>
</div>
<div class="section" id="controlling-vaurien-live">
<h1>Controlling Vaurien live<a class="headerlink" href="#controlling-vaurien-live" title="Permalink to this headline">¶</a></h1>
<p>Sometimes, it is useful to control live the proxy, so you can change its
behavior live between client calls.</p>
<p>Vaurien provides an HTTP server with a few APIs, which can be used to control
the proxy.</p>
<p>To activate it, use the <cite>&#8211;http</cite> option:</p>
<div class="highlight-python"><pre>$ vaurien --http</pre>
</div>
<p>By default the server runs on port <strong>8080</strong> while the proxy runs on <strong>8000</strong></p>
<p>Once it runs, you can call it using cURL or any HTTP client. See the
<a class="reference internal" href="apis.html#apis"><em>APIs</em></a>.</p>
</div>
<div class="section" id="controlling-vaurien-in-your-code">
<h1>Controlling Vaurien in your code<a class="headerlink" href="#controlling-vaurien-in-your-code" title="Permalink to this headline">¶</a></h1>
<p>If you want to run and drive a Vaurien proxy from your code, the project
provides a few helpers for this.</p>
<p>For example, if you want to write a test that uses a Vaurien proxy,
you can write:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">vaurien</span> <span class="kn">import</span> <span class="n">Client</span><span class="p">,</span> <span class="n">start_proxy</span><span class="p">,</span> <span class="n">stop_proxy</span>


<span class="k">class</span> <span class="nc">MyTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxy_pid</span> <span class="o">=</span> <span class="n">start_proxy</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">stop_proxy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy_pid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;inject&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>

        <span class="k">with</span> <span class="n">client</span><span class="o">.</span><span class="n">with_handler</span><span class="p">(</span><span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
            <span class="c"># do something...</span>
            <span class="k">pass</span>

        <span class="c"># we&#39;re back to normal here</span>
</pre></div>
</div>
<p>In this test, the proxy is started and stopped before and after the
test, and the Client class will let you drive its behavior.</p>
<p>Within the <strong>with</strong> block, the proxy will error out any call by using
the <em>errors</em> handler, so you can verify that your application is
behaving as expected when it happens.</p>
</div>
<div class="section" id="extending-vaurien">
<h1>Extending Vaurien<a class="headerlink" href="#extending-vaurien" title="Permalink to this headline">¶</a></h1>
<p>Vaurien comes with a handful of useful <a class="reference internal" href="handlers.html#handlers"><em>Handlers</em></a>, but you can create your own
handlers and plug them in a configuration file.</p>
<p>In fact that&#8217;s the best way to create realistic issues. Imagine that you
have a very specific type of error on your LDAP server everytime your
infrastructure is under heavy load. You can reproduce this issue in your
handler and make sure your web application behaves as it should.</p>
<p>Creating new handlers is done by implementing a class with a specific signature.</p>
<p>You can inherit from the base class Vaurien provides and just implement the
<strong>__call__</strong> method:</p>
<div class="highlight-python"><pre>from vaurien.handlers import BaseHandler

class MySuperHandler(BaseHandler):

    name = 'super'
    options = {}

    def __call__(self, client_sock, backend_sock, to_backend):
        # do something here</pre>
</div>
<p>More about this in <a class="reference internal" href="extending.html#extending"><em>Writing Handlers</em></a>.</p>
</div>
<div class="section" id="code-repository">
<h1>Code repository<a class="headerlink" href="#code-repository" title="Permalink to this headline">¶</a></h1>
<p>If you&#8217;re interested to look at the code, it&#8217;s there:
<a class="reference external" href="https://github.com/mozilla-services/vaurien">https://github.com/mozilla-services/vaurien</a></p>
<p>Don&#8217;t hesitate to send us pull requests or to open issues!</p>
</div>
<div class="section" id="more-documentation">
<h1>More documentation<a class="headerlink" href="#more-documentation" title="Permalink to this headline">¶</a></h1>
<p>Contents:</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="apis.html">APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="apis.html#command-line">Command line</a></li>
<li class="toctree-l1"><a class="reference internal" href="handlers.html">Handlers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="handlers.html#blackout">blackout</a></li>
<li class="toctree-l2"><a class="reference internal" href="handlers.html#delay">delay</a></li>
<li class="toctree-l2"><a class="reference internal" href="handlers.html#dummy">dummy</a></li>
<li class="toctree-l2"><a class="reference internal" href="handlers.html#error">error</a></li>
<li class="toctree-l2"><a class="reference internal" href="handlers.html#hang">hang</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="extending.html">Writing Handlers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="extending.html#full-handler-example">Full handler example</a></li>
<li class="toctree-l2"><a class="reference internal" href="extending.html#using-handlers">Using handlers</a></li>
</ul>
</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="#">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Welcome to Vaurien&#8217;s documentation!</a></li>
<li><a class="reference internal" href="#installing-vaurien">Installing Vaurien</a></li>
<li><a class="reference internal" href="#using-vaurien-from-the-command-line">Using Vaurien from the command-line</a></li>
<li><a class="reference internal" href="#controlling-vaurien-live">Controlling Vaurien live</a></li>
<li><a class="reference internal" href="#controlling-vaurien-in-your-code">Controlling Vaurien in your code</a></li>
<li><a class="reference internal" href="#extending-vaurien">Extending Vaurien</a></li>
<li><a class="reference internal" href="#code-repository">Code repository</a></li>
<li><a class="reference internal" href="#more-documentation">More documentation</a><ul>
</ul>
</li>
</ul>

  <h4>Next topic</h4>
  <p class="topless"><a href="apis.html"
                        title="next chapter">APIs</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/index.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="apis.html" title="APIs"
             >next</a> |</li>
        <li><a href="#">Vaurien 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Mozilla.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>