define(["jquery","cilantro/define/criteria"],function(a,b){function i(b){if(b.store===null||a.isEmptyObject(b.store))return;b.store.hasOwnProperty("concept_id")?App.hub.publish("UpdateQueryEvent",b.store,b.conditions[b.store.concept_id][0]):a.each(b.store.children,function(a,c){App.hub.publish("UpdateQueryEvent",c,b.conditions[c.concept_id][0])}),d.children().last().click()}var c={},d=a("#condition-list"),e=a("#clear-conditions"),f=App.endpoints.session.scope,g=a("#no-conditions"),h=a("#get-report");return h.click(function(){window.location=App.endpoints.report}),e.click(function(){for(var a in c)c.hasOwnProperty(a)&&App.hub.publish("CriteriaRemovedEvent",c[a])}),App.hub.subscribe("UpdateQueryEvent",function(e,i){var j=e.concept_id,k;a.isEmptyObject(c)&&(g.hide(),h.fadeIn()),h.attr("disabled",!0);if(!i){var l={},m=c.hasOwnProperty(j)?"replace":"add";l[m]=e,a.ajax({type:"PATCH",url:f,data:JSON.stringify(l),contentType:"application/json",success:function(g){var h=a.isEmptyObject(c);m==="replace"?(k=b.Criteria(e,f,g.patch_condition_text),c[j].replaceWith(k),k.fadeTo(300,.5,function(){k.fadeTo("fast",1)})):(k=b.Criteria(e,f,g.patch_condition_text),d.append(k),App.hub.publish("ConceptAddedEvent",j)),c[j]=k,k.addClass("selected"),k.siblings().removeClass("selected"),h&&a(d.children()[0]).find(".field-anchor").click()},complete:function(a,b){h.attr("disabled",!1)},statusCode:{422:function(b,c,d){var e=a.Event("InvalidInputEvent");e.ephemeral=3e3,e.message=JSON.parse(b.responseText).validation_error,a("#plugin-panel").trigger(e)}}})}else k=b.Criteria(e,f,i),d.append(k),App.hub.publish("ConceptAddedEvent",j),c[j]=k,h.removeAttr("disabled");App.hub.publish("concept/request",j)}),App.hub.subscribe("CriteriaRemovedEvent",function(b,d){var e=b.data("constraint");c[e.concept_id].remove(),delete c[e.concept_id],d||(h.attr("disabled",!0),a.patchJSON(f,JSON.stringify({remove:e}),function(){h.removeAttr("disabled")})),App.hub.publish("ConceptDeletedEvent",e.concept_id),a.isEmptyObject(c)&&(g.fadeIn(),h.hide())}),App.hub.subscribe("concept/active",function(a){c[a.id]&&c[a.id].siblings().removeClass("selected"),c[a.id]&&c[a.id].addClass("selected")}),a.getJSON(f,i),App.hub.subscribe("report/revert",function(){for(var b in c)c.hasOwnProperty(b)&&App.hub.publish("CriteriaRemovedEvent",c[b],!0);a.getJSON(f,i)}),{retrieveCriteriaDS:function(b){var c=null;return b&&a.each(d.children(),function(d,e){if(!a(e).data("constraint"))return;a(e).data("constraint").concept_id==b&&(c=a(e).data("constraint"))}),c}}})