<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <title>Test coverage report: calendarium.forms</title>
    <style type="text/css" media="screen">
      a
      {
        color: #3d707a;
      }
      
      a:hover, a:active
      {
        color: #bf7d18;
      }
    
      body 
      {
        font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
        font-size: 13px;
      }
      
      .nav 
      {
        font-size: 12px;
        margin-left: 50px;
      }

      .ignored
      {
        color: #707070;
      }

      .executed 
      {
        color: #3d9900;
      }

      .missed 
      {
        color: red;
        font-weight: bold;
      }

      .excluded 
      {
        color: #6090f0;
        font-weight: lighter;
      }
    
      #content-header 
      {
        font-size: 12px;
        padding: 18px 0 18px 50px;
      }

      #content-header h1 
      {
        font-size: 16px;
        margin: 10px 0 0 0;
        color: #909090;
      }
      
      #module-name
      {
        color: #583707;
      }
    
      #content-header p
      {
        font-size: 13px;
        margin: 0;
        color: #909090;
      }

      #content-header .normal 
      {
        color: #609030;
      }

      #content-header .warning 
      {
        color: #d0a000;
      }

      #content-header .critical 
      {
        color: red;
      }
      
      #source-listing 
      {
        margin-bottom: 24px;
      }

      #source-listing ol 
      {
        padding: 0 0 0 50px;
        width: 90%;
        font-family: monospace;
        list-style-position: outside;
      }

      #source-listing ol li 
      {
        line-height: 18px;
        font-size: small;
      }
        
      #source-listing ol code 
      {
        padding:  0 .001em 0 0; /* Firefox doesn't render empty li's properly */
        font-size: medium;
        white-space: pre;
      }
   </style>
  </head>

  <body>

<div class="nav">
  <a href="calendarium.constants.html">calendarium.constants</a> &lt;&lt;
  <a href="../index.html">index</a>
  &gt;&gt; <a href="calendarium.models.html">calendarium.models</a>
</div>

<div id="content-header">
  <h1>
    <span id="module-name">calendarium.forms</span>:
    70 total statements,
    <span class="normal">79.7% covered</span>
  </h1>
  <p>Generated: Tue 2013-04-16 13:15 CEST</p>
  <p>Source file: /home/tobi/Projects/calendarium/src/calendarium/forms.py</p>
  <p>
    Stats:
    <span class="executed">51 executed</span>,
    <span class="missed">13 missed</span>,
    <span class="excluded">6 excluded</span>,
    <span class="ignored">58 ignored</span> 
  </p> 
</div>

<div id="source-listing">
  <ol>
    <li class="ignored"><code>"""Forms for the ``calendarium`` app."""</code></li>
<li class="excluded"><code>from django import forms</code></li>
<li class="excluded"><code>from django.contrib.auth.models import User</code></li>
<li class="excluded"><code>from django.forms.models import model_to_dict</code></li>
<li class="excluded"><code>from django.utils.timezone import datetime, timedelta</code></li>
<li class="ignored"><code></code></li>
<li class="excluded"><code>from calendarium.constants import (</code></li>
<li class="ignored"><code>    OCCURRENCE_DECISION_CHOICESS,</code></li>
<li class="ignored"><code>    OCCURRENCE_DECISIONS,</code></li>
<li class="ignored"><code>)</code></li>
<li class="excluded"><code>from calendarium.models import Event, Occurrence</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class OccurrenceForm(forms.ModelForm):</code></li>
<li class="ignored"><code>    """A form for the ``Occurrence`` model."""</code></li>
<li class="executed"><code>    decision = forms.CharField(</code></li>
<li class="ignored"><code>        widget=forms.Select(choices=OCCURRENCE_DECISION_CHOICESS),</code></li>
<li class="ignored"><code>    )</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    cancelled = forms.BooleanField(</code></li>
<li class="ignored"><code>        widget=forms.HiddenInput,</code></li>
<li class="ignored"><code>        required=False,</code></li>
<li class="ignored"><code>    )</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    original_start = forms.DateTimeField(</code></li>
<li class="ignored"><code>        widget=forms.HiddenInput,</code></li>
<li class="ignored"><code>    )</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    original_end = forms.DateTimeField(</code></li>
<li class="ignored"><code>        widget=forms.HiddenInput,</code></li>
<li class="ignored"><code>    )</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    event = forms.ModelChoiceField(</code></li>
<li class="ignored"><code>        widget=forms.HiddenInput,</code></li>
<li class="ignored"><code>        queryset=Event.objects.all(),</code></li>
<li class="ignored"><code>    )</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    class Meta:</code></li>
<li class="executed"><code>        model = Occurrence</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def save(self):</code></li>
<li class="executed"><code>        cleaned_data = self.cleaned_data</code></li>
<li class="executed"><code>        if cleaned_data['decision'] == OCCURRENCE_DECISIONS['all']:</code></li>
<li class="executed"><code>            changes = {</code></li>
<li class="ignored"><code>                key: value for key, value in cleaned_data.iteritems()</code></li>
<li class="ignored"><code>                if value != self.initial.get(key) and self.initial.get(key)}</code></li>
<li class="executed"><code>            event = self.instance.event</code></li>
<li class="ignored"><code>            # for each field on the event, check for new data in cleaned_data</code></li>
<li class="executed"><code>            for field_name in [field.name for field in event._meta.fields]:</code></li>
<li class="executed"><code>                value = changes.get(field_name)</code></li>
<li class="executed"><code>                if value:</code></li>
<li class="executed"><code>                    setattr(event, field_name, value)</code></li>
<li class="executed"><code>            event.save()</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>            # repeat for persistent occurrences</code></li>
<li class="executed"><code>            for occ in event.occurrences.all():</code></li>
<li class="executed"><code>                for field_name in [field.name for field in occ._meta.fields]:</code></li>
<li class="executed"><code>                    value = changes.get(field_name)</code></li>
<li class="executed"><code>                    if value:</code></li>
<li class="ignored"><code>                        # since we can't just set a new datetime, we have to</code></li>
<li class="ignored"><code>                        # adjust the datetime fields according to the changes</code></li>
<li class="ignored"><code>                        # on the occurrence form instance</code></li>
<li class="executed"><code>                        if type(value) != datetime:</code></li>
<li class="executed"><code>                            setattr(occ, field_name, value)</code></li>
<li class="ignored"><code>                        else:</code></li>
<li class="executed"><code>                            initial_time = self.initial.get(field_name)</code></li>
<li class="executed"><code>                            occ_time = getattr(occ, field_name)</code></li>
<li class="executed"><code>                            delta = value - initial_time</code></li>
<li class="executed"><code>                            new_time = occ_time + delta</code></li>
<li class="executed"><code>                            setattr(occ, field_name, new_time)</code></li>
<li class="executed"><code>                occ.save()</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>            # get everything from initial and compare to cleaned_data to</code></li>
<li class="ignored"><code>            # retrieve what has been changed</code></li>
<li class="ignored"><code>            # apply those changes to the persistent occurrences (and the main</code></li>
<li class="ignored"><code>            # event)</code></li>
<li class="executed"><code>        elif cleaned_data['decision'] == OCCURRENCE_DECISIONS['this one']:</code></li>
<li class="executed"><code>            self.instance.save()</code></li>
<li class="executed"><code>        elif cleaned_data['decision'] == OCCURRENCE_DECISIONS['following']:</code></li>
<li class="ignored"><code>            # get the changes</code></li>
<li class="executed"><code>            changes = {</code></li>
<li class="ignored"><code>                key: value for key, value in cleaned_data.iteritems()</code></li>
<li class="ignored"><code>                if value != self.initial.get(key) and self.initial.get(key)}</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>            # change the old event</code></li>
<li class="executed"><code>            old_event = self.instance.event</code></li>
<li class="executed"><code>            end_recurring_period = self.instance.event.end_recurring_period</code></li>
<li class="executed"><code>            old_event.end_recurring_period = self.instance.start - timedelta(</code></li>
<li class="ignored"><code>                days=1)</code></li>
<li class="executed"><code>            old_event.save()</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>            # the instance occurrence holds the info for the new event, that we</code></li>
<li class="ignored"><code>            # use to update the old event's fields</code></li>
<li class="executed"><code>            new_event = old_event</code></li>
<li class="executed"><code>            new_event.end_recurring_period = end_recurring_period</code></li>
<li class="executed"><code>            new_event.id = None</code></li>
<li class="executed"><code>            event_kwargs = model_to_dict(self.instance)</code></li>
<li class="executed"><code>            for field_name in [field.name for field in new_event._meta.fields]:</code></li>
<li class="executed"><code>                if (field_name == 'created_by'</code></li>
<li class="ignored"><code>                        and event_kwargs.get('created_by')):</code></li>
<li class="missed"><code>                    value = User.objects.get(pk=event_kwargs.get(field_name))</code></li>
<li class="executed"><code>                elif field_name in ['rule', 'category']:</code></li>
<li class="executed"><code>                    continue</code></li>
<li class="ignored"><code>                else:</code></li>
<li class="executed"><code>                    value = event_kwargs.get(field_name)</code></li>
<li class="executed"><code>                if value:</code></li>
<li class="executed"><code>                    setattr(new_event, field_name, value)</code></li>
<li class="executed"><code>            new_event.save()</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>            # update the new event and update all of the corresponding occs</code></li>
<li class="executed"><code>            for occ in self.instance.event.occurrences.filter(</code></li>
<li class="ignored"><code>                    start__gte=self.instance.start):</code></li>
<li class="missed"><code>                occ.event = new_event</code></li>
<li class="missed"><code>                for field_name in [field.name for field in occ._meta.fields]:</code></li>
<li class="missed"><code>                    value = changes.get(field_name)</code></li>
<li class="missed"><code>                    if value:</code></li>
<li class="ignored"><code>                        # since we can't just set a new datetime, we have to</code></li>
<li class="ignored"><code>                        # adjust the datetime fields according to the changes</code></li>
<li class="ignored"><code>                        # on the occurrence form instance</code></li>
<li class="missed"><code>                        if type(value) != datetime:</code></li>
<li class="missed"><code>                            setattr(occ, field_name, value)</code></li>
<li class="ignored"><code>                        else:</code></li>
<li class="missed"><code>                            initial_time = self.initial.get(field_name)</code></li>
<li class="missed"><code>                            occ_time = getattr(occ, field_name)</code></li>
<li class="missed"><code>                            delta = value - initial_time</code></li>
<li class="missed"><code>                            new_time = occ_time + delta</code></li>
<li class="missed"><code>                            setattr(occ, field_name, new_time)</code></li>
<li class="missed"><code>                occ.save()</code></li>
  </ol>
</div>

<div class="nav">
  <a href="calendarium.constants.html">calendarium.constants</a> &lt;&lt;
  <a href="../index.html">index</a>
  &gt;&gt; <a href="calendarium.models.html">calendarium.models</a>
</div>

  </body>
</html>

