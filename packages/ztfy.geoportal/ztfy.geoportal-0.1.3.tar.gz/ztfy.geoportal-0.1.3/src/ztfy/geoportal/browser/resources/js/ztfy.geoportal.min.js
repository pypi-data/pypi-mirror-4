(function(a){if(typeof(a.ZTFY)=="undefined"){a.ZTFY={}}a.ZTFY.geoportal={open:function(b,c){a.ZTFY.dialog.open(c+"?prefix="+b)},initViewer:function(s,o,c,q,t){Geoportal.GeoXYForm=OpenLayers.Class({containerId:null,buttonId:null,imgButton:null,lonId:null,latId:null,vectorProjection:"IGNF:RGF93G",precision:1000000,marker:null,container:null,button:null,Lon:null,Lat:null,initialize:function(u){OpenLayers.Util.extend(this,u);if(typeof(this.vectorProjection)=="string"){this.vectorProjection=new OpenLayers.Projection(this.vectorProjection)}this.container=parent.document.getElementById(this.containerId);this.button=parent.document.getElementById(this.buttonId);this.Lon=parent.document.getElementById(this.lonId);this.Lat=parent.document.getElementById(this.latId)},getXInput:function(){return this.Lon},getYInput:function(){return this.Lat},getX:function(){if(this.Lon){return parseFloat(this.Lon.value)}return NaN},getY:function(){if(this.Lat){return parseFloat(this.Lat.value)}return NaN},setX:function(u){if(this.Lon&&!isNaN(parseFloat(u))){this.Lon.value=u}},setY:function(u){if(this.Lat&&!isNaN(parseFloat(u))){this.Lat.value=u}},getPrecision:function(){return this.precision?this.precision:1000000},getNativeProjection:function(){return this.vectorProjection},CLASS_NAME:"Geoportal.GeoXYForm"});var e={mode:"normal",territory:c||"FXX",projection:q||"IGNF:GEOPORTALFXX",displayProjection:t||"IGNF:RGF93G",proxy:"http://api.ign.fr/geoportail/api/xmlproxy?url="};var d=new Geoportal.Viewer.Default(s,OpenLayers.Util.extend(e,window.gGEOPORTALRIGHTSMANAGEMENT===undefined?{apiKey:o}:gGEOPORTALRIGHTSMANAGEMENT));d.addGeoportalLayers(["ORTHOIMAGERY.ORTHOPHOTOS","GEOGRAPHICALGRIDSYSTEMS.MAPS"],{});var s=a("DIV[id="+s+"]").get(0);a.data(s,"ztfy.geoportal.viewer",d);var m="location-widgets-longitude";var r="location-widgets-latitude";var k={containerId:s,lonId:m,latId:r,vectorProjection:new OpenLayers.Projection("EPSG:4326"),precision:1000000,marker:"/--static--/ztfy.geoportal/img/pin.png"};var b=new Geoportal.GeoXYForm(k);d.setVariable("gpForm",b);var i=null;if(b.marker){i=new OpenLayers.StyleMap({"default":OpenLayers.Util.extend({externalGraphic:b.marker,graphicOpacity:1,graphicWidth:14,graphicHeight:14,graphicXOffset:0,graphicYOffset:-14,fill:false},OpenLayers.Feature.Vector["default"]),temporary:OpenLayers.Util.extend({display:"none"},OpenLayers.Feature.Vector.temporary)})}var p=a.ZTFY.dialog.dialogs;if(p.length>0){var f=p[p.length-1].src;var n=a.ZTFY.getQueryVar(f,"prefix");if(n){n=n.replace(/\./g,"-");m=n+"-longitude";r=n+"-latitude"}}var g={containerId:s,lonId:m,latId:r,vectorProjection:new OpenLayers.Projection("EPSG:4326"),precision:1000000,marker:"/--static--/ztfy.geoportal/img/pin.png"};var h=new Geoportal.GeoXYForm(g);d.setVariable("gpParentForm",h);var j=new OpenLayers.Layer.Vector("POINT_XY",{projection:b.vectorProjection,displayInLayerSwitcher:false,calculateInRange:function(){return true},styleMap:i});d.getMap().addLayer(j);var l=new OpenLayers.Control.DrawFeature(j,OpenLayers.Handler.Point,{autoActivate:true,callbacks:{done:function(v){this.layer.destroyFeatures();var u=new OpenLayers.Feature.Vector(v,{pictoUrl:"/--static--/ztfy.geoportal/img/pin.png"});u.state=OpenLayers.State.INSERT;this.layer.addFeatures([u]);a.ZTFY.geoportal.updateXYForm(u)}},handlerOptions:{persist:false,layerOptions:{projection:b.vectorProjection}}});d.getMap().addControl(l);OpenLayers.Event.observe(b.getXInput(),"change",a.ZTFY.geoportal.updateFeature);OpenLayers.Event.observe(b.getYInput(),"change",a.ZTFY.geoportal.updateFeature);a.ZTFY.geoportal.updateFeature();return d},getViewer:function(b){if(typeof(b)=="string"){var b=a("DIV[id="+b+"]").get(0)}return a.data(b,"ztfy.geoportal.viewer")},updateXYForm:function(e,d){if(!e||!e.geometry||!e.geometry.x||!e.geometry.y){return}var h=a.ZTFY.geoportal.getViewer("mapviewer");var g=e.geometry.clone();var c=h.getVariable("gpForm");g.transform(h.getMap().getProjection(),c.getNativeProjection());var f=c.getPrecision();c.setX(Math.round(g.x*f)/f);c.setY(Math.round(g.y*f)/f);var b=h.getVariable("gpParentForm");if(b){var f=b.getPrecision();b.setX(Math.round(g.x*f)/f);b.setY(Math.round(g.y*f)/f)}delete g},updateFeature:function(c,b){var e=a.ZTFY.geoportal.getViewer("mapviewer");var f=e.getMap().getLayersByName("POINT_XY")[0];var j=f.features[0];var d=e.getVariable("gpForm");var i=d.getX();var h=d.getY();if(!isNaN(i)&&!isNaN(h)){f.destroyFeatures();var g=new OpenLayers.Geometry.Point(i,h);g.transform(d.getNativeProjection(),e.getMap().getProjection());j=new OpenLayers.Feature.Vector(g);j.state=OpenLayers.State.INSERT;f.addFeatures(j);e.getMap().setCenterAtLonLat(i,h)}a.ZTFY.geoportal.updateXYForm(j);return true},hideControls:function(b){b.lyrSwCntrl.showControls("none");b.toolBoxCntrl.showControls("none");b.infoCntrl.minimizeControl()},setPosition:function(g,b,c,e,d){var f=g.map;f.setCenterAtLonLat(b.lon,b.lat);if(c){if(!d){var d=c.getDataExtent()}if(d){var e=f.getZoomForExtent(d.transform(f.getDisplayProjection(),c.projection),true)}}if(!e){var e=10}f.setCenterAtLonLat(b.lon,b.lat,e)}}})(jQuery);