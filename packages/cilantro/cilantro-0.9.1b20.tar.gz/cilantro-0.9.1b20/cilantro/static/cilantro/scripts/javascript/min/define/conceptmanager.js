define(["jquery","cilantro/define/view"],function(a,b){function x(b){a.inArray(b,o)<0&&(o.push(parseInt(b,10)),l===parseInt(b,10)&&(n.html("<span>Update Condition</span>"),a(".success",h).show()))}function y(b){var c=a.inArray(parseInt(b,10),o);c>=0&&(o.splice(c,1),l===parseInt(b,10)&&(n.html('<span class="icon plus"/> <span>Add Condition</span>'),a(".success",h).hide()))}function z(b){var c=m.elements,d=null;return a.each(c,function(c,e){if(e.type==="custom")return e.datatype;if(e.data){if(e.data.pk==b)return d=e.data.datatype,!1;if(e.data.pkchoices&&a.inArray(b,a.map(e.data.pkchoices,function(a,b){return a[0]}))>=0)return d=e.data.datatype,!1}else{a.each(e.fields,function(c,e){if(e.pk==b)return d=e.datatype,!1;if(e.pkchoices&&a.inArray(b,a.map(e.pkchoices,function(a,b){return a[0]}))>=0)return d=e.datatype,!1});if(d!==null)return!1}}),d}function A(b){var c={};for(var d in b){if(!b.hasOwnProperty(d))continue;var e=q.exec(d);if(e){c.hasOwnProperty(e[2])?a.extend(c[e[2]],{val0:b[d],val1:undefined,op:undefined}):c[e[2]]={val0:b[d],val1:undefined,op:undefined};continue}e=p.exec(d);if(e){c.hasOwnProperty(e[2])?c[e[2]]["val"+e[3]]=Number(b[d])||b[d]:(c[e[2]]={val0:undefined,val1:undefined,op:undefined},c[e[2]]["val"+e[3]]=Number(b[d])||b[d]);continue}e=s.exec(d),e&&(c.hasOwnProperty(e[0])?c[e[0]].pk=b[d]:c[e[0]]={val0:undefined,val1:undefined,op:undefined,pk:b[d]})}for(d in b){if(!b.hasOwnProperty(d))continue;e=r.exec(d),e&&(c[e[2]]||b[d].match(/null/))&&(c.hasOwnProperty(e[2])||(c[e[2]]={val0:undefined,val1:undefined,op:undefined}),c[e[2]].op=b[d])}var f=[];for(var g in c){var h=c[g],i=!1,j=null;s.exec(g)&&(j=g.split("OR"),g=h.pk,i=!0),g=Number(g);if(h.val0===undefined&&h.val1===undefined&&h.op!==undefined)f.push({operator:h.op,id:g,concept_id:l,value:!0,datatype:z(g)});else if(h.val0!==undefined&&h.val1!==undefined&&h.op!==undefined)f.push({operator:h.op,id:g,value:[h.val0,h.val1],concept_id:l,datatype:z(g)});else if(h.val0===undefined||h.op===undefined||h.val0 instanceof Array)if(h.val0!==undefined&&h.val0 instanceof Array){h.op=h.op!==undefined?h.op:"in";var k=z(g);switch(k){case"boolean":case"nullboolean":var n=[],o=u[h.op];a.each(h.val0,function(a,b){n.push({operator:o,id:g,value:w[b]!==undefined?w[b]:b,concept_id:l,datatype:k})}),n.length>1?f.push({type:t.test(h.op)?"and":"or",children:n,concept_id:l}):f.push(n[0]);break;default:f.push({operator:h.op,id:g,value:h.val0,concept_id:l})}}else{if(h.val0===undefined||h.val0 instanceof Array||h.val1!==undefined)throw"Unable to determine field "+h+" in concept "+l;f.push({operator:"exact",id:g,value:h.val0,concept_id:l})}else f.push({operator:h.op,id:g,value:h.val0,concept_id:l,datatype:z(g)});i&&(f[f.length-1].id_choices=j)}var v;return f.length===1?v=f[0]:v={type:m.join_by||"and",children:f,concept_id:l},v}function B(b,c){var d=c||{},e,f;if(!b.hasOwnProperty("type")){b.hasOwnProperty("id_choices")?(f=b.id_choices.join("OR"),d[f]=b.id):f=b.id,e=b.concept_id+"_"+f;if(!b.operator.match(/null/))if(b.datatype in{number:1,date:1}){var g=b.value instanceof Array?b.value:[b.value];for(var h=0;h<g.length;h++)d[e+"_input"+h]=g[h]}else d.hasOwnProperty(e)?d[e]instanceof Array?d[e].push(b.value):(d[e]=[d[e]],d[e].push(b.value)):d[e]=b.value;d[e+"_"+"operator"]=d[e]instanceof Array&&b.datatype&&b.datatype.indexOf("boolean")>=0?v[b.operator]:b.operator}else a.each(b.children,function(a,b){B(b,d)});return d}function C(b,c){m.contents=c;var d=m.contents.dom();g.append(d),d.css("display","block"),a(".chart",m.contents).css("display","block"),m.loaded||(a(c).trigger("UpdateDSEvent",[i[l].ds]),a(c).trigger("RegisterElementsEvent")),a(c).trigger("GainedFocusEvent"),m.loaded=!0}function D(c,e){m!==null&&(m.contents.dom().css("display","none"),a(m.contents).trigger("LostFocusEvent"),m.contents.dom().detach()),m=i[l].views[e];if(m.loaded)C(null,m.contents);else{var f=null;m.concept_id=l,d.fadeIn().trigger("ViewReadyEvent",[new b(m,i[l].name)])}}function E(a,b){}function F(b,c){var d=i[l].ds,e=!1;if(!(c.value instanceof Array||d[c.name]!==c.value))return;if(c.value instanceof Array&&d[c.name]instanceof Array){for(var f=0;f<c.value.length;f++)if(a.inArray(c.value[f],d[c.name])==-1){e=!0;break}if(e===!1&&c.value.length==d[c.name].length)return}c.value===undefined?delete i[l].ds[c.name]:i[l].ds[c.name]=c.value instanceof Array?c.value.slice(0):c.value,a.each(i[l].views,function(a,b){m!==b&&b.contents&&b.contents.trigger("UpdateElementEvent",[c])})}function G(b){var c=!1;if(a.isEmptyObject(b))c=!0;else{c=!0;for(var d in b){if(!b.hasOwnProperty(d))continue;if(r.test(d)){if(b[d]&&b[d].indexOf("isnull")>=0){c=!1;break}}else if(s.test(d)||q.test(d)||p.test(d)){c=!1;break}}}if(c)return!1;for(var d in b){if(!b.hasOwnProperty(d))continue;if(b[d]===undefined||b[d]==="")return!1;if(a.isArray(b[d])&&b[d].length===0)return!1}return!0}function H(b,c){var d;c=c||i[l].ds;if(!c.custom){if(!G(c)){var e=a.Event("InvalidInputEvent");return e.ephemeral=!0,e.message="No value has been specified.",a(b.target).trigger(e),!1}d=A(c)}else d=c;return App.hub.publish("UpdateQueryEvent",d),!0}function I(b){a(m.contents).triggerHandler("UpdateQueryButtonClicked")}function J(b){b.reason=b.reason?"_"+b.reason:"";var c=i[l].invalid_fields,d=a(b.target).attr("name");a.each(i[l].views,function(a,c){c.contents&&c.contents.dom().find("[name="+d+"]").addClass("invalid"+b.reason),c.contents&&c.contents.dom().find("[name="+d+"]").children().addClass("invalid"+b.reason)});var e=b.message?b.message:"This condition contains invalid input. Please correct the above invalid fields.",f=!1;a.each(h.find(".error"),function(g,h){h=a(h);var i=h.data("ref_count");if(h.text()===e){f=!0;if(b.ephemeral)return;if(c[d+b.reason]===undefined)c[d+b.reason]=h,h.data("ref_count",i+1);else if(h.text()!==c[d+b.reason].text()){var j=c[d+b.reason].data("ref_count");c[d+b.reason].data("ref_count",j-1),c[d+b.reason].data("ref_count")===0&&c[d+b.reason].remove(),c[d+b.reason]=h,h.data("ref_count",i+1)}}});if(f)return;var g=a('<div class="message error">'+e+"</div>");g.data("ref_count",1),b.ephemeral||(c[d+b.reason]=g),h.prepend(g);if(b.ephemeral){var j;(j=parseInt(b.ephemeral,10))===NaN&&(j=1e3),setTimeout(function(){g.fadeOut(3e3,function(){g.remove()})},j)}else h.find("#add_to_query").attr("disabled","true")}function K(b){b.reason=b.reason?"_"+b.reason:"";var c=i[l].invalid_fields,d=a(b.target).attr("name");a.each(i[l].views,function(a,c){c.contents&&c.contents.dom().find("[name="+d+"]").removeClass("invalid"+b.reason),c.contents&&c.contents.dom().find("[name="+d+"]").children().removeClass("invalid"+b.reason)});var e=c[d+b.reason].data("ref_count")-1;e===0?c[d+b.reason].remove():c[d+b.reason].data("ref_count",e),delete i[l].invalid_fields[d+b.reason],a.isEmptyObject(i[l].invalid_fields)&&h.find("#add_to_query").removeAttr("disabled")}function L(a,c){c=c||function(){},a.css&&b.loadCss(a.css),a.js?require([a.js],function(b){c(a)}):c(a)}function M(b){b=O(b),l=parseInt(b.id,10),b.globalsLoaded=!0,b.views.length<2?f.hide():f.show();var c=a.jqote(j,b.views);f.html(c),b["static"]?(h.append(b["static"]),n=h.find("#add_to_query")):(h.append(k),n=h.find("#add_to_query"),n.click(function(){var b=a.Event("UpdateQueryButtonClicked");return a(this).trigger(b),!1})),a.inArray(l,o)<0?(n.html('<span class="icon plus"/> <span>Add Condition</span>'),a(".success",h).hide()):(n.html('<span class="icon refresh"/> <span>Update Condition</span>'),a(".success",h).show()),f.children(":first").click()}function N(a,b){var c=f.children().index(b);f.trigger("ShowViewEvent",c)}function O(b){return i[b.id]===undefined?i[b.id]=b:(a.extend(i[b.id],b),b=i[b.id]),b.ds||(b.query?b.query.custom?b.ds=b.query:b.ds=B(b.query):b.ds={}),b.invalid_fields||(b.invalid_fields={}),b}function P(a,b,c,e){d.fadeIn();if(parseInt(a.id,10)===l)return;b&&(a.query=b),l!==null&&(i[l]["static"]=h.children().detach()),i[a.id]&&i[a.id].globalsLoaded?M(a):L(a,M)}var c={},d=a("#plugin-panel"),e=a("#plugin-title"),f=a("#plugin-tabs"),g=a("#plugin-dynamic-content"),h=a("#plugin-static-content"),i={},j='<a class="tab" href="#"><%= this.tabname %></a> ',k=['<button id="add_to_query"></button>','<div class="message success">Added condition</div>'].join(""),l=null,m=null,n=null,o=[],p=/^(\d+)_(\d+(?:OR\d+)*)_input([01])$/,q=/^(\d*)_(\d+(?:OR\d+)*)$/,r=/^(\d*)_(\d+(?:OR\d+)*)_operator$/,s=/^\d+(?:OR\d+)+$/,t=/-/,u={"in":"exact","-in":"-exact",exact:"exact","-exact":"-exact"},v={exact:"in","-exact":"-in"},w={"true":!0,"false":!1,"null":null};return App.hub.subscribe("ConceptAddedEvent",x),App.hub.subscribe("ConceptDeletedEvent",y),d.bind({ViewReadyEvent:C,ViewErrorEvent:E,ShowViewEvent:D,ElementChangedEvent:F,UpdateQueryButtonClicked:I,InvalidInputEvent:J,InputCorrectedEvent:K,ConstructQueryEvent:H}),f.bind("ConceptTabClickedEvent",N),f.tabs(!0,function(a,b){b.trigger("ConceptTabClickedEvent",b)}),{show:P,isConceptLoaded:function(a){return a in i},buildQuery:A,constructQueryHandler:H}})