(function(a){a.fn.optionTree=function(b,e){e=a.extend({choose:"Choose...",show_multiple:false,preselect:{},loading_image:"",select_class:"",leaf_class:"final",empty_value:"",on_each_change:false,set_value_on:"leaf",indexed:false,preselect_only_once:false},e||{});var f=function(i){return i.replace(/_*$/,"")};var c=function(i){a("select[name^='"+i+"']").remove()};var h=function(i,j){a("input[name='"+f(i)+"']").val(j).change()};var d=function(j){var i=this;if(e.loading_image!==""){a("<img>").attr("src",e.loading_image).attr("class","optionTree-loader").insertAfter(i)}a.getJSON(e.lazy_load,{id:j},function(k){a(".optionTree-loader").remove();var l;for(l in k){if(k.hasOwnProperty(l)){a(i).optionTree(k,e);return}}a(i).optionTree(j,e)})};if(typeof e.on_each_change==="string"){e.lazy_load=e.on_each_change;e.on_each_change=d}var g=function(j,i){if(!e.preselect||!e.preselect[j]){return false}if(a.isArray(e.preselect[j])){return a.inArray(i,e.preselect[j])!==-1}return(e.preselect[j]===i)};return this.each(function(){var m=a(this).attr("name")+"_";c(m);if(typeof b==="object"){var l=a("<select>").attr("name",m).change(function(){if(this.options[this.selectedIndex].value!==""){if(a.isFunction(e.on_each_change)){c(m+"_");e.on_each_change.apply(this,[this.options[this.selectedIndex].value,b])}else{a(this).optionTree(b[this.options[this.selectedIndex].value],e)}if(e.set_value_on==="each"){h(m,this.options[this.selectedIndex].value)}}else{c(m+"_");h(m,e.empty_value)}});var k="";if(jQuery.isFunction(e.choose)){var n=a(this).siblings().andSelf().filter("select").length;k=e.choose.apply(this,[n])}else{if(e.choose!==""){k=e.choose}}var i=0;if(k!==""){i++}if(e.show_multiple>1){i=e.show_multiple}else{if(e.show_multiple===true){a.each(b,function(){i++})}}if(i>1){l.attr("size",i)}if(a(this).is("input")){l.insertBefore(this)}else{l.insertAfter(this)}if(e.select_class){l.addClass(e.select_class)}if(k!==""){a("<option>").html(k).val("").appendTo(l)}var j=false;a.each(b,function(q,p){var r,t;if(e.indexed){r=p;t=q}else{r=t=q}var u=a("<option>").html(r).attr("value",t);var s=f(m);if(e.leaf_class&&typeof t!=="object"){u.addClass(e.leaf_class)}u.appendTo(l);if(g(s,t)){u.get(0).selected=true;j=true}});if(j){l.change()}if(!j&&e.preselect_only_once){e.preselect[f(m)]=null}}else{if(e.set_value_on==="leaf"){if(e.indexed){h(m,this.options[this.selectedIndex].value)}else{h(m,b)}}}})}}(jQuery));