

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Database &mdash; GNU MediaGoblin 0.3.3.dev documentation</title>
    
    <link rel="stylesheet" href="../_static/mg.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.3.3.dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="GNU MediaGoblin 0.3.3.dev documentation" href="../index.html" />
    <link rel="next" title="Plugin API" href="api.html" />
    <link rel="prev" title="Quick Start" href="quickstart.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="api.html" title="Plugin API"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="quickstart.html" title="Quick Start"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">GNU MediaGoblin 0.3.3.dev documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="database">
<h1>Database<a class="headerlink" href="#database" title="Permalink to this headline">¶</a></h1>
<div class="section" id="accessing-existing-data">
<h2>Accessing Existing Data<a class="headerlink" href="#accessing-existing-data" title="Permalink to this headline">¶</a></h2>
<p>If your plugin wants to access existing data, this is quite
straight forward. Just import the appropiate models and use
the full power of SQLAlchemy. Take a look at the (upcoming)
database section in the Developer&#8217;s Chapter.</p>
</div>
<div class="section" id="creating-new-tables">
<h2>Creating new Tables<a class="headerlink" href="#creating-new-tables" title="Permalink to this headline">¶</a></h2>
<p>If your plugin needs some new space to store data, you
should create a new table.  Please do not modify core
tables.  Not doing so might seem inefficient and possibly
is.  It will help keep things sane and easier to upgrade
versions later.</p>
<p>So if you create a new plugin and need new tables, create a
file named <tt class="docutils literal"><span class="pre">models.py</span></tt> in your plugin directory. You
might take a look at the core&#8217;s db.models for some ideas.
Here&#8217;s a simple one:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">mediagoblin.db.base</span> <span class="kn">import</span> <span class="n">Base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">Unicode</span><span class="p">,</span> <span class="n">ForeignKey</span>

<span class="k">class</span> <span class="nc">MediaSecurity</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&quot;yourplugin__media_security&quot;</span>

    <span class="c"># The primary key *and* reference to the main media_entry</span>
    <span class="n">media_entry</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;core__media_entries.id&#39;</span><span class="p">),</span>
        <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">get_media_entry</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s">&quot;MediaEntry&quot;</span><span class="p">,</span>
        <span class="n">backref</span><span class="o">=</span><span class="n">backref</span><span class="p">(</span><span class="s">&quot;security_rating&quot;</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="s">&quot;all, delete-orphan&quot;</span><span class="p">))</span>

    <span class="n">rating</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Unicode</span><span class="p">)</span>

<span class="n">MODELS</span> <span class="o">=</span> <span class="p">[</span><span class="n">MediaSecurity</span><span class="p">]</span>
</pre></div>
</div>
<p>That&#8217;s it.</p>
<p>Some notes:</p>
<ul class="simple">
<li>Make sure all your <tt class="docutils literal"><span class="pre">__tablename__</span></tt> start with your
plugin&#8217;s name so the tables of various plugins can&#8217;t
conflict in the database. (Conflicts in python naming are
much easier to fix later).</li>
<li>Try to get your database design as good as possible in
the first attempt.  Changing the database design later,
when people already have data using the old design, is
possible (see next chapter), but it&#8217;s not easy.</li>
</ul>
</div>
<div class="section" id="changing-the-database-schema-later">
<h2>Changing the Database Schema Later<a class="headerlink" href="#changing-the-database-schema-later" title="Permalink to this headline">¶</a></h2>
<p>If your plugin is in use and instances use it to store some
data, changing the database design is a tricky thing.</p>
<ol class="arabic simple">
<li>Make up your mind how the new schema should look like.</li>
<li>Change <tt class="docutils literal"><span class="pre">models.py</span></tt> to contain the new schema. Keep a
copy of the old version around for your personal
reference later.</li>
<li>Now make up your mind (possibly using your old and new
<tt class="docutils literal"><span class="pre">models.py</span></tt>) what steps in SQL are needed to convert
the old schema to the new one.
This is called a &#8220;migration&#8221;.</li>
<li>Create a file <tt class="docutils literal"><span class="pre">migrations.py</span></tt> that will contain all
your migrations and add your new migration.</li>
</ol>
<p>Take a look at the core&#8217;s <tt class="docutils literal"><span class="pre">db/migrations.py</span></tt> for some
good examples on what you might be able to do. Here&#8217;s a
simple one to add one column:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">mediagoblin.db.migration_tools</span> <span class="kn">import</span> <span class="n">RegisterMigration</span><span class="p">,</span> <span class="n">inspect_table</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span>

<span class="n">MIGRATIONS</span> <span class="o">=</span> <span class="p">{}</span>

<span class="nd">@RegisterMigration</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">MIGRATIONS</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_license_preference</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">bind</span><span class="p">)</span>

    <span class="n">security_table</span> <span class="o">=</span> <span class="n">inspect_table</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s">&#39;yourplugin__media_security&#39;</span><span class="p">)</span>

    <span class="n">col</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="s">&#39;security_level&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">)</span>
    <span class="n">col</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">security_table</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo_docs.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Database</a><ul>
<li><a class="reference internal" href="#accessing-existing-data">Accessing Existing Data</a></li>
<li><a class="reference internal" href="#creating-new-tables">Creating new Tables</a></li>
<li><a class="reference internal" href="#changing-the-database-schema-later">Changing the Database Schema Later</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="quickstart.html"
                        title="previous chapter">Quick Start</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="api.html"
                        title="next chapter">Plugin API</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/pluginwriter/database.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="api.html" title="Plugin API"
             >next</a> |</li>
        <li class="right" >
          <a href="quickstart.html" title="Quick Start"
             >previous</a> |</li>
        <li><a href="../index.html">GNU MediaGoblin 0.3.3.dev documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
    <div>

MediaGoblin documentation released into the public domain via <a href="http://creativecommons.org/publicdomain/zero/1.0/">CC0</a>.

    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
    </div>
  </body>
</html>