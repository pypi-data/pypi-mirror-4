define(["jquery","cilantro/define/form","cilantro/define/viewelement","cilantro/vendor/highcharts"],function(a,b,c){var d=c.extend({constructor:function(a,b){this.options={chart:{marginBottom:50,renderTo:null,zoomType:"",events:{}},tooltip:{formatter:null},events:{},plotOptions:{series:{point:{events:{}},events:{click:null}},line:{animation:!0},pie:{dataLabels:{color:"#000000",connectorColor:"#000000",enabled:!0,formatter:function(){return this.point.name}},borderColor:"#000000",borderWidth:2,allowPointSelect:!1,cursor:"pointer",enableMouseTracking:!0,stickyTracking:!1,states:{hover:{brightness:-0.1,enabled:!0}},point:{events:{mouseOver:function(){},mouseOut:function(){}}}},column:{dataLabels:{enabled:!0},allowPointSelect:!1,cursor:"pointer",borderColor:"#303030",borderWidth:1,enableMouseTracking:!0,stickyTracking:!1,states:{hover:{brightness:-0.1,enabled:!0}}}},credits:{enabled:!1},legend:{enabled:!1},title:{text:null},series:[{name:null,data:null}]},this.base(a,b)},gainedFocus:function(){this.chart.xAxis[0].isDirty=!0,this.chart.yAxis[0].isDirty=!0,this.chart.isDirty=!0,this.chart.series[0].isDirty=!0,this.updateChart()},updateChart:function(){}},{SELECTED_BAR_COLOR:"005DA8",UNSELECTED_COLOR:"#C5C5C5",SELECTED_COLOR:"#99BDF1",EXCLUDE_COLOR:"#EE3A43",INCLUDE_COLOR:"#99BDF1",ALTERNATE_GRID_COLOR:"#FDFFD5",MINIMUM_SLICE:.04,map_data_to_display:function(b){var c={};return a.each(b,function(a,b){c[b[0]]=b[1]}),c},map_display_to_data:function(b){var c={};return a.each(b,function(a,b){c[b[1]]=b[0]}),c},nb_plural_to_singular_map:{"in":"exact","-in":"-exact"},nb_singular_to_plural_map:{exact:"in","-exact":"-in"}}),e=d.extend({constructor:function(c,e){this.selected=[];var f=this.map=d.map_data_to_display(c.data.choices),g=this.unmap=d.map_display_to_data(c.data.choices);this.negated=!1,this.range_form=new b({fields:[{datatype:"string",name:c.data.name,choices:c.data.choices,pk:c.data.pk}]},e),this.range_form=this.range_form.dom,this.range_form.find("select[multiple]").hide(),this.range_form.find("input").css("margin","10px"),a.each(c.data.coords,function(a,b){c.data.coords[a][0]=f[c.data.coords[a][0]]}),this.base(c,e)},notify:function(){this.dom.trigger("ElementChangedEvent",[{name:this.concept_pk+"_"+this.viewset.data.pk,value:this.selected}])},elementChanged:function(a,b){if(b.value===null)return;b.value==="in"?this.negated=!1:this.negated=!0,this.updateChart()},updateDS:function(b,c){this.selected=c[this.concept_pk+"_"+this.viewset.data.pk],this.selected===undefined?this.selected=[]:a.isArray(this.selected)||(this.selected=[this.selected]),this.negated=c[this.concept_pk+"_"+this.viewset.data.pk+"_operator"]==="-in",this.range_form.triggerHandler(b,[c])},updateElement:function(a,b){b.name===this.concept_pk+"_"+this.viewset.data.pk?this.selected=b.value:b.name===this.concept_pk+"_"+this.viewset.data.pk+"_operator"&&b.value==="in"?this.negated=!1:this.negated=!0,this.range_form.triggerHandler(a,[b])},updateChart:function(){var b=this;a.map(this.chart.series[0].data,function(c,d){var e=c.name||c.category;a.inArray(b.unmap[e],b.selected)!==-1?b.negated?c.update({color:b.EXCLUDE_COLOR},!1):c.update({color:b.SELECTED_COLOR},!1):c.update({color:b.UNSELECTED_COLOR},!1)}),this.chart.redraw(),a.map(this.chart.series[0].data,function(b,c){a(b.tracker.element).mouseover(),a(b.tracker.element).mouseout()})},seriesClick:function(b){var c=b.point.category||b.point.name,d=a.inArray(this.unmap[c],this.selected);d===-1?(this.negated?b.point.update({color:this.EXCLUDE_COLOR}):b.point.update({color:this.SELECTED_COLOR}),this.selected.push(this.unmap[c])):(b.point.update({color:this.UNSELECTED_COLOR}),this.selected.splice(d,1)),this.notify(),this.updateChart(),this.chart.hoverPoint=b.point,this.chart.hoverSeries=b.point.series}}),f=e.extend({constructor:function(b,c){var e=b.data.coords,f=this.data_store={};a.each(e,function(a,b){f[b[0]]=b[1]});var g=0;a.each(e,function(a,b){g+=b[1]});var h=g*d.MINIMUM_SLICE;a.each(e,function(a,b){b[1]<h&&(b[1]=h)}),this.base(b,c)},render:function(){this.dom=a('<div class="chart"></div>'),this.options.chart.renderTo=this.dom.get(0);var b=this;this.options.tooltip.formatter=function(){return""+b.data_store[b.unmap[this.point.name]]},this.options.series[0].type="pie",this.options.series[0].name=this.viewset.data.title,this.options.series[0].data=this.viewset.data.coords,this.options.title.text=this.viewset.data.title,this.options.plotOptions.series.events.click=a.proxy(this.seriesClick,this),this.chart=new Highcharts.Chart(this.options)},gainedFocus:function(a){this.base(),this.negated=!1},SELECTED_COLOR:d.SELECTED_COLOR,UNSELECTED_COLOR:d.UNSELECTED_COLOR,EXCLUDE_COLOR:d.EXCLUDE_COLOR}),g=e.extend({render:function(){var b=this;this.dom=a('<div class="chart"></div>'),this.options.chart.marginBottom=this.viewset.data.coords.length>6?100:50,this.options.chart.renderTo=this.dom.get(0),this.options.chart.defaultSeriesType="column",this.options.chart.events.redraw=a.proxy(this.redraw,this),this.options.chart.events.load=a.proxy(this.load,this),this.options.plotOptions.series.events.click=a.proxy(this.seriesClick,this),this.options.title.text=this.viewset.data.title,this.options.series[0].name=this.viewset.data.title,this.options.series[0].data=a.map(this.viewset.data.coords,function(a,b){return a[1]}),this.options.tooltip={formatter:function(){return this.point.category+", "+this.y}},this.options.xAxis={categories:a.map(this.viewset.data.coords,function(a,b){return a[0]}),title:{text:this.viewset.data.xaxis,margin:this.viewset.data.coords.length>6?90:50},labels:{align:this.viewset.data.coords.length>6?"left":"center",y:this.viewset.data.coords.length>6?10:20,rotation:this.viewset.data.coords.length>6?50:0,formatter:function(){var a=this.value;return b.viewset.data.coords.length>6?a.length>20&&(a=a.substr(0,18)+".."):a=this.value.split(" ").join("<br/>"),a}}},this.options.yAxis={min:0,title:{text:this.viewset.data.yaxis},labels:{rotation:45}},this.chart=new Highcharts.Chart(this.options)},redraw:function(b){for(var c=0;c<this.chart.series[0].data.length;c++){var d=this.chart.series[0].data[c];a(d.dataLabel.element).unbind(),a(d.dataLabel.element).attr("fill",d.color),a(d.dataLabel.element).css("color",d.color),a(d.dataLabel.element).hover(function(b){a(this).css("cursor","pointer")},function(b){a(this).css("cursor","")});var e=this;a(d.dataLabel.element).click(function(b){return function(c){b.series.chart.hoverPoint=b,b.series.chart.isDirty=!0;var d=a.inArray(e.unmap[b.category],e.selected);d===-1?e.selected.push(e.unmap[b.category]):e.selected.splice(d,1),e.notify(),e.updateChart()}}(d))}},SELECTED_COLOR:d.SELECTED_BAR_COLOR,UNSELECTED_COLOR:"#999999"}),h=d.extend({constructor:function(c,d){var e=this.range_form=(new b({fields:[c.data]},d)).dom;this.base(c,d);var f=this.extremes=this.chart.xAxis[0].getExtremes(),g=f.max-f.min,h=1/3*g;a("input[name*=input0]",e).val((f.min+h).toFixed(1)),a("input[name*=input1]",e).val((f.min+2*h).toFixed(1)),this.range_form.bind("ElementChangedEvent",a.proxy(this.manual_field_handler,this)),this.manual_field_handler(null)},render:function(){this.range_form.find("input").css("margin","10px");var b=a('<div class="chart"></div>'),c=this.dom=a('<div class="chart"></div>');c.append(b),this.options.chart.renderTo=b.get(0),this.options.chart.defaultSeriesType="line",this.options.chart.zoomType="x",this.options.title.text=this.viewset.data.title,this.options.chart.events.selection=a.proxy(this.chartSelection,this),this.options.chart.events.click=a.proxy(this.chartClick,this),this.options.plotOptions.series.point.events.click=a.proxy(this.pointClick,this),this.options.series[0].name=this.viewset.data.title,this.options.series[0].data=this.viewset.data.coords,this.options.tooltip.formatter=function(){return""+this.y},this.options.xAxis={maxPadding:.05,startOnTick:!1,title:{text:this.viewset.data.xaxis},labels:{align:"center",y:20}},this.options.yAxis={min:0,title:{style:{fontWeight:"bold"},text:this.viewset.data.yaxis,rotation:270},labels:{rotation:45}},this.chart=new Highcharts.Chart(this.options),this.dom.append(this.range_form)},manual_field_handler:function(b){var c=null,e=this.chart.options,f=parseFloat(a("input[name*=input0]",this.range_form).val()).toFixed(1),g=parseFloat(a("input[name*=input1]",this.range_form).val()).toFixed(1);switch(this.range_form.find("select[name*=operator]").val()){case"range":c=d.INCLUDE_COLOR;case"-range":c=c||d.EXCLUDE_COLOR,e.chart.zoomType!=="x"&&(this.range_form.detach(),this.chart.destroy(),e.chart.zoomType="x",e.plotOptions.line.animation=!1,this.chart=new Highcharts.Chart(e),this.dom.append(this.range_form)),this.chart.xAxis[0].removePlotBand(),f&&g&&this.chart.xAxis[0].addPlotBand({from:f,to:g,color:c}),this.dom.trigger("ShowDependentsEvent");break;case"lt":c=d.INCLUDE_COLOR,e.chart.zoomType!==""&&(this.range_form.detach(),this.chart.destroy(),e.chart.zoomType="",e.plotOptions.line.animation=!1,this.chart=new Highcharts.Chart(e),this.dom.append(this.range_form)),this.chart.xAxis[0].removePlotBand(),f&&(this.chart.xAxis[0].addPlotLine({value:f,color:d.EXCLUDE_COLOR,width:3}),this.chart.xAxis[0].addPlotBand({from:this.extremes.min,to:f,color:c})),this.dom.trigger("ShowDependentsEvent");break;case"gt":c=d.INCLUDE_COLOR,e.chart.zoomType!==""&&(this.range_form.detach(),this.chart.destroy(),e.chart.zoomType="",e.plotOptions.line.animation=!1,this.chart=new Highcharts.Chart(e),this.dom.append(this.range_form)),this.chart.xAxis[0].removePlotBand(),f&&(this.chart.xAxis[0].addPlotLine({value:f,color:d.EXCLUDE_COLOR,width:3}),this.chart.xAxis[0].addPlotBand({from:f,to:this.extremes.max,color:c})),this.dom.trigger("ShowDependentsEvent");break;case"lte":c=d.INCLUDE_COLOR,e.chart.zoomType!==""&&(this.range_form.detach(),this.chart.destroy(),e.chart.zoomType="",e.plotOptions.line.animation=!1,this.chart=new Highcharts.Chart(e),this.dom.append(this.range_form)),this.chart.xAxis[0].removePlotBand(),f&&this.chart.xAxis[0].addPlotBand({from:this.extremes.min,to:f,color:c}),this.dom.trigger("ShowDependentsEvent");break;case"gte":c=d.INCLUDE_COLOR,e.chart.zoomType!==""&&(this.range_form.detach(),this.chart.destroy(),e.chart.zoomType="",e.plotOptions.line.animation=!1,this.chart=new Highcharts.Chart(e),this.dom.append(this.range_form)),this.chart.xAxis[0].removePlotBand(),f&&this.chart.xAxis[0].addPlotBand({from:f,to:this.extremes.max,color:c}),this.dom.trigger("ShowDependentsEvent");break;case"exact":c=d.INCLUDE_COLOR,e.chart.zoomType!==""&&(this.range_form.detach(),this.chart.destroy(),e.chart.zoomType="",e.plotOptions.line.animation=!1,this.chart=new Highcharts.Chart(e),this.dom.append(this.range_form)),this.chart.xAxis[0].removePlotBand(),f&&this.chart.xAxis[0].addPlotLine({value:f,color:d.INCLUDE_COLOR,width:3}),this.dom.trigger("ShowDependentsEvent");break;case"-exact":c=d.INCLUDE_COLOR,e.chart.zoomType!==""&&(this.range_form.detach(),this.chart.destroy(),e.chart.zoomType="",e.plotOptions.line.animation=!1,this.chart=new Highcharts.Chart(e),this.dom.append(this.range_form)),this.chart.xAxis[0].removePlotBand(),f&&this.chart.xAxis[0].addPlotLine({value:f,color:d.EXCLUDE_COLOR,width:3}),this.dom.trigger("ShowDependentsEvent");break;case"isnull":c=d.EXCLUDE_COLOR,e.chart.zoomType!==""&&(this.range_form.detach(),this.chart.destroy(),e.chart.zoomType="",e.plotOptions.line.animation=!1,this.chart=new Highcharts.Chart(e),this.dom.append(this.range_form)),this.chart.xAxis[0].removePlotBand(),this.chart.xAxis[0].addPlotLine({from:this.extremes.min,to:this.extremes.max,color:c}),this.dom.trigger("HideDependentsEvent");break;case"-isnull":e.chart.zoomType!==""&&(this.range_form.detach(),this.chart.destroy(),e.chart.zoomType="",e.plotOptions.line.animation=!1,this.chart=new Highcharts.Chart(e),this.dom.append(this.range_form)),this.dom.trigger("ShowDependentsEvent"),this.chart.xAxis[0].removePlotBand()}},updateDSEvent:function(a,b){this.range_form.triggerHandler(a,[b])},elementChanged:function(){},updateElement:function(a,b){this.range_form.triggerHandler(a,[b])},registerElements:function(b){a("select",this.range_form).change()},gainedFocus:function(a){this.base(),this.range_form.triggerHandler(a)},chartSelection:function(b){var c=b.target,d=this.range_form.find("select[name*=operator]").val()==="-range"?h.EXCLUDE_COLOR:h.INCLUDE_COLOR,e=b.xAxis[0].min,f=b.xAxis[0].max;e=e<this.extremes.min?this.extremes.min:e,f=f>this.extremes.max?this.extremes.max:f,e=parseFloat(e).toFixed(1),f=parseFloat(f).toFixed(1),a("input[name*=input0]",this.range_form).val(e).change(),a("input[name*=input1]",this.range_form).val(f).change(),b.preventDefault()},chartClick:function(b){var c=b.target;if(this.chart.options.chart.zoomType)return;var d=b.xAxis[0].value;d=d<this.extremes.min?this.extremes.min:d,d=parseFloat(d).toFixed(1),a("input[name*=input0]",this.range_form).val(d).change()},pointClick:function(b){if(this.chart.options.chart.zoomType)return;var c=b.target.x;c=c<this.extremes.min?this.extremes.min:c,c=parseFloat(c).toFixed(1),a("input[name*=input0]",this.range_form).val(c).change()}});return{BarChart:g,LineChart:h,PieChart:f}})