{% macro format_task(task) %}
{% if task["due"] %}
<b>{{task["due"] | format_date}}:</b>
{% endif %}
{{task["description"] | e}}
{{ label(task) }}
{% endmacro %}

{% macro label(task) %}
    {% if task["urgency"]|float > 5 %}
        <span class="label label-warning">Urgent</span>
    {% endif %}
    {% if task["priority"] and task["priority"] == 'H' %}
        <span class="label label-important">Important</span>
    {% endif %}
{% endmacro %}

<!doctype html>
<html>
    <head>
        <style>
            h2 {
                padding-right: 20px;
                padding-top:10px;
                padding-bottom: 10px;
                padding-left: 20px;
                background-color: #fafafa;
                background-image: -moz-linear-gradient(top, #FFFFFF, #F2F2F2);
                background-image: -webkit-gradient(linear, 0 0, 0 100%, from(#ffffff), to(#f2f2f2));
                background-image: -webkit-linear-gradient(top, #ffffff, #f2f2f2);
                background-image: -o-linear-gradient(top, #ffffff, #f2f2f2);
                background-image: linear-gradient(to bottom, #ffffff, #f2f2f2);
                background-repeat: repeat-x;
                border: 1px solid #d4d4d4;
                -webkit-border-radius: 4px;
                -moz-border-radius: 4px;
                border-radius: 4px;
                *zoom: 1;
                -webkit-box-shadow: 0 1px 4px rgba(0, 0, 0, 0.065);
                -moz-box-shadow: 0 1px 4px rgba(0, 0, 0, 0.065);
                box-shadow: 0 1px 4px rgba(0, 0, 0, 0.065);
            }

            ul{
                padding-left: 2em;
            }

            table ul{
                list-style: none;
                padding-left: 0px;
            }

            .label {
                font-size: 11.844px;
                font-weight: bold;
                line-height: 14px;
                color: #ffffff;
                text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
                white-space: nowrap;
                vertical-align: baseline;
                background-color: #999999;
                padding: 1px 4px 2px;
                -webkit-border-radius: 3px;
                -moz-border-radius: 3px;
                border-radius: 3px;
            } 

            .label-warning {
                background-color: #b94a48;
            }
            
            .label-important {
                background-color: #f89406;
            }

            table {
                max-width: 100%;
                background-color: transparent;
                border-collapse: collapse;
                border-spacing: 0;
                width: 100%;
                margin-bottom: 20px;
            }

            th, td {
                padding: 8px;
                border-top: 1px solid #DDDDDD;
                line-height: 20px;
                text-align: left;
                vertical-align: top;
            }

            th {
                font-weight: bold;
                background-color: #B4B9EF;
                border-bottom: 1px solid #333333;
            }

            .table-striped tbody tr:nth-child(odd) td, 
            .table-striped tbody tr:nth-child(odd) th {
                background-color: #FCF8E3; 
            }

            .table-bordered {
                border: 1px solid #dddddd;
                border-collapse: separate;
                *border-collapse: collapse;
                border-left: 0;
                -webkit-border-radius: 4px;
                -moz-border-radius: 4px;
                border-radius: 4px;
            }

            .table-bordered th,
            .table-bordered td {
                border-left: 1px solid #dddddd;
            }

            body{
                background-color: #F0EFE7;
                /*background-color: #CEDCFF;*/
            }

            #container {
                background-color: #F0EFE7;
                /*background-color: #CEDCFF;*/
            }

            #inside-container {
                background-color: #FFFFFF;
                border: 1px solid #E2E0D8;
                border-radius: 4px 4px 4px 4px;
                color: #4E443C;
                line-height: 130%;
                padding: 2.5em;
                margin: 2em auto;
                width: 80%
            }
        </style>
        <meta charset="utf-8" />
        <title>Task report</title>
    </head>
    <body>
        <div id="container">
            <div id="inside-container">
        {% for section in section_list %}
        <h2>{{ section["title"] | e}}</h2>
        {% if section["title"] == "Emails" %}
            {% for grouper, list in section["task_list"] | groupby("project") %}
                <h3>{{grouper | e}}</h3>
                    <ul>
                    {% for task in list %}
                    <li> {{ format_task(task)}} </li>
                    {% endfor %}
                  </ul>
            {% endfor %}
        {% elif section["title"] == "Coding" %}
            <h3>Bugs</h3>
            <ul>
            {% for task in section["task_list"] if "bug" in task["tags"] %}
                <li>{{ format_task(task) }}</li>
            {% endfor %}
            </ul>
            <h3>Feature requests</h3>
            <ul>
            {% for task in section["task_list"] if "feature" in task["tags"] %}
                <li>{{ format_task(task) }}</li>
            {% endfor %}
            </ul>
            <h3>Packaging</h3>
            <ul>
            {% for task in section["task_list"] if "packaging" in task["tags"] %}
                <li>{{ format_task(task) }}</li>
            {% endfor %}
            </ul>
        {% elif section["title"] == "Recommendations" %}
        <table class="table-bordered">
            <tr>
                <th>Books</th><th>Movies</th><th>Music</th>
            </tr>
            <tr>
                {% for column in ["book", "movie", "music"] %}
                <td>
                <ul>
                {% for task in section["task_list"] if column in task["tags"] %}
                    <li> {{task["description"] | e}} </li>
                {% endfor %}
                </ul>
                </td>
                {% endfor %}
            </tr>
        </table>
        {% else %}
        <ul>
            {% for task in section["task_list"] %}
            <li>{{format_task(task)}}</li>
            {% endfor %}
        </ul>
        {% endif %}
        {% endfor %}
    </div>
</div>
    </body>
</html>
