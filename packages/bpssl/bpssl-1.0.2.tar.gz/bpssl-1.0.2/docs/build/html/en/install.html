

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>1. Installation &mdash; bpssl 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/theme_extras.js"></script>
    <link rel="top" title="bpssl 1.0 documentation" href="index.html" />
    <link rel="next" title="2. Limiting access to secure requests" href="usage.html" />
    <link rel="prev" title="bpssl Documentation" href="index.html" /> 
  </head>
  <body>
      <div class="header"><img class="rightlogo" src="_static/beproud.png" alt="Logo"/><h1 class="heading"><a href="index.html">
          <span>bpssl 1.0 documentation</span></a></h1>
        <h2 class="heading"><span>1. Installation</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="index.html">bpssl Documentation</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="usage.html">2. Limiting access to secure requests</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="installation">
<h1>1. Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h1>
<div class="section" id="application-install">
<h2>1.1. Application Install<a class="headerlink" href="#application-install" title="Permalink to this headline">¶</a></h2>
<p>Installing bpssl is easy, but there are some non-obvious
steps for setting up your web server that you will need to do to get
it working.</p>
<p>First install the <tt class="docutils literal"><span class="pre">bpssl</span></tt> package using PIP:</p>
<div class="highlight-python"><pre>$ pip install bpssl</pre>
</div>
<p>or easy_install:</p>
<div class="highlight-python"><pre>$ easy_install bpssl</pre>
</div>
<p>Next add <tt class="docutils literal"><span class="pre">'beproud.django.ssl'</span></tt> to your <a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/settings/#installed-apps">INSTALLED_APPS</a> in your <tt class="docutils literal"><span class="pre">settings.py</span></tt>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;django.contrib.auth&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.contenttypes&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.sessions&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.sites&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.messages&#39;</span><span class="p">,</span>
    <span class="c"># ...</span>
    <span class="s">&#39;beproud.django.ssl&#39;</span><span class="p">,</span>
    <span class="c"># ...</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="context-processor-setup">
<h2>1.2. Context Processor Setup<a class="headerlink" href="#context-processor-setup" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="beproud.django.ssl.context_processors.conf">
<tt class="descclassname">beproud.django.ssl.context_processors.</tt><tt class="descname">conf</tt><big>(</big><big>)</big><a class="headerlink" href="#beproud.django.ssl.context_processors.conf" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Add the <a class="reference internal" href="#beproud.django.ssl.context_processors.conf" title="beproud.django.ssl.context_processors.conf"><tt class="xref py py-func docutils literal"><span class="pre">beproud.django.ssl.context_processors.conf()</span></tt></a> context processor to
your <a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/settings/#template-context-processors">TEMPLATE_CONTEXT_PROCESSORS</a> setting.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">TEMPLATE_CONTEXT_PROCESSORS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="c">#...</span>
    <span class="s">&#39;beproud.django.ssl.context_processors.conf&#39;</span><span class="p">,</span>
    <span class="c">#...</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="middleware-setup">
<h2>1.3. Middleware Setup<a class="headerlink" href="#middleware-setup" title="Permalink to this headline">¶</a></h2>
<p>Add <tt class="docutils literal"><span class="pre">'beproud.django.ssl.middleware.SSLRedirectMiddleware'</span></tt> to your <a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/settings/#middleware-classes">MIDDLEWARE_CLASSES</a> setting.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">MIDDLEWARE_CLASSES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;django.middleware.common.CommonMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.sessions.middleware.SessionMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.middleware.csrf.CsrfViewMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.auth.middleware.AuthenticationMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.messages.middleware.MessageMiddleware&#39;</span><span class="p">,</span>
    <span class="c"># ...</span>
    <span class="s">&#39;beproud.django.ssl.middleware.SSLRedirectMiddleware&#39;</span><span class="p">,</span>
    <span class="c"># ...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>If using a HTTP proxy you will need to add
<tt class="docutils literal"><span class="pre">'beproud.django.ssl.middleware.SSLProxyMiddleware'</span></tt> to <a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/settings/#middleware-classes">MIDDLEWARE_CLASSES</a>.
<tt class="docutils literal"><span class="pre">SSLProxyMiddleware</span></tt> should be added as early as possible in your <a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/settings/#middleware-classes">MIDDLEWARE_CLASSES</a>
setting.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">MIDDLEWARE_CLASSES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;beproud.django.ssl.middleware.SSLProxyMiddleware&#39;</span><span class="p">,</span>
    <span class="c"># ...</span>
    <span class="s">&#39;django.middleware.common.CommonMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.sessions.middleware.SessionMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.middleware.csrf.CsrfViewMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.auth.middleware.AuthenticationMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.messages.middleware.MessageMiddleware&#39;</span><span class="p">,</span>
    <span class="c"># ...</span>
    <span class="s">&#39;beproud.django.ssl.middleware.SSLRedirectMiddleware&#39;</span><span class="p">,</span>
    <span class="c"># ...</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="web-server-setup">
<span id="install-web-server-setup"></span><h2>1.4. Web Server Setup<a class="headerlink" href="#web-server-setup" title="Permalink to this headline">¶</a></h2>
<p>Because SSL decoding and encoding is done by the web server, it&#8217;s impossible for a
Django application to know whether a request is secure or not unless the web server
tells it. In order to pass that information to the Django application some setup on
the webserver is usually necessary. In particular because <tt class="docutils literal"><span class="pre">beproud.django.ssl</span></tt>
relies on the <a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/request-response/#django.http.HttpRequest.is_secure">request.is_secure()</a> method we need to get <a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/request-response/#django.http.HttpRequest.is_secure">request.is_secure()</a>
to return the right results.</p>
<div class="section" id="nginx-fastcgi">
<h3>1.4.1. nginx/FastCGI<a class="headerlink" href="#nginx-fastcgi" title="Permalink to this headline">¶</a></h3>
<p>When using nginx and FastCGI it&#8217;s sufficient to set the information in a
<tt class="docutils literal"><span class="pre">fastcgi_param</span></tt>. Setting the fastcgi parameter <tt class="docutils literal"><span class="pre">HTTPS</span></tt> to <tt class="docutils literal"><span class="pre">on</span></tt> will tell the
flup server that the request is a secure request. Flup will then wrap the request
accordingly, setting the <tt class="docutils literal"><span class="pre">wsgi.url_scheme</span></tt> to <tt class="docutils literal"><span class="pre">https</span></tt> and making
<a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/request-response/#django.http.HttpRequest.is_secure">request.is_secure()</a> return the correct value.</p>
<div class="highlight-nginx"><div class="highlight"><pre><span class="k">location</span> <span class="s">/</span> <span class="p">{</span>
    <span class="kn">include</span>                 <span class="s">/etc/nginx/fastcgi_params</span><span class="p">;</span>
    <span class="kn">fastcgi_pass</span>            <span class="s">upstream</span><span class="p">;</span>
    <span class="kn">fastcgi_param</span>           <span class="s">HTTPS</span> <span class="no">on</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="nginx-http-proxy">
<h3>1.4.2. nginx/HTTP proxy<a class="headerlink" href="#nginx-http-proxy" title="Permalink to this headline">¶</a></h3>
<p>When using nginx as a HTTP reverse proxy you will need to pass information about
whether a request is secure or not in an HTTP header. In order to avoid falling
victim to man in the middle attacks where an attacker could cause data that
should be sent over a secure channel to be sent over an unsecure
channel, nginx will need to set or strip this header for non-secure requests.</p>
<p>Set the name and value of the header to the value you set in the
<a class="reference internal" href="settings.html#setting-ssl-request-header"><em>SSL_REQUEST_HEADER</em></a> setting in order to use it
in conjunction with the
<a class="reference internal" href="usage.html#beproud.django.ssl.middleware.SSLProxyMiddleware" title="beproud.django.ssl.middleware.SSLProxyMiddleware"><tt class="xref py py-class docutils literal"><span class="pre">SSLProxyMiddleware</span></tt></a>.</p>
<div class="highlight-nginx"><div class="highlight"><pre><span class="c1">#HTTP</span>
<span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
        <span class="kn">proxy_pass</span>          <span class="s">http://myproxy</span><span class="p">;</span>

        <span class="c1"># We need to set this header for HTTP requests as well</span>
        <span class="c1"># so that we won&#39;t fall victim to man-in-the-middle attacks.</span>
        <span class="kn">proxy_set_header</span> <span class="s">X_FORWARDED_PROTOCOL</span>      <span class="s">&quot;http&quot;</span><span class="p">;</span>
        <span class="c1"># ...</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># HTTPS</span>
<span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">443</span><span class="p">;</span>
    <span class="kn">ssl</span> <span class="no">on</span><span class="p">;</span>
    <span class="c1"># ...</span>
    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
        <span class="kn">proxy_pass</span>          <span class="s">http://myproxy</span><span class="p">;</span>
        <span class="c1"># This should be set to the same headeras the</span>
        <span class="c1"># non-ssl setup above.</span>
        <span class="kn">proxy_set_header</span>    <span class="s">X_FORWARDED_PROTOCOL</span>   <span class="s">https</span><span class="p">;</span>
        <span class="c1"># ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="apache-fastcgi">
<h3>1.4.3. Apache/FastCGI<a class="headerlink" href="#apache-fastcgi" title="Permalink to this headline">¶</a></h3>
<p>With Apache/FastCGI you can setting the HTTPS environment variable should be sufficient to
get <a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/request-response/#django.http.HttpRequest.is_secure">request.is_secure()</a> to work in a FastCGI environment. You can add the environment
variable to FastCGI using the Apache rewrite module like so:</p>
<div class="highlight-apache"><div class="highlight"><pre><span class="nt">&lt;VirtualHost</span> <span class="s">*:443</span><span class="nt">&gt;</span>
    <span class="nb">SSLEngine</span> <span class="k">on</span>
    <span class="c"># ...</span>

    <span class="nb">RewriteEngine</span> <span class="k">on</span>
    <span class="nb">RewriteCond</span> %{HTTPS} <span class="k">on</span>
    <span class="nb">RewriteRule</span> .* - [E=HTTPS:on]

    <span class="c"># ...</span>
<span class="nt">&lt;/VirtualHost&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="apache-mod-wsgi">
<h3>1.4.4. Apache/mod_wsgi<a class="headerlink" href="#apache-mod-wsgi" title="Permalink to this headline">¶</a></h3>
<p>In an Apache/mod_wsgi setup where HTTPS is handled by the same server, mod_wsgi will
set the <tt class="docutils literal"><span class="pre">wsgi.url_scheme</span></tt> environment variable appropriately and
<a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/request-response/#django.http.HttpRequest.is_secure">request.is_secure()</a> should return the correct value without any special setup.</p>
</div>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="index.html">bpssl Documentation</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="usage.html">2. Limiting access to secure requests</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2010, BeProud Inc..
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>