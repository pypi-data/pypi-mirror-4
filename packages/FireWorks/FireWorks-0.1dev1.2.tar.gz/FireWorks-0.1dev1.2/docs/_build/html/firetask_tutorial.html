
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Defining Jobs using FireTasks &mdash; FireWorks 0.1dev1.2 documentation</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.1dev1.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="FireWorks 0.1dev1.2 documentation" href="index.html" />
    <link rel="prev" title="Launch Rockets through a queue" href="queue_tutorial.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="queue_tutorial.html" title="Launch Rockets through a queue"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">FireWorks 0.1dev1.2 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="defining-jobs-using-firetasks">
<h1>Defining Jobs using FireTasks<a class="headerlink" href="#defining-jobs-using-firetasks" title="Permalink to this headline">¶</a></h1>
<p>In the <a class="reference internal" href="installation_tutorial.html"><em>installation tutorial</em></a>, we ran a simple script that performed <tt class="docutils literal"><span class="pre">echo</span> <span class="pre">&quot;howdy,</span> <span class="pre">your</span> <span class="pre">job</span> <span class="pre">launched</span> <span class="pre">successfully!&quot;</span> <span class="pre">&gt;&gt;</span> <span class="pre">howdy.txt&quot;</span></tt>. Looking inside <tt class="docutils literal"><span class="pre">fw_test.yaml</span></tt>, you might have noticed that command defined within a task labeled <tt class="docutils literal"><span class="pre">Subprocess</span> <span class="pre">Task</span></tt>:</p>
<div class="highlight-python"><pre>fw_id: -1
spec:
  _tasks:
  - _fw_name: Subprocess Task
    parameters:
      script: echo "howdy, your job launched successfully!" &gt;&gt; howdy.txt
      use_shell: true</pre>
</div>
<p>The <tt class="docutils literal"><span class="pre">Subprocess</span> <span class="pre">Task</span></tt> is one type of <em>FireTask</em>, which is a predefined job template written in Python. The <tt class="docutils literal"><span class="pre">Subprocess</span> <span class="pre">Task</span></tt> is Python code that runs an arbitrary shell script that you give it, so you can use the <tt class="docutils literal"><span class="pre">SubProcess</span> <span class="pre">Task</span></tt> to run almost any job (without worrying that it&#8217;s all done within a Python layer). In this section, we&#8217;ll demonstrate how to use and define FireTasks.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In this tutorial, we will run examples on the central server for simplicity. One could just as easily run them on a FireWorker if you&#8217;ve set one up.</p>
</div>
<div class="section" id="running-multiple-firetasks">
<h2>Running multiple FireTasks<a class="headerlink" href="#running-multiple-firetasks" title="Permalink to this headline">¶</a></h2>
<p>You can run multiple tasks within the same FireWork. For example, the first step of your FireWork might write an input file that the second step processes. Let&#8217;s create a FireWork where the first step prints <tt class="docutils literal"><span class="pre">howdy.txt</span></tt>, and the second step counts the number of words in that file.</p>
<ol class="arabic">
<li><p class="first">Navigate to the tasks tutorial directory:</p>
<div class="highlight-python"><pre>cd &lt;INSTALL_DIR&gt;/fw_tutorials/firetask</pre>
</div>
</li>
<li><p class="first">Look inside the file <tt class="docutils literal"><span class="pre">fw_multi.yaml</span></tt>. You should see two <tt class="docutils literal"><span class="pre">Subprocess</span> <span class="pre">Task</span></tt>; the second one runs the <tt class="docutils literal"><span class="pre">wc</span> <span class="pre">-w</span></tt> command to count the number of characters in <tt class="docutils literal"><span class="pre">howdy.txt</span></tt> and exports the result to <tt class="docutils literal"><span class="pre">words.txt</span></tt>:</p>
<div class="highlight-python"><pre>fw_id: -1
spec:
  _tasks:
  - _fw_name: Subprocess Task
    parameters:
      script: echo "howdy, your job launched successfully!" &gt; howdy.txt
      use_shell: true
  - _fw_name: Subprocess Task
    parameters:
      script: wc -w &lt; howdy.txt &gt; words.txt
      use_shell: true
launch_data: []</pre>
</div>
</li>
<li><p class="first">Run this multi-step FireWork on the central server:</p>
<div class="highlight-python"><pre>launchpad_run.py initialize &lt;TODAY'S DATE&gt;
launchpad_run.py insert_single_fw fw_multi.yaml
rocket_run.py</pre>
</div>
</li>
</ol>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">You can run all three of these commands on a single line by separating them with a semicolon. This will allow you to reset the database, insert a FW, and run it within a single command.</p>
</div>
<p>You should see two files written out to the system, <tt class="docutils literal"><span class="pre">howdy.txt</span></tt> and <tt class="docutils literal"><span class="pre">words.txt</span></tt>, confirming that you successfully ran a two-step job!</p>
</div>
<div class="section" id="using-subprocesstask">
<h2>Using SubprocessTask<a class="headerlink" href="#using-subprocesstask" title="Permalink to this headline">¶</a></h2>
<p>While running arbitrary shell scripts is nice, it&#8217;s not particularly well-organized. The command (<tt class="docutils literal"><span class="pre">echo</span></tt>), its arguments (<tt class="docutils literal"><span class="pre">&quot;howdy,</span> <span class="pre">your</span> <span class="pre">job</span> <span class="pre">launched</span> <span class="pre">successfully!&quot;</span></tt>), and its output (<tt class="docutils literal"><span class="pre">howdy.txt</span></tt>) are all intermingled within the same line. If we separated these components, it would be easier to do a data-parallel task where the same commands are run for multiple arguments. Let&#8217;s explore a better way to define our multi-step job:</p>
<ol class="arabic">
<li><p class="first">Staying in the firetasks tutorial directory, remove any output from the previous step:</p>
<div class="highlight-python"><pre>rm howdy.txt fw.json</pre>
</div>
</li>
<li><p class="first">Look inside the file <tt class="docutils literal"><span class="pre">fw_better_multi.yaml</span></tt>. You should see two FireTasks as before. However, this time, the text we are printing is separated into its own <tt class="docutils literal"><span class="pre">echo_text</span></tt> parameter. We just need to change the value of this parameter in order to perform the same commands (<tt class="docutils literal"><span class="pre">echo</span></tt> and <tt class="docutils literal"><span class="pre">wc</span></tt>) on different input data. Note also that the names of the input and output files are also clearly separated from the commands themselves within the FireWork specification:</p>
<div class="highlight-python"><pre>fw_id: -1
spec:
  _tasks:
  - _fw_name: Subprocess Task
    parameters:
      script: cat -t
      stdin_key: echo_text
      stdout_file: howdy.txt
  - _fw_name: Subprocess Task
    parameters:
      script: wc -w
      stdin_file: howdy.txt
      stdout_file: words.txt
  echo_text: howdy, your job launched successfully!
launch_data: []</pre>
</div>
</li>
<li><p class="first">Run the FireWork on the central server to confirm that this new formulation also works as intended:</p>
<div class="highlight-python"><pre>launchpad_run.py initialize &lt;TODAY'S DATE&gt;
launchpad_run.py insert_single_fw fw_better_multi.yaml
rocket_run.py</pre>
</div>
</li>
</ol>
<p>At this point, you might want to change the <tt class="docutils literal"><span class="pre">echo_text</span></tt> parameter, reinsert the FireWork, and re-run the Rocket. Your custom text should get printed to <tt class="docutils literal"><span class="pre">howdy.txt</span></tt> and the number of words should change appropriately.</p>
</div>
<div class="section" id="creating-a-custom-firetask">
<h2>Creating a custom FireTask<a class="headerlink" href="#creating-a-custom-firetask" title="Permalink to this headline">¶</a></h2>
<p>Because the <tt class="docutils literal"><span class="pre">Subprocess</span> <span class="pre">Task</span></tt> can run arbitrary shell scripts, it can in theory run any type of job and is an &#8216;all-encompassing&#8217; FireTask. However, if you are comfortable with some basic Python, it is better to define your own custom FireTasks (job templates) for the codes you run. A custom FireTask can clarify the usage of your code and guard against unintended behavior by restricting the commands that can be executed.</p>
<p>Even if you plan to only use <tt class="docutils literal"><span class="pre">Subprocess</span> <span class="pre">Task</span></tt>, we suggest that you still read through the next portion before continuing with the tutorial. We&#8217;ll be creating a custom FireTask that adds one or more numbers using Python&#8217;s <tt class="docutils literal"><span class="pre">sum()</span></tt> function, and later building workflows with this FireTask:</p>
<ol class="arabic">
<li><p class="first">Navigate to the tasks tutorial directory and remove any output from the previous step:</p>
<div class="highlight-python"><pre>cd &lt;INSTALL_DIR&gt;/fw_tutorials/firetask
rm howdy.txt fw.json</pre>
</div>
</li>
<li><p class="first">Look inside the file <tt class="docutils literal"><span class="pre">fw_adder.yaml</span></tt> for a new FireWork definition. This FireWork references a new FireTask, <tt class="docutils literal"><span class="pre">Addition</span> <span class="pre">Task</span></tt>, that adds the numbers <tt class="docutils literal"><span class="pre">1</span></tt> and <tt class="docutils literal"><span class="pre">2</span></tt>:</p>
<div class="highlight-python"><pre>fw_id: -1
spec:
  _tasks:
  - _fw_name: Addition Task
    parameters: {}
  input_array:
  - 1
  - 2
launch_data: []</pre>
</div>
</li>
<li><p class="first">Look inside the file <tt class="docutils literal"><span class="pre">addition_task.py</span></tt> which defines the <tt class="docutils literal"><span class="pre">Addition</span> <span class="pre">Task</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AdderTask</span><span class="p">(</span><span class="n">FireTaskBase</span><span class="p">,</span> <span class="n">FWSerializable</span><span class="p">):</span>

   <span class="n">_fw_name</span> <span class="o">=</span> <span class="s">&quot;Addition Task&quot;</span>

   <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw</span><span class="p">):</span>
       <span class="n">input_array</span> <span class="o">=</span> <span class="n">fw</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s">&#39;input_array&#39;</span><span class="p">]</span>
       <span class="n">m_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">input_array</span><span class="p">)</span>

       <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;sum_output.txt&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
           <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;The sum of {} is: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">input_array</span><span class="p">,</span> <span class="n">m_sum</span><span class="p">))</span>
</pre></div>
</div>
</li>
<li><dl class="first docutils">
<dt>It should be clear how the <tt class="docutils literal"><span class="pre">Addition</span> <span class="pre">Task</span></tt> is set up:</dt>
<dd><ol class="first loweralpha simple">
<li>the reserved <tt class="docutils literal"><span class="pre">fw_name</span></tt> parameter is set to <tt class="docutils literal"><span class="pre">Addition</span> <span class="pre">Task</span></tt>, which is how FireWorks knows to use this code when an <tt class="docutils literal"><span class="pre">Addition</span> <span class="pre">Task</span></tt> is specified inside the <tt class="docutils literal"><span class="pre">fw_adder.yaml</span></tt> FireWork file.</li>
<li>the <tt class="docutils literal"><span class="pre">run_task()</span></tt> method is the code that gets executed by the Rocket. In this case, we sum the values in the field called <tt class="docutils literal"><span class="pre">input_array</span></tt>, and write the output to <tt class="docutils literal"><span class="pre">sum_output.txt</span></tt>. In our <tt class="docutils literal"><span class="pre">fw_adder.yaml</span></tt> file, the <tt class="docutils literal"><span class="pre">input_array</span></tt> was set to <tt class="docutils literal"><span class="pre">1</span></tt> and <tt class="docutils literal"><span class="pre">2</span></tt>.</li>
</ol>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The main method in <tt class="docutils literal"><span class="pre">addition_task.py</span></tt> is not necessary to define a FireTask. However, it demonstrates how we created the <tt class="docutils literal"><span class="pre">fw_adder.yaml</span></tt> file.</p>
</div>
</dd>
</dl>
</li>
</ol>
<ol class="arabic" start="4">
<li><p class="first">Run the FireWork on the central server to confirm that the <tt class="docutils literal"><span class="pre">Addition</span> <span class="pre">Task</span></tt> works:</p>
<div class="highlight-python"><pre>launchpad_run.py initialize &lt;TODAY'S DATE&gt;
launchpad_run.py insert_single_fw fw_adder.yaml
rocket_run.py</pre>
</div>
</li>
</ol>
</div>
<div class="section" id="next-up-workflows">
<h2>Next up: Workflows!<a class="headerlink" href="#next-up-workflows" title="Permalink to this headline">¶</a></h2>
<p>With custom FireTasks, you can now go beyond running shell commands and execute arbitrary Python code templates. Furthermore, these templates can operate on dynamic input from the <tt class="docutils literal"><span class="pre">spec</span></tt> of the FireWork. For example, the <tt class="docutils literal"><span class="pre">Addition</span> <span class="pre">Task</span></tt> used the <tt class="docutils literal"><span class="pre">input_array</span></tt> from the spec to decide what numbers to add.</p>
<p>While one could construct an entire workflow by chaining together FireTasks within a single FireWork, this is often not ideal. For example, we might want to switch between different FireWorkers for different parts of the workflow depending on the computing requirements for each step. Or, we might have a restriction on walltime that necessitates breaking up the workflow into more atomic steps. Finally, we might want to employ complex branching logic or error-correction that would be cumbersome to employ within a single FireWork. The next step in the tutorial is to explore connecting together FireWorks into a true <em>workflow</em>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Defining Jobs using FireTasks</a><ul>
<li><a class="reference internal" href="#running-multiple-firetasks">Running multiple FireTasks</a></li>
<li><a class="reference internal" href="#using-subprocesstask">Using SubprocessTask</a></li>
<li><a class="reference internal" href="#creating-a-custom-firetask">Creating a custom FireTask</a></li>
<li><a class="reference internal" href="#next-up-workflows">Next up: Workflows!</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="queue_tutorial.html"
                        title="previous chapter">Launch Rockets through a queue</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/firetask_tutorial.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="queue_tutorial.html" title="Launch Rockets through a queue"
             >previous</a> |</li>
        <li><a href="index.html">FireWorks 0.1dev1.2 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Anubhav Jain.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>