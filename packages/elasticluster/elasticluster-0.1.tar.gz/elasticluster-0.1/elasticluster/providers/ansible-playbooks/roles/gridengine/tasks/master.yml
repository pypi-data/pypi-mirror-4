---
- name: Install GridEngine APT packages
  action: apt pkg=$item state=latest
  only_if: $is_ubuntu
  with_items:
    - gridengine-client
    - gridengine-common
    - gridengine-master
    - gridengine-qmon

- name: add the frontend as submission host
  action: shell qconf -as ${groups.gridengine_master[0]}
  ignore_errors: yes

- name: upload configuration file for host
  action: template src=gridengine/templates/newhost.qconf.j2 dest="/root/${item}.conf"
  with_items: ${groups.gridengine_clients}

- name: add execution hosts
  action: shell qconf -Ae "/root/${item}.conf"
  with_items: ${groups.gridengine_clients}
  ignore_errors: yes

- name: upload configuration file for hostgroup
  action: template src=gridengine/templates/allhosts.grp.conf.j2 dest=/root/allhosts.grp.conf
  ignore_errors: yes
  tags:
    - sge

- name: add default group
  action: shell qconf -Ahgrp /root/allhosts.grp.conf
  ignore_errors: yes

# - name: add hosts to the default hostgroup
#   action: shell qconf -aattr hostgroup hostlist $item @allhosts
#   with_items: ${groups.gridengine_clients}
#   ignore_errors: yes
#   tags:
#     - sge

- name: deploy default configuration for main queue
  action: copy src=gridengine/files/all.q.conf dest=/root/all.q.conf
  tags:
    - sge

- name: create default queue
  action: shell qconf -Aq /root/all.q.conf
  ignore_errors: yes
  tags:
    - sge

- name: add hosts to the default queue
  action: shell qconf -aattr queue hostlist @allhosts all.q
  ignore_errors: yes
  tags:
    - sge
