define(["jquery","cilantro/define/viewelement","order!vendor/jquery.jqote2"],function(a,b){var c=['<option selected id="<%=this.field_id%>" value="range">is between</option>','<option id="<%=this.field_id%>" value="-range">is not between</option>','<option id="<%=this.field_id%>" value="lt">is less than</option>','<option id="<%=this.field_id%>" value="gt">is greater than</option>','<option id="<%=this.field_id%>" value="lte">is less than or equal to</option>','<option id="<%=this.field_id%>" value="gte">is greater than or equal to</option>','<option id="<%=this.field_id%>" value="exact">is equal to</option>','<option id="<%=this.field_id%>" value="-exact">is not equal to</option>','<option id="<%=this.field_id%>" value="isnull">is null</option>','<option id="<%=this.field_id%>" value="-isnull">is not null</option>'],d=['<option selected value="in">is equal to</option>','<option value="-in">is not equal to</option>'],e=['<option selected value="iexact">is equal to</option>','<option value="-iexact">is not equal to</option>','<option value="in">is one of</option>','<option value="-in">is not one of</option>','<option value="icontains">contains</option>','<option value="-icontains">does not contain</option>'],f=b.extend({constructor:function(b,c){this.base(b,c),a('input[data-validate="date"]',this.dom).datepicker({changeMonth:!0,changeYear:!0})},render:function(){var b={nullboolean:f.nullboolean_tmpl,"boolean":f.boolean_tmpl,date:f.number_tmpl,number:f.number_tmpl,string:f.string_tmpl,"string-list":f.stringlist_tmpl},c=this.dom=a('<span class="form_container"></span>'),d=this.concept_pk;a.each(this.viewset.fields,function(e,g){var h=[b[g.datatype]];h.unshift(a.jqotec("<p>")),h.push(a.jqotec("</p>")),g.hasOwnProperty("pk")||h.push(f.pk_tmpl),a.each(["choices","pkchoices"],function(b,c){g[c]&&a.each(g[c],function(a,b){g[c][a][0]===null&&(g[c][a][0]="null"),g[c][a][1]==="None"&&(g[c][a][1]="No Data")})});var i=null,j=null;if(g.hasOwnProperty("pk"))i=d+"_"+g.pk;else{var k=a.map(g.pkchoices,function(a,b){return parseInt(a[0])});k.sort(),j=k.join("OR"),i=d+"_"+j}var l=a(a.jqote(h,{datatype:g.datatype,choices:g.choices,field_id:i,label:g.name,pkchoices:g.pkchoices,pkchoice_label:g.pkchoice_label,pkchoice_id:j,optional:g.hasOwnProperty("optional")?g.optional:!1,"default":g.hasOwnProperty("default")?g["default"]:0,pkchoice_default:g.hasOwnProperty("pkchoice_default")?g.pkchoice_default:0}));l.children().not("span").wrap("<span/>"),c.append(l)})},elementChanged:function(b){var c=a(b.target);if(!a.contains(this.dom.get(0),c.get(0)))return;var d,e,g=this.dom,h=this;switch(b.target.type){case"checkbox":d=b.target.checked,d=c.is(":visible")&&c.is(":enabled")?d:undefined,g.trigger("ElementChangedEvent",[{name:b.target.name,value:d}]);break;case"select-one":case"select-multiple":case"select":var i=[],j=null,k=f.opRe.exec(c.attr("name"));k&&(j=a("[name^="+k[1]+"_"+k[2]+"]",g).not(c).not("span")),a("option",a(b.target)).each(function(b,c){if(c.selected){i.push(c.value);var d={decimal:1,number:1,date:1};if(j&&j.attr("data-validate")in d)c.value.search(/range/)<0?c.value.search(/null/)<0?(a("input[name="+c.id+"_input1],",g).hide().change(),a("label[for="+c.id+"_input1]",g).hide(),a("input[name="+c.id+"_input0]",g).show().change()):(a("input[name="+c.id+"_input1],",g).hide().change(),a("label[for="+c.id+"_input1]",g).hide(),a("input[name="+c.id+"_input0]",g).hide().change()):(a("input[name="+c.id+"_input1]",g).show().change(),a("label[for="+c.id+"_input1]",g).show(),a("input[name="+c.id+"_input0]",g).show().change());else if(j&&j.prop("type")in{text:1,textarea:1})if(c.value.search(/^-?in$/)<0&&j.prop("type")==="textarea")j.data("switch").data("switch",j),j.before(j.data("switch")).detach(),j.data("switch").keyup();else if(c.value.search(/^-?in$/)>=0&&j.prop("type")==="text")if(!j.data("switch")){var f=a('<textarea rows="8" id="'+j.attr("id")+'" name="'+j.attr("name")+'"></textarea>').data("switch",j);j.before(f).detach(),e=g.data("datasource")||{},e[j.attr("name")]instanceof Array?h.updateElement(null,{name:j.attr("name"),value:e[j.attr("name")]}):typeof e[j.attr("name")]=="string"?h.updateElement(null,{name:j.attr("name"),value:[e[j.attr("name")]]}):h.updateElement(null,{name:j.attr("name"),value:[]}),f.keyup()}else j.data("switch").data("switch",j),j.before(j.data("switch")).detach(),j.data("switch").keyup()}});if(b.target.type==="select-multiple"){var l=[],m=i.length;for(var n=0;n<m;n++){var o=i[n];l.push(o in f.s_to_primative_map?f.s_to_primative_map[o]:o)}d=l}else d=i[0]in f.s_to_primative_map?f.s_to_primative_map[i[0]]:i[0];c.is("[data-optional=true]")&&(d=a.type(d)in{string:1,array:1}&&d.length===0?undefined:d),d=this.state==="INIT"&&c.css("display")!=="none"||c.is(":visible")&&c.is(":enabled")?d:undefined,g.trigger("ElementChangedEvent",[{name:b.target.name,value:d}]);break;case"textarea":d=this.state==="INIT"&&c.css("display")!=="none"||c.is(":visible")&&c.is(":enabled")?c.val().split("\n"):undefined,g.trigger("ElementChangedEvent",[{name:b.target.name,value:d}]);break;default:var p=a(b.target).closest("p").find("select").val(),q=b.target.name.substr(0,b.target.name.length-1);switch(c.attr("data-validate")){case"number":case"decimal":case"date":var r=c.attr("data-validate"),s=a("input[name="+q+"0]",g),t=a("input[name="+q+"1]",g),u;if(r==="date")var v=new Date(s.val()),w=new Date(t.val());else var v=parseFloat(s.val()),w=parseFloat(t.val());r!=="date"&&c.is(":visible")&&isNaN(Number(c.val()))?(u=a.Event("InvalidInputEvent"),c.trigger(u)):a(b.target).hasClass("invalid")?(u=a.Event("InputCorrectedEvent"),c.trigger(u)):p.search(/range/)>=0&&v>w?(u=a.Event("InvalidInputEvent"),u.reason="badrange",u.message="First input must be less than second input.",c.parent().trigger(u)):a(b.target).parent().hasClass("invalid_badrange")&&(t.css("display")==="none"||v<w)&&(u=a.Event("InputCorrectedEvent"),u.reason="badrange",c.parent().trigger(u));break;default:}d=this.state==="INIT"&&c.css("display")!=="none"||c.is(":visible")&&c.is(":enabled")?c.val():undefined,g.trigger("ElementChangedEvent",[{name:b.target.name,value:d}])}b.stopPropagation()},updateElement:function(b,c){var d=a("[name="+c.name+"]",this.dom);if(d.length===0)return;var e=d.prop("type");switch(e){case"checkbox":d.attr("checked",c.value);break;case"select-multiple":var f=a.isArray(c.value)?c.value:[c.value];a("option",d).each(function(b,c){var d=a.map(f,function(a,b){return typeof a in{string:1,number:1}?a:String(a)});a.inArray(c.value,d)!=-1?c.selected=!0:c.selected=!1});break;case"textarea":d.val(c.value.join("\n"));break;default:if(a.isArray(c.value))break;d.attr("value",typeof c.value in{string:1,number:1}?c.value:String(c.value))}}},{s_to_primative_map:{"true":!0,"false":!1,"null":null},opRe:/^(\d*)_(\d+(?:OR\d+)*)_operator$/,nullboolean_tmpl:a.jqotec(['<label for="<%=this.field_id%>"><%=this.label%></label>','<select data-datatype="nullboolean"data-optional="<%=this.optional%>"  multiple id ="<%=this.field_id%>" name="<%=this.field_id%>">','<option <%=this["default"]===true?"selected":""%> value="true">Yes</option>','<option <%=this["default"]===false?"selected":""%> value="false">No</option>','<option <%=this["default"]===null?"selected":""%> value="null">No Data</option>',"</select>"].join("")),boolean_tmpl:a.jqotec(["<%if (this.optional) {%>",'<label for="<%=this.field_id%>"><%=this.label%></label>','<select data-datatype="boolean" data-optional="<%=this.optional%>" id ="<%=this.field_id%>" name="<%=this.field_id%>">','<option value="">No Preference</option>','<option <%=this["default"]===true?"selected":""%> value="true">Yes</option>','<option <%=this["default"]===false?"selected":""%> value="false">No</option>',"</select>","<%} else {%>",'<input type="checkbox" name="<%=this.field_id%>" value="<%=this.field_id%>" <%= this["default"] ? "checked":""%>/>','<label for="<%=this.field_id%>"><%=this.label%></label>',"<%}%>"].join("")),number_tmpl:a.jqotec(['<label for="<%=this.field_id%>"><%=this.label%></label>','<select id="<%=this.field_id%>_operator" name="<%=this.field_id%>_operator">',c.join(""),"</select>",'<span class="input_association" name="<%=this.field_id%>_input_assoc">','<input data-validate="<%=this.datatype%>" id="<%=this.field_id%>_input0" type="text" name="<%=this.field_id%>_input0">',' <label for="<%=this.field_id%>_input1">and</label> ','<input data-validate="<%=this.datatype%>" id="<%=this.field_id%>_input1" type="text" name="<%=this.field_id%>_input1">',"</span>"].join("")),string_tmpl:a.jqotec(["<% if (this.choices) {%>",'<label for="<%=this.field_id%>"><%=this.label%></label>','<select id="<%=this.field_id%>-operator" name="<%=this.field_id%>_operator">',d.join(""),"</select>",'<select multiple="multiple" id="<%=this.field_id%>-value" name="<%=this.field_id%>" data-optional="<%=this.optional%>" >',"<% for (var index = 0; index < this.choices.length; index++) { %>",'<option value="<%=this.choices[index][0]%>"><%=this.choices[index][1]%></option>',"<%}%>","</select>","<%} else {%>",'<label for="<%=this.field_id%>"><%=this.label%></label>','<select id="<%=this.field_id%>-operator" name="<%=this.field_id%>_operator">',e.join(""),"</select>",'<input data-optional="<%=this.optional%>" type="text" id="<%=this.field_id%>_text" name="<%=this.field_id%>">',"<%}%>"].join("")),stringlist_tmpl:a.jqotec(['<label for="<%=this.field_id%>"><%=this.label%></label>','<select id="<%=this.field_id%>-operator" name="<%=this.field_id%>_operator">',d.join(""),"</select>",'<textarea data-optional="<%=this.optional%>" id="<%=this.field_id%>_text" name="<%=this.field_id%>"></textarea>'].join("")),pk_tmpl:a.jqotec(['<p><label for="<%=this.pkchoice_id%>"><%=this.pkchoice_label%></label>','<select id="<%=this.pkchoice_id%>" name="<%=this.pkchoice_id%>">',"<% for (index in this.pkchoices) { %>",'<option value="<%=this.pkchoices[index][0]%>" <%=this.pkchoices[index][0]==this.pkchoice_default ? "selected":""%>><%=this.pkchoices[index][1]%></option>',"<%}%>","</select></p>"].join(""))});return f})