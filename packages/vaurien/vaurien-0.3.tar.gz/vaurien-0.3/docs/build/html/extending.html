

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Writing Handlers &mdash; Vaurien 0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Vaurien 0.1 documentation" href="index.html" />
    <link rel="next" title="Keep-alive vs Disconnect" href="keepalive.html" />
    <link rel="prev" title="Handlers" href="handlers.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="keepalive.html" title="Keep-alive vs Disconnect"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="handlers.html" title="Handlers"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Vaurien 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="writing-handlers">
<span id="extending"></span><h1>Writing Handlers<a class="headerlink" href="#writing-handlers" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Before reading this section, make sure you read <a class="reference internal" href="keepalive.html#keep"><em>Keep-alive vs Disconnect</em></a></p>
</div>
<p>Creating new handlers is done by implementing a class with a specific
signature:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">vaurien.handlers</span> <span class="kn">import</span> <span class="n">Handler</span>

<span class="k">class</span> <span class="nc">MySuperHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;super&#39;</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_sock</span><span class="p">,</span> <span class="n">backend_sock</span><span class="p">,</span> <span class="n">to_backend</span><span class="p">):</span>
        <span class="c"># do something here</span>
        <span class="k">return</span> <span class="bp">True</span>


<span class="n">Handler</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">MySuperHandler</span><span class="p">)</span>
</pre></div>
</div>
<p>Vaurien can use this handler and call it everytime data is being seen on one hand
or the other.</p>
<p>You must call <strong>Handler.register</strong> against your class is order to add it
to the list of the available plugins.</p>
<p>Let&#8217;s see the different attributes and options we have in this class:</p>
<ul class="simple">
<li><strong>name</strong> - the name under which your backend is known</li>
<li><strong>options</strong> - a mapping containing your handler options</li>
<li><strong>client_sock</strong> - the socket opened with the client</li>
<li><strong>backend_sock</strong> - the socket opened with the backend server</li>
<li><strong>to_backend</strong> - a boolean giving the direction of the call. If True
it means some data is available in the client socket, that is supposed
to go to the backend. If False, it means data is available on the backend
socket and should be tramsmitted back to the client.</li>
</ul>
<p>For the handler options, each option is defined in the <strong>options</strong> mapping.
The key is the option name and the value is a 3-tuple providing:</p>
<ul class="simple">
<li>a description</li>
<li>a type</li>
<li>a default value</li>
</ul>
<p><strong>every option is optional and need a default value</strong></p>
<p>Everytime a handler is used, it gets two extra attributes:</p>
<ul class="simple">
<li><strong>settings</strong> - the settings loaded for the handler</li>
<li><strong>proxy</strong> - the proxy instance</li>
</ul>
<div class="section" id="the-basehandler-class">
<h2>The BaseHandler class<a class="headerlink" href="#the-basehandler-class" title="Permalink to this headline">¶</a></h2>
<p>XXX</p>
</div>
<div class="section" id="full-handler-example">
<h2>Full handler example<a class="headerlink" href="#full-handler-example" title="Permalink to this headline">¶</a></h2>
<p>Here is how the <cite>delay</cite> handler is specified:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">vaurien.handlers.base</span> <span class="kn">import</span> <span class="n">BaseHandler</span>


<span class="k">class</span> <span class="nc">Dummy</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dummy handler.</span>

<span class="sd">    Every incoming data is passed to the backend with no alteration,</span>
<span class="sd">    and vice-versa.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;dummy&#39;</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;keep_alive&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&quot;Keep-alive protocol&quot;</span><span class="p">,</span>
                            <span class="nb">bool</span><span class="p">,</span> <span class="bp">False</span><span class="p">),</span>
            <span class="s">&#39;reuse_socket&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&quot;If True, the socket is reused.&quot;</span><span class="p">,</span>
                                <span class="nb">bool</span><span class="p">,</span> <span class="bp">False</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_sock</span><span class="p">,</span> <span class="n">backend_sock</span><span class="p">,</span> <span class="n">to_backend</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="n">backend_sock</span><span class="p">,</span> <span class="n">to_backend</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">dest</span> <span class="o">=</span> <span class="n">to_backend</span> <span class="ow">and</span> <span class="n">backend_sock</span> <span class="ow">or</span> <span class="n">client_sock</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">to_backend</span> <span class="ow">and</span> <span class="n">client_sock</span> <span class="ow">or</span> <span class="n">backend_sock</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="c"># If we are not keeping the connection alive</span>
            <span class="c"># we can suck the answer back and close the socket</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s">&#39;keep_alive&#39;</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">dest</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">source</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">_closed</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">to_backend</span><span class="p">:</span>
            <span class="c"># We want to close the socket if the backend sock is empty</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s">&#39;reuse_socket&#39;</span><span class="p">):</span>
                <span class="n">backend_sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">backend_sock</span><span class="o">.</span><span class="n">_closed</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="n">data</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="using-handlers">
<h2>Using handlers<a class="headerlink" href="#using-handlers" title="Permalink to this headline">¶</a></h2>
<p>Once the handler is ready, you can point it to Vaurien
by providing its fully qualified name - e.g. the class name prefixed
by the module and package(s) names.</p>
<p>Then you can use it with the <strong>&#8211;behavior</strong> option:</p>
<div class="highlight-python"><pre>$ vaurien --proxy localhost:8000 --backend google.com:80 \
    --behavior 20:path.to.the.callable \
    --handler-delay-sleep 2</pre>
</div>
<p>Or by using a configuration file:</p>
<div class="highlight-python"><pre>[vaurien]
behavior = 20:foobar

[handler:foobar]
callable = path.to.the.callable
foo=bar</pre>
</div>
<p>And calling Vaurien with &#8211;config:</p>
<div class="highlight-python"><pre>$ vaurien --config config.ini</pre>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Writing Handlers</a><ul>
<li><a class="reference internal" href="#the-basehandler-class">The BaseHandler class</a></li>
<li><a class="reference internal" href="#full-handler-example">Full handler example</a></li>
<li><a class="reference internal" href="#using-handlers">Using handlers</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="handlers.html"
                        title="previous chapter">Handlers</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="keepalive.html"
                        title="next chapter">Keep-alive vs Disconnect</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/extending.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="keepalive.html" title="Keep-alive vs Disconnect"
             >next</a> |</li>
        <li class="right" >
          <a href="handlers.html" title="Handlers"
             >previous</a> |</li>
        <li><a href="index.html">Vaurien 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Mozilla.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>