

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>2. セキュアリクエストでしかアクセスできないように制限をかける &mdash; bpssl 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/translations.js"></script>
    <script type="text/javascript" src="_static/theme_extras.js"></script>
    <link rel="top" title="bpssl 1.0 documentation" href="index.html" />
    <link rel="next" title="3. settings – bpssl 設定" href="settings.html" />
    <link rel="prev" title="1. インストール" href="install.html" /> 
  </head>
  <body>
      <div class="header"><img class="rightlogo" src="_static/beproud.png" alt="Logo"/><h1 class="heading"><a href="index.html">
          <span>bpssl 1.0 documentation</span></a></h1>
        <h2 class="heading"><span>2. セキュアリクエストでしかアクセスできないように制限をかける</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="install.html">1. インストール</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">コンテンツ</a>
        &#160;&#160;::&#160;&#160;
        <a href="settings.html">3. <tt class="docutils literal docutils literal"><span class="pre">settings</span></tt> &#8211; bpssl 設定</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="id1">
<h1>2. セキュアリクエストでしかアクセスできないように制限をかける<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="section" id="url">
<h2>2.1. URLでアクセスを制限する<a class="headerlink" href="#url" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>セキュアURLにアクセスを制限する方法の一つは、URLでアクセスを制限することです。
こと方法で、一部のURLでアクセスを制限することができます。</p>
<p>例えば、ユーザーアカウント関連ページを全部 HTTPS で制限したい場合は、
<tt class="docutils literal"><span class="pre">/accounts/</span></tt> で始まるURLを制限することができます。同じく、購入や、決済
の <tt class="docutils literal"><span class="pre">/payment/</span></tt> で始まるURLを制限することができます。</p>
<div class="section" id="sslredirectmiddleware">
<h3>2.1.1. SSLRedirectMiddleware を利用<a class="headerlink" href="#sslredirectmiddleware" title="このヘッドラインへのパーマリンク">¶</a></h3>
<dl class="class">
<dt id="beproud.django.ssl.middleware.SSLRedirectMiddleware">
<em class="property">class </em><tt class="descclassname">beproud.django.ssl.middleware.</tt><tt class="descname">SSLRedirectMiddleware</tt><a class="headerlink" href="#beproud.django.ssl.middleware.SSLRedirectMiddleware" title="この定義へのパーマリンク">¶</a></dt>
<dd></dd></dl>

<p><tt class="docutils literal"><span class="pre">SSLRedirectMiddleware</span></tt> を利用すれば、全サイトにセキュアリクエストの制限をかけることができます。</p>
<p><tt class="docutils literal"><span class="pre">SSLRedirectMiddleware</span></tt> で <a class="reference internal" href="settings.html#setting-ssl-urls"><em>SSL_URLS</em></a> という設定を利用し、
ある URL は SSL でアクセスするかどうかが決まります。 <a class="reference internal" href="settings.html#setting-ssl-urls"><em>SSL_URLS</em></a>
を <tt class="docutils literal"><span class="pre">settings.py</span></tt> に設定します。 <a class="reference internal" href="settings.html#setting-ssl-urls"><em>SSL_URLS</em></a> は <a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/request-response/#django.http.HttpRequest.path_info">request.path_info</a> で定義されている URL にマッチする正規表現のリストになります。 いずれかの正規表現がと
マッチした場合、その URL はセキュアURLとして処理します。 例えば、以下の設定によって、
<tt class="docutils literal"><span class="pre">http://www.example.com/login/</span></tt> という URL でアクセスが来た場合、
<a class="reference internal" href="settings.html#setting-ssl-urls"><em>SSL_URLS</em></a> の正規表現にマッチしたため、 ユーザーは
<tt class="docutils literal"><span class="pre">https://www.example.com/login/</span></tt> にリダイレクトされます。正規表現にマッチする
URL は <tt class="docutils literal"><span class="pre">urls.py</span></tt> と違って、 &#8216;/&#8217; 文字から始まりますので、ご注意ください。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">SSL_URLS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;^/login/&#39;</span><span class="p">,</span>
    <span class="s">&#39;^/purchase/&#39;</span>
    <span class="c"># ...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>HTTP でも、 HTTPSでも、アクセスできるようにしたい場合は、
<a class="reference internal" href="settings.html#setting-ssl-ignore-urls"><em>SSL_IGNORE_URLS</em></a> に設定できます。例えば、
静的ファイルや、国際化 javascript は HTTP でも、HTTPSでも、
アクセスする必要がある場合が多い。 <a class="reference internal" href="settings.html#setting-ssl-ignore-urls"><em>SSL_IGNORE_URLS</em></a>
の書き方は <a class="reference internal" href="settings.html#setting-ssl-urls"><em>SSL_URLS</em></a> の書き方と一緒です。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">SSL_IGNORE_URLS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;^/i18n_js$&#39;</span><span class="p">,</span>
    <span class="s">&#39;^/static/&#39;</span><span class="p">,</span>
    <span class="c"># ...</span>
<span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#beproud.django.ssl.middleware.SSLRedirectMiddleware" title="beproud.django.ssl.middleware.SSLRedirectMiddleware"><tt class="xref py py-class docutils literal"><span class="pre">SSLRedirectMiddleware</span></tt></a>
は以下のように作動します:</p>
<ul class="simple">
<li>リクエストURLが <a class="reference internal" href="settings.html#setting-ssl-ignore-urls"><em>SSL_IGNORE_URLS</em></a> にマッチした場合、
何もしないで、処理が終わる。</li>
<li>リクエスト URL が <a class="reference internal" href="settings.html#setting-ssl-urls"><em>SSL_URLS</em></a> にマッチし、リクエストが HTTP
で来ている場合、HTTPS URLにリダイレクトする。</li>
<li>リクエスト URL が <a class="reference internal" href="settings.html#setting-ssl-urls"><em>SSL_URLS</em></a> にマッチしないで、
リクエストが HTTPS で来ている場合、HTTP URLにリダイレクトする。</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">ノート</p>
<p class="last">HTTPS で HTTP ページにアクセスすると、セキュリティが普段より高くて、
問題が無いのですが、セキュアでないページに HTTPS でアクセスすると、
HTTP 用のページにリダイレクトするのは、複数のページに同じコンテンツが
出来てしまい、検索エンジンの混乱、 <a class="reference external" href="http://ja.wikipedia.org/wiki/REST">REST</a> のルールを破ることを
避けるための操作です。</p>
</div>
</div>
</div>
<div class="section" id="id2">
<h2>2.2. ビューでアクセスを制限する<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>ビューでセキュアアクセス制限をかける場合もあります。複数のURLで同じビューで
アクセスする場合もあり、ある機能へのアクセスを制限したい場合があります。
その場合、URLでアクセス制限をかけるのに合わないでしょう。</p>
<div class="section" id="id3">
<h3>2.2.1. 生真面目なやり方<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>複数のURLで同じビューへアクセスする場合があるので、ビューでセキュアアクセス制限
に対応すると以下のようになります。生真面目なやり方は、ビューの中に
<a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/request-response/#django.http.HttpRequest.is_secure">request.is_secure()</a> でリクエストがセキュアかどうかをチェックします:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">get_host</span>

<span class="k">def</span> <span class="nf">my_secure_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">is_secure</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s">&quot;https://</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">get_host</span><span class="p">(</span><span class="n">request</span><span class="p">),</span> <span class="n">request</span><span class="o">.</span><span class="n">get_full_path</span><span class="p">()))</span>
    <span class="c"># ...</span>
</pre></div>
</div>
<p>しかし、このやり方でやりますと、
<a class="reference internal" href="#beproud.django.ssl.middleware.SSLRedirectMiddleware" title="beproud.django.ssl.middleware.SSLRedirectMiddleware"><tt class="xref py py-class docutils literal"><span class="pre">SSLRedirectMiddleware</span></tt></a>
はこのビューがセキュアかどうかがわかる用がなく、URLを
<a class="reference internal" href="settings.html#setting-ssl-ignore-urls"><em>SSL_IGNORE_URLS</em></a> に追加しないと、
当ビューの処理と眩みます。</p>
</div>
<div class="section" id="ssl-view">
<h3>2.2.2. ssl_view デコレーター<a class="headerlink" href="#ssl-view" title="このヘッドラインへのパーマリンク">¶</a></h3>
<dl class="function">
<dt id="beproud.django.ssl.decorators.ssl_view">
<tt class="descclassname">beproud.django.ssl.decorators.</tt><tt class="descname">ssl_view</tt><big>(</big><big>)</big><a class="headerlink" href="#beproud.django.ssl.decorators.ssl_view" title="この定義へのパーマリンク">¶</a></dt>
<dd></dd></dl>

<p>ショートカットとして、あるビューはセキュアビューであることを指定するために
<a class="reference internal" href="#beproud.django.ssl.decorators.ssl_view" title="beproud.django.ssl.decorators.ssl_view"><tt class="xref py py-func docutils literal"><span class="pre">ssl_view()</span></tt></a>
を使うことができます:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">beproud.django.ssl.decorators</span> <span class="kn">import</span> <span class="n">ssl_view</span>

<span class="nd">@ssl_view</span>
<span class="k">def</span> <span class="nf">my_secure_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p><a class="reference internal" href="#beproud.django.ssl.decorators.ssl_view" title="beproud.django.ssl.decorators.ssl_view"><tt class="xref py py-func docutils literal"><span class="pre">ssl_view()</span></tt></a>
は <a class="reference internal" href="#beproud.django.ssl.middleware.SSLRedirectMiddleware" title="beproud.django.ssl.middleware.SSLRedirectMiddleware"><tt class="xref py py-class docutils literal"><span class="pre">SSLRedirectMiddleware</span></tt></a>
と同じ処理を実装しますが、 <a class="reference internal" href="settings.html#setting-ssl-urls"><em>SSL_URLS</em></a> にURLを設定するのが不要に
なります。このビューがセキュアということが指定されているので、
<a class="reference internal" href="#beproud.django.ssl.middleware.SSLRedirectMiddleware" title="beproud.django.ssl.middleware.SSLRedirectMiddleware"><tt class="xref py py-class docutils literal"><span class="pre">SSLRedirectMiddleware</span></tt></a>
と眩みません。</p>
</div>
</div>
<div class="section" id="http">
<h2>2.3. HTTP リバースプロクシを利用する<a class="headerlink" href="#http" title="このヘッドラインへのパーマリンク">¶</a></h2>
<dl class="class">
<dt id="beproud.django.ssl.middleware.SSLProxyMiddleware">
<em class="property">class </em><tt class="descclassname">beproud.django.ssl.middleware.</tt><tt class="descname">SSLProxyMiddleware</tt><a class="headerlink" href="#beproud.django.ssl.middleware.SSLProxyMiddleware" title="この定義へのパーマリンク">¶</a></dt>
<dd></dd></dl>

<p><a class="reference internal" href="#beproud.django.ssl.middleware.SSLProxyMiddleware" title="beproud.django.ssl.middleware.SSLProxyMiddleware"><tt class="xref py py-class docutils literal"><span class="pre">SSLProxyMiddleware</span></tt></a>
はプロクシサーバーからセキュアリクエストが来た場合、 <a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/request-response/#django.http.HttpRequest.is_secure">request.is_secure()</a> が
<tt class="docutils literal"><span class="pre">True</span></tt> を返すようにリクエストオブジェクトを更新する。
<a class="reference internal" href="#beproud.django.ssl.middleware.SSLProxyMiddleware" title="beproud.django.ssl.middleware.SSLProxyMiddleware"><tt class="xref py py-class docutils literal"><span class="pre">SSLProxyMiddleware</span></tt></a> と
連動するためにリバースプロクシを設定すう方法は
<a class="reference internal" href="install.html#install-web-server-setup"><em>ウェブサーバー設定</em></a> にご参照ください。</p>
<p>あるリクエストがセキュアかどうかを指定するヘッダーの名前とセキュアの場合の値を
<a class="reference internal" href="settings.html#setting-ssl-request-header"><em>SSL_REQUEST_HEADER</em></a> で設定する必要があります。
デフォールトの値は以下に示します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">SSL_REQUEST_HEADER</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;HTTP_X_FORWARDED_PROTOCOL&#39;</span><span class="p">,</span> <span class="s">&#39;https&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#beproud.django.ssl.middleware.SSLProxyMiddleware" title="beproud.django.ssl.middleware.SSLProxyMiddleware"><tt class="xref py py-class docutils literal"><span class="pre">SSLProxyMiddleware</span></tt></a> は以下の
ように作動します:</p>
<ul class="simple">
<li><a class="reference internal" href="settings.html#setting-ssl-request-header"><em>SSL_REQUEST_HEADER</em></a> で設定されているヘッダーの
値がリバースプロクシから送られて来たリクエストヘッダーと一致すると、
<a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/request-response/#django.http.HttpRequest.is_secure">request.is_secure()</a> が正値を返すように設定します。</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">ノート</p>
<p class="last"><a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/request-response/#django.http.HttpRequest.is_secure">request.is_secure()</a> を使うミドルウエアがある可能性があるため、
<a class="reference internal" href="#beproud.django.ssl.middleware.SSLProxyMiddleware" title="beproud.django.ssl.middleware.SSLProxyMiddleware"><tt class="xref py py-class docutils literal"><span class="pre">SSLProxyMiddleware</span></tt></a> を
なるべく上のほうに <a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/settings/#middleware-classes">MIDDLEWARE_CLASSES</a> に設定すべきです。 少なくとも、
<a class="reference internal" href="#beproud.django.ssl.middleware.SSLRedirectMiddleware" title="beproud.django.ssl.middleware.SSLRedirectMiddleware"><tt class="xref py py-class docutils literal"><span class="pre">SSLRedirectMiddleware</span></tt></a>.
の上に設定する必要があります。</p>
</div>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="install.html">1. インストール</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">コンテンツ</a>
        &#160;&#160;::&#160;&#160;
        <a href="settings.html">3. <tt class="docutils literal docutils literal"><span class="pre">settings</span></tt> &#8211; bpssl 設定</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2010, 株式会社ビープラウド.
      このドキュメントは <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3 で生成しました。
    </div>
  </body>
</html>