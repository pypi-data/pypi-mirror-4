window.SETTINGS=new Settings();function Settings(b){self=this;if(typeof localStorage=="undefined"||typeof $.evalJSON=="undefined"){return{}}_unique_key=SETTINGS_UNIQUE_KEY;_server={};_local={tabs:[],};_values={server:_server,local:_local};_values_is_set=false;_responseServer=null;this.__defineGetter__("ready",function(){return _values_is_set});_callback=b;_run_callback=function(){if(_callback){_callback();if(!_callback.__not_reset_after__){_callback=b}}};this.callback=_callback;_last_set_server=null;this.last_set=_last_set_server;_last_get_server=null;this.last_get=_last_get_server;_init=function(c){if(c){_callback=c}_values_is_set=false;_local=$.evalJSON(localStorage.getItem(_unique_key))||_local;_get_server();return self};this.init=_init;this.reload=_init;_check_init=function(){if(!_values_is_set){_init()}return self};this.__defineGetter__("all",function(){_check_init();return _values});this.__defineGetter__("server",function(){_check_init();return _server});this.__defineGetter__("local",function(){_check_init();return _local});this.save=function(d,c){if(d){_callback=d}if(c!="local"){_set_server()}if(c!="server"){localStorage.setItem(_unique_key,$.toJSON(self.local))}_run_callback();return self};this.save_server=function(c){return self.save(c,"server")};this.save_local=function(c){return self.save(c,"local")};_set_server=function(){sync=false;_responseServer=null;args={method:"set_settings",settings:self.server};cb=function(d,c,e){if(!d.data){showAlert(d.message)}else{_last_set_server=new Date();_responseServer=d}};jqxhr=new jsonAPI(args,cb,"SETTINGS.set_server() call jsonAPI()",sync);return[_last_set_server,_responseServer,jqxhr]};_get_server=function(){sync=true;_responseServer=null;args={method:"get_settings"};cb=function(d,c,e){_server=d.data;_last_get_server=new Date();_responseServer=d;_values_is_set=true;_run_callback()};jqxhr=new jsonAPI(args,cb,"SETTINGS.get_server() call jsonAPI()",sync);return[_last_get_server,_responseServer,jqxhr]};this.cleanTabs=function(){_tabs=[];$.each(_local.tabs,function(c,d){if(d){_tabs.push(d)}});_local.tabs=_tabs;return self}}var delay=(function(){var b=0;return function(d,c){clearTimeout(b);b=setTimeout(d,c)}})();function hideAlert(){$(".alert").alert("close")}function showAlert(c,b,d){console.log(c);if(!b){b="alert-error"}html=Jinja.render($("#jinja-alert").html(),{msg:c,type:b});$("#alert-place").html(html);$(window).scrollTop(0);$(".alert").alert();if(d){delay(d,5000)}else{delay(hideAlert,5000)}return false}function jsonAPI(b,f,d,c){if(DEBUG){console.log($.toJSON(b))}if(!b){var b={method:"get_settings"}}if(!f){f=function(h,g,i){}}var e=$.ajax({type:"POST",async:!c,timeout:AJAX_TIMEOUT,url:BWP_API_URL,data:"jsonData="+$.toJSON(b),dataType:"json"}).fail(function(i,g,h){if(i.getResponseHeader("Location")){window.location=i.getResponseHeader("Location").replace(/\?.*$/,"?next="+window.location.pathname);console.log("1:"+i.getResponseHeader("Location"))}else{$("html").html(i.responseText)}}).done(function(h,g,i){if(d){if(DEBUG){console.log(d)}}if((h.status>=300)&&(h.status<400)&&(h.data.Location)){if(DEBUG){console.log("jsonAPI status: "+h.status+" message: "+h.message)}showAlert(h.message,"alert-error",function(){window.location.href=h.data.Location.replace(/\?.*$/,"?next="+window.location.pathname)})}else{if(h.status>=400){if(DEBUG){console.log("jsonAPI status: "+h.status+" message: "+h.message)}showAlert(h.message,"alert-error")}else{if(DEBUG){console.log(h.message)}return f(h,g,i)}}});return e}function initDataTables(c){table=$('table[data-model="'+c.model+'"]');template=$("#jinja-datatables-column-pk").html();var b=table.dataTable({oLanguage:{sUrl:"static/js/dataTables/1.9.4/"+c.oLanguage+".txt"},bProcessing:c.bProcessing,bServerSide:c.bServerSide,sAjaxSource:c.sAjaxSource,sServerMethod:c.sServerMethod,fnServerParams:function(d){$.each(c.fnServerParams,function(e,f){d.push({name:f[0],value:f[1]})})},fnRowCallback:function(f,e,d){$(f).bind("click",function(){$(b).find("tbody tr.info").removeClass("info");if(DEBUG){console.log("click")}$(f).addClass("info")})},fnCreatedRow:function(f,e,d){html=Jinja.render(template,{data:c,aData:e});$("td:eq(0)",f).html(html).find("a").click(addTab)},aoColumnDefs:c.aoColumnDefs,sPaginationType:"bootstrap",sDom:c.sDom||"lfrtip",bLengthChange:c.bLengthChange||true,bStateSave:c.bStateSave||true,});return false}function dblClickRow(b,c){console.log(b);console.log(c)}function fnShowHide(d,c){table=$('table[data-model="'+d+'"]');var b=table.dataTable();var e=b.fnSettings().aoColumns[c].bVisible;b.fnSetColumnVis(c,e?false:true);return false}function addTab(){data=$(this).data();tab_id=data.tabId;if(data.object){$(this).addClass("muted")}tab=$("#main-tab #tab-"+tab_id);if(tab.length>0){tab.find("a").tab("show")}else{html=Jinja.render($("#jinja-tab-default-content").html(),{data:data});$("#main-tab-content").append(html);html=Jinja.render($("#jinja-tab").html(),{data:data});$("#main-tab").append(html);delay(function(){a=$("#main-tab a:last").tab("show");contentLoader(a[0])},200);$("#main-tab li button.close").unbind("click").click(function(){close_tab_id=$(this).attr("data-close");$("#tab-"+close_tab_id).remove();$("#tab-content-"+close_tab_id).remove();num=$.inArray(close_tab_id,SETTINGS.local.tabs);if(num>-1){delete SETTINGS.local.tabs[num];SETTINGS.cleanTabs().save_local()}});if($.inArray(tab_id,SETTINGS.local.tabs)<0){SETTINGS.local.tabs.push(tab_id);SETTINGS.save_local()}a=$("#tab-"+tab_id+" a").one("click",function(){contentLoader(this)})}return true}function contentLoader(b){$obj=$(b);model=$obj.attr("data-model");func=$obj.attr("data-func");object=$obj.attr("data-object");if(object){args={method:"object_action",model:model,key:"get",pk:object};callback=function(d,c,f){var e=d.data;createObjectContent(e)};jqxhr=new jsonAPI(args,callback,'contentLoader(obj) "if (object)" call jsonAPI()')}else{if(model){jqxhr=new $.getJSON(BWP_DATATABLES_URL,{model:model,info:true},function(d,c){$("#tab-content-"+d.html_id).html(d.html);initDataTables(d)})}else{if(func){if(DEBUG){console.log("Type is func")}}}}$obj.unbind("click");return jqxhr}function restoreSession(){$.each(SETTINGS.local.tabs,function(b,c){$("[data-tab-id="+c+"]").click()})}function createObjectContent(b){html=Jinja.render($("#jinja-object-tab-content").html(),{data:b});$("#tab-content-"+b.html_id).html(html)}function resetObject(){console.log("resetObject()");$self=$(this);model=$self.attr("data-model");object=$self.attr("data-object");html_id=$self.attr("data-html-id");tab=$("#tab-content-"+html_id+"_object");form=$("#form-"+html_id+"_object")}function saveObject(b){$self=$(this);model=$self.attr("data-model");object=$self.attr("data-object");html_id=$self.attr("data-html-id");tab=$("#tab-content-"+html_id+"_object");form=$("#form-"+html_id+"_object");if(object){args={method:"object_action",model:model,key:"upd",pk:object,ARRAY_FORM_OBJECT_KEY:form.serializeArray(),};callback=function(d,c,f){var e=d.data;createObjectContent(e)};jqxhr=new jsonAPI(args,callback,'saveObject() "if (object)" call jsonAPI()')}}function submitFormObject(){$(this).find("button[data-action=save]:enabled").click()}function resetCompose(){console.log("resetCompose()")}function saveCompose(){$self=$(this);model=$self.attr("data-model");object=$self.attr("data-object");html_id=$self.attr("data-html-id");tab=$("#tab-content-"+html_id+"_object");form=$("#form-"+html_id+"**************COMPOSE*********")}$(document).ready(function(b){b("alert").alert();if(SETTINGS.init().ready){b(".dropdown-toggle").dropdown();var c=window.location.pathname;if(c!="/"){b('div.navbar a[href^="'+c+'"]').parents("li").addClass("active")}else{b('div.navbar a[href="/"]').parents("li").addClass("active")}b("#search").focus();b("#menu-app li[class!=disabled] a[data-tab-id]").click(addTab);restoreSession();b("body").on("click","button[data-action=reset-object]:enabled",resetObject);b("body").on("click","button[data-action=save-object]:enabled",saveObject);b("body").on("submit","form[id$=_object]",submitFormObject)}});