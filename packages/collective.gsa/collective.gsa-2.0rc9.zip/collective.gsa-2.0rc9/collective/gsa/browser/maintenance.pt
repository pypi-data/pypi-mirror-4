<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      xml:lang="en" lang="en"
      metal:use-macro="context/prefs_main_template/macros/master"
      i18n:domain="collective.gsa">

<body>

<div metal:fill-slot="prefs_configlet_main"
    tal:define="plone_portal_state context/@@plone_portal_state;">

    <div metal:define-macro="form">

        <div id="viewspace" metal:define-slot="viewspace">

            <metal:block define-macro="header">
                <div metal:use-macro="context/global_statusmessage/macros/portal_message">
                    Portal status message
                </div>
            </metal:block>

            <h1 class="documentFirstHeading"
                i18n:translate="heading_maintenance_tool"
                metal:define-slot="heading">
                GSA Maintenance Tool
            </h1>

            <a href=""
               class="link-parent"
               tal:attributes="href string: $portal_url/plone_control_panel"
               i18n:translate="label_up_to_plone_setup">
                Up to Site Setup
            </a>

            <p i18n:translate="description_gsa_maintenance">
                This view contains GSA related maintenance tools.
            </p>

            <fieldset>
                <legend i18n:translate="heading_gsa_reindex">
                    GSA Reindex
                </legend>
                
                <p i18n:translate="help_gsa_reindex" class="discreet">
                    This tool reindexes all objects and sends feeds to the GSA. This may take a very long time.
                </p>
                
                <dl class="portalMessage">
                    <dt class="info">Info</dt>
                    <dd>
                        Already reindexed objects: <span tal:omit-tag='' tal:content="view/progress"/> out of <span tal:omit-tag='' tal:content="view/count"/>
                    </dd>
                </dl>
                
                <form action="."
                    method="POST"
                    tal:attributes="action request/URL">
                    <div class="field">
                        <label>Enter the batch size limit for indexing</label>
                        <input type="text" value="10000" name="batch_size" tal:attributes="value request/batch_size|string:10000" />
                    </div>
                    <div>
                        <p i18n:translate="help_gsa_batch" class="formHelp">
                            The indexing runs in batches. After each run, the number of already reindexed objects should increase
                            by the batch size. If it stays the same, the MemoryError may have occured depending on the objects size.
                            If this happens, please change the batch size to a lower number. Note that the browser or proxy may timeout so 
                            you can check the error log, if everything is ok.
                        </p>
                        <p i18n:translate="help_gsa_batch2" class="formHelp">
                            If you want to start again from the beginning, click on the 'Start over' button.
                        </p>
                        
                        <input type="submit" class="context" value="Reindex next batch" name="collective.gsa.reindex"/>
                        <input type="submit" class="context" value="Start over" name="collective.gsa.startover"/>
                    </div>
                </form>
                
            </fieldset>
            
        </div>

        <script type="text/javascript"
            tal:define="extra_script view/extra_script | nothing"
            tal:condition="extra_script"
            tal:content="structure extra_script">
        </script>

    </div>

</div>
</body>
</html>
